function A(r){return(e,...t)=>ut(r,e,t)}function G(r,e){return A(Ge(r,e).get)}const{apply:ut,getOwnPropertyDescriptor:Ge,getPrototypeOf:ye,ownKeys:dt}=Reflect,{iterator:j,toStringTag:gt}=Symbol,yt=Object,{create:pe,defineProperty:pt}=yt,xt=Array,wt=xt.prototype,Ne=wt[j],mt=A(Ne),Le=ArrayBuffer,bt=Le.prototype;G(bt,"byteLength");const Oe=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;Oe&&G(Oe.prototype,"byteLength");const ve=ye(Uint8Array);ve.from;const D=ve.prototype;D[j];A(D.keys);A(D.values);A(D.entries);A(D.set);A(D.reverse);A(D.fill);A(D.copyWithin);A(D.sort);A(D.slice);A(D.subarray);G(D,"buffer");G(D,"byteOffset");G(D,"length");G(D,gt);const It=Uint8Array,ze=Uint16Array,xe=Uint32Array,St=Float32Array,q=ye([][j]()),Ve=A(q.next),Tt=A(function*(){}().next),At=ye(q),Et=DataView.prototype,Dt=A(Et.getUint16),we=WeakMap,Ke=we.prototype,qe=A(Ke.get),Mt=A(Ke.set),je=new we,Ot=pe(null,{next:{value:function(){const e=qe(je,this);return Ve(e)}},[j]:{value:function(){return this}}});function kt(r){if(r[j]===Ne&&q.next===Ve)return r;const e=pe(Ot);return Mt(je,e,mt(r)),e}const Ct=new we,_t=pe(At,{next:{value:function(){const e=qe(Ct,this);return Tt(e)},writable:!0,configurable:!0}});for(const r of dt(q))r!=="next"&&pt(_t,r,Ge(q,r));const Ye=new Le(4),Bt=new St(Ye),Rt=new xe(Ye),O=new ze(512),k=new It(512);for(let r=0;r<256;++r){const e=r-127;e<-24?(O[r]=0,O[r|256]=32768,k[r]=24,k[r|256]=24):e<-14?(O[r]=1024>>-e-14,O[r|256]=1024>>-e-14|32768,k[r]=-e-1,k[r|256]=-e-1):e<=15?(O[r]=e+15<<10,O[r|256]=e+15<<10|32768,k[r]=13,k[r|256]=13):e<128?(O[r]=31744,O[r|256]=64512,k[r]=24,k[r|256]=24):(O[r]=31744,O[r|256]=64512,k[r]=13,k[r|256]=13)}const me=new xe(2048);for(let r=1;r<1024;++r){let e=r<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,me[r]=e|t}for(let r=1024;r<2048;++r)me[r]=939524096+(r-1024<<13);const N=new xe(64);for(let r=1;r<31;++r)N[r]=r<<23;N[31]=1199570944;N[32]=2147483648;for(let r=33;r<63;++r)N[r]=2147483648+(r-32<<23);N[63]=3347054592;const He=new ze(64);for(let r=1;r<64;++r)r!==32&&(He[r]=1024);function Ft(r){const e=r>>10;return Rt[0]=me[He[e]+(r&1023)]+N[e],Bt[0]}function $e(r,e,...t){return Ft(Dt(r,e,...kt(t)))}function Xe(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Z={exports:{}},ke;function Pt(){if(ke)return Z.exports;ke=1;function r(e,t,s){const n=s&&s.debug||!1;n&&console.log("[xml-utils] getting "+t+" in "+e);const i=typeof e=="object"?e.outer:e,o=i.slice(0,i.indexOf(">")+1),a=['"',"'"];for(let l=0;l<a.length;l++){const c=a[l],f=t+"\\="+c+"([^"+c+"]*)"+c;n&&console.log("[xml-utils] pattern:",f);const u=new RegExp(f).exec(o);if(n&&console.log("[xml-utils] match:",u),u)return u[1]}}return Z.exports=r,Z.exports.default=r,Z.exports}var Ut=Pt(),oe=Xe(Ut),J={exports:{}},Q={exports:{}},W={exports:{}},Ce;function Gt(){if(Ce)return W.exports;Ce=1;function r(e,t,s){const i=new RegExp(t).exec(e.slice(s));return i?s+i.index:-1}return W.exports=r,W.exports.default=r,W.exports}var ee={exports:{}},_e;function Nt(){if(_e)return ee.exports;_e=1;function r(e,t,s){const i=new RegExp(t).exec(e.slice(s));return i?s+i.index+i[0].length-1:-1}return ee.exports=r,ee.exports.default=r,ee.exports}var te={exports:{}},Be;function Lt(){if(Be)return te.exports;Be=1;function r(e,t){const s=new RegExp(t,"g"),n=e.match(s);return n?n.length:0}return te.exports=r,te.exports.default=r,te.exports}var Re;function vt(){if(Re)return Q.exports;Re=1;const r=Gt(),e=Nt(),t=Lt();function s(n,i,o){const a=o&&o.debug||!1,l=!(o&&typeof o.nested===!1),c=o&&o.startIndex||0;a&&console.log("[xml-utils] starting findTagByName with",i," and ",o);const f=r(n,`<${i}[ 
>/]`,c);if(a&&console.log("[xml-utils] start:",f),f===-1)return;const h=n.slice(f+i.length);let u=e(h,"^[^<]*[ /]>",0);const d=u!==-1&&h[u-1]==="/";if(a&&console.log("[xml-utils] selfClosing:",d),d===!1)if(l){let m=0,x=1,I=0;for(;(u=e(h,"[ /]"+i+">",m))!==-1;){const b=h.substring(m,u+1);if(x+=t(b,"<"+i+`[ 
	>]`),I+=t(b,"</"+i+">"),I>=x)break;m=u}}else u=e(h,"[ /]"+i+">",0);const g=f+i.length+u+1;if(a&&console.log("[xml-utils] end:",g),g===-1)return;const p=n.slice(f,g);let y;return d?y=null:y=p.slice(p.indexOf(">")+1,p.lastIndexOf("<")),{inner:y,outer:p,start:f,end:g}}return Q.exports=s,Q.exports.default=s,Q.exports}var Fe;function zt(){if(Fe)return J.exports;Fe=1;const r=vt();function e(t,s,n){const i=[],o=n&&n.debug||!1,a=n&&typeof n.nested=="boolean"?n.nested:!0;let l=n&&n.startIndex||0,c;for(;c=r(t,s,{debug:o,startIndex:l});)a?l=c.start+1+s.length:l=c.end,i.push(c);return o&&console.log("findTagsByName found",i.length,"tags"),i}return J.exports=e,J.exports.default=e,J.exports}var Vt=zt(),Kt=Xe(Vt);const K={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},C={};for(const r in K)K.hasOwnProperty(r)&&(C[K[r]]=parseInt(r,10));const qt=[C.BitsPerSample,C.ExtraSamples,C.SampleFormat,C.StripByteCounts,C.StripOffsets,C.StripRowCounts,C.TileByteCounts,C.TileOffsets,C.SubIFDs],ae={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},w={};for(const r in ae)ae.hasOwnProperty(r)&&(w[ae[r]]=parseInt(r,10));const M={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8},jt={Unspecified:0},Xr={AddCompression:1},Zr={None:0,Deflate:1,Zstandard:2},Yt={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function Ht(r,e){const{width:t,height:s}=r,n=new Uint8Array(t*s*3);let i;for(let o=0,a=0;o<r.length;++o,a+=3)i=256-r[o]/e*256,n[a]=i,n[a+1]=i,n[a+2]=i;return n}function $t(r,e){const{width:t,height:s}=r,n=new Uint8Array(t*s*3);let i;for(let o=0,a=0;o<r.length;++o,a+=3)i=r[o]/e*256,n[a]=i,n[a+1]=i,n[a+2]=i;return n}function Xt(r,e){const{width:t,height:s}=r,n=new Uint8Array(t*s*3),i=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<r.length;++a,l+=3){const c=r[a];n[l]=e[c]/65536*256,n[l+1]=e[c+i]/65536*256,n[l+2]=e[c+o]/65536*256}return n}function Zt(r){const{width:e,height:t}=r,s=new Uint8Array(e*t*3);for(let n=0,i=0;n<r.length;n+=4,i+=3){const o=r[n],a=r[n+1],l=r[n+2],c=r[n+3];s[i]=255*((255-o)/256)*((255-c)/256),s[i+1]=255*((255-a)/256)*((255-c)/256),s[i+2]=255*((255-l)/256)*((255-c)/256)}return s}function Jt(r){const{width:e,height:t}=r,s=new Uint8ClampedArray(e*t*3);for(let n=0,i=0;n<r.length;n+=3,i+=3){const o=r[n],a=r[n+1],l=r[n+2];s[i]=o+1.402*(l-128),s[i+1]=o-.34414*(a-128)-.71414*(l-128),s[i+2]=o+1.772*(a-128)}return s}const Qt=.95047,Wt=1,er=1.08883;function tr(r){const{width:e,height:t}=r,s=new Uint8Array(e*t*3);for(let n=0,i=0;n<r.length;n+=3,i+=3){const o=r[n+0],a=r[n+1]<<24>>24,l=r[n+2]<<24>>24;let c=(o+16)/116,f=a/500+c,h=c-l/200,u,d,g;f=Qt*(f*f*f>.008856?f*f*f:(f-16/116)/7.787),c=Wt*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),h=er*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),u=f*3.2406+c*-1.5372+h*-.4986,d=f*-.9689+c*1.8758+h*.0415,g=f*.0557+c*-.204+h*1.057,u=u>.0031308?1.055*u**(1/2.4)-.055:12.92*u,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,s[i]=Math.max(0,Math.min(1,u))*255,s[i+1]=Math.max(0,Math.min(1,d))*255,s[i+2]=Math.max(0,Math.min(1,g))*255}return s}const Ze=new Map;function B(r,e){Array.isArray(r)||(r=[r]),r.forEach(t=>Ze.set(t,e))}async function rr(r){const e=Ze.get(r.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${r.Compression}`);const t=await e();return new t(r)}B([void 0,1],()=>import("./raw-in9isEBO.js").then(r=>r.default));B(5,()=>import("./lzw-_aCqfs4w.js").then(r=>r.default));B(6,()=>{throw new Error("old style JPEG compression is not supported.")});B(7,()=>import("./jpeg-JhJy4lL1.js").then(r=>r.default));B([8,32946],()=>import("./deflate-Dthki0TA.js").then(r=>r.default));B(32773,()=>import("./packbits-DDWKfGV_.js").then(r=>r.default));B(34887,()=>import("./lerc-B1nhV84a.js").then(async r=>(await r.zstd.init(),r)).then(r=>r.default));B(50001,()=>import("./webimage-DBgUwIbt.js").then(r=>r.default));function se(r,e,t,s=1){return new(Object.getPrototypeOf(r)).constructor(e*t*s)}function sr(r,e,t,s,n){const i=e/s,o=t/n;return r.map(a=>{const l=se(a,s,n);for(let c=0;c<n;++c){const f=Math.min(Math.round(o*c),t-1);for(let h=0;h<s;++h){const u=Math.min(Math.round(i*h),e-1),d=a[f*e+u];l[c*s+h]=d}}return l})}function P(r,e,t){return(1-t)*r+t*e}function nr(r,e,t,s,n){const i=e/s,o=t/n;return r.map(a=>{const l=se(a,s,n);for(let c=0;c<n;++c){const f=o*c,h=Math.floor(f),u=Math.min(Math.ceil(f),t-1);for(let d=0;d<s;++d){const g=i*d,p=g%1,y=Math.floor(g),m=Math.min(Math.ceil(g),e-1),x=a[h*e+y],I=a[h*e+m],b=a[u*e+y],S=a[u*e+m],E=P(P(x,I,p),P(b,S,p),f%1);l[c*s+d]=E}}return l})}function ir(r,e,t,s,n,i="nearest"){switch(i.toLowerCase()){case"nearest":return sr(r,e,t,s,n);case"bilinear":case"linear":return nr(r,e,t,s,n);default:throw new Error(`Unsupported resampling method: '${i}'`)}}function or(r,e,t,s,n,i){const o=e/s,a=t/n,l=se(r,s,n,i);for(let c=0;c<n;++c){const f=Math.min(Math.round(a*c),t-1);for(let h=0;h<s;++h){const u=Math.min(Math.round(o*h),e-1);for(let d=0;d<i;++d){const g=r[f*e*i+u*i+d];l[c*s*i+h*i+d]=g}}}return l}function ar(r,e,t,s,n,i){const o=e/s,a=t/n,l=se(r,s,n,i);for(let c=0;c<n;++c){const f=a*c,h=Math.floor(f),u=Math.min(Math.ceil(f),t-1);for(let d=0;d<s;++d){const g=o*d,p=g%1,y=Math.floor(g),m=Math.min(Math.ceil(g),e-1);for(let x=0;x<i;++x){const I=r[h*e*i+y*i+x],b=r[h*e*i+m*i+x],S=r[u*e*i+y*i+x],E=r[u*e*i+m*i+x],_=P(P(I,b,p),P(S,E,p),f%1);l[c*s*i+d*i+x]=_}}}return l}function cr(r,e,t,s,n,i,o="nearest"){switch(o.toLowerCase()){case"nearest":return or(r,e,t,s,n,i);case"bilinear":case"linear":return ar(r,e,t,s,n,i);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function lr(r,e,t){let s=0;for(let n=e;n<t;++n)s+=r[n];return s}function le(r,e,t){switch(r){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function fr(r,e){return(r===1||r===2)&&e<=32&&e%8===0?!1:!(r===3&&(e===16||e===32||e===64))}function hr(r,e,t,s,n,i,o){const a=new DataView(r),l=t===2?o*i:o*i*s,c=t===2?1:s,f=le(e,n,l),h=parseInt("1".repeat(n),2);if(e===1){let u;t===1?u=s*n:u=n;let d=i*u;d&7&&(d=d+7&-8);for(let g=0;g<o;++g){const p=g*d;for(let y=0;y<i;++y){const m=p+y*c*n;for(let x=0;x<c;++x){const I=m+x*n,b=(g*i+y)*c+x,S=Math.floor(I/8),E=I%8;if(E+n<=8)f[b]=a.getUint8(S)>>8-n-E&h;else if(E+n<=16)f[b]=a.getUint16(S)>>16-n-E&h;else if(E+n<=24){const _=a.getUint16(S)<<8|a.getUint8(S+2);f[b]=_>>24-n-E&h}else f[b]=a.getUint32(S)>>32-n-E&h}}}}return f.buffer}class ur{constructor(e,t,s,n,i,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=s,this.littleEndian=n,this.tiles=i?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,s=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(s<=8)return DataView.prototype.getUint8;if(s<=16)return DataView.prototype.getUint16;if(s<=32)return DataView.prototype.getUint32;break;case 2:if(s<=8)return DataView.prototype.getInt8;if(s<=16)return DataView.prototype.getInt16;if(s<=32)return DataView.prototype.getInt32;break;case 3:switch(s){case 16:return function(n,i){return $e(this,n,i)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const s=this.getSampleFormat(e),n=this.getBitsPerSample(e);return le(s,n,t)}async getTileOrStrip(e,t,s,n,i){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:c}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=s*o*a+t*o+e);let f,h;this.isTiled?(f=this.fileDirectory.TileOffsets[l],h=this.fileDirectory.TileByteCounts[l]):(f=this.fileDirectory.StripOffsets[l],h=this.fileDirectory.StripByteCounts[l]);const u=(await this.source.fetch([{offset:f,length:h}],i))[0];let d;return c===null||!c[l]?(d=(async()=>{let g=await n.decode(this.fileDirectory,u);const p=this.getSampleFormat(),y=this.getBitsPerSample();return fr(p,y)&&(g=hr(g,p,this.planarConfiguration,this.getSamplesPerPixel(),y,this.getTileWidth(),this.getBlockHeight(t))),g})(),c!==null&&(c[l]=d)):d=c[l],{x:e,y:t,sample:s,data:await d}}async _readRaster(e,t,s,n,i,o,a,l,c){const f=this.getTileWidth(),h=this.getTileHeight(),u=this.getWidth(),d=this.getHeight(),g=Math.max(Math.floor(e[0]/f),0),p=Math.min(Math.ceil(e[2]/f),Math.ceil(u/f)),y=Math.max(Math.floor(e[1]/h),0),m=Math.min(Math.ceil(e[3]/h),Math.ceil(d/h)),x=e[2]-e[0];let I=this.getBytesPerPixel();const b=[],S=[];for(let T=0;T<t.length;++T)this.planarConfiguration===1?b.push(lr(this.fileDirectory.BitsPerSample,0,t[T])/8):b.push(0),S.push(this.getReaderForSample(t[T]));const E=[],{littleEndian:_}=this;for(let T=y;T<m;++T)for(let R=g;R<p;++R){let ne;this.planarConfiguration===1&&(ne=this.getTileOrStrip(R,T,0,i,c));for(let Y=0;Y<t.length;++Y){const H=Y,De=t[Y];this.planarConfiguration===2&&(I=this.getSampleByteSize(De),ne=this.getTileOrStrip(R,T,De,i,c));const st=ne.then(L=>{const nt=L.data,it=new DataView(nt),ie=this.getBlockHeight(L.y),v=L.y*h,$=L.x*f,ot=v+ie,at=(L.x+1)*f,ct=S[H],lt=Math.min(ie,ie-(ot-e[3]),d-v),ft=Math.min(f,f-(at-e[2]),u-$);for(let z=Math.max(0,e[1]-v);z<lt;++z)for(let V=Math.max(0,e[0]-$);V<ft;++V){const ht=(z*f+V)*I,Me=ct.call(it,ht+b[H],_);let X;n?(X=(z+v-e[1])*x*t.length+(V+$-e[0])*t.length+H,s[X]=Me):(X=(z+v-e[1])*x+V+$-e[0],s[H][X]=Me)}});E.push(st)}}if(await Promise.all(E),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let T;return n?T=cr(s,e[2]-e[0],e[3]-e[1],o,a,t.length,l):T=ir(s,e[2]-e[0],e[3]-e[1],o,a,l),T.width=o,T.height=a,T}return s.width=o||e[2]-e[0],s.height=a||e[3]-e[1],s}async readRasters({window:e,samples:t=[],interleave:s,pool:n=null,width:i,height:o,resampleMethod:a,fillValue:l,signal:c}={}){const f=e||[0,0,this.getWidth(),this.getHeight()];if(f[0]>f[2]||f[1]>f[3])throw new Error("Invalid subsets");const h=f[2]-f[0],u=f[3]-f[1],d=h*u,g=this.getSamplesPerPixel();if(!t||!t.length)for(let x=0;x<g;++x)t.push(x);else for(let x=0;x<t.length;++x)if(t[x]>=g)return Promise.reject(new RangeError(`Invalid sample index '${t[x]}'.`));let p;if(s){const x=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,I=Math.max.apply(null,this.fileDirectory.BitsPerSample);p=le(x,I,d*t.length),l&&p.fill(l)}else{p=[];for(let x=0;x<t.length;++x){const I=this.getArrayForSample(t[x],d);Array.isArray(l)&&x<l.length?I.fill(l[x]):l&&!Array.isArray(l)&&I.fill(l),p.push(I)}}const y=n||await rr(this.fileDirectory);return await this._readRaster(f,t,p,s,y,i,o,a,c)}async readRGB({window:e,interleave:t=!0,pool:s=null,width:n,height:i,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const c=e||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const f=this.fileDirectory.PhotometricInterpretation;if(f===M.RGB){let m=[0,1,2];if(this.fileDirectory.ExtraSamples!==jt.Unspecified&&a){m=[];for(let x=0;x<this.fileDirectory.BitsPerSample.length;x+=1)m.push(x)}return this.readRasters({window:e,interleave:t,samples:m,pool:s,width:n,height:i,resampleMethod:o,signal:l})}let h;switch(f){case M.WhiteIsZero:case M.BlackIsZero:case M.Palette:h=[0];break;case M.CMYK:h=[0,1,2,3];break;case M.YCbCr:case M.CIELab:h=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const u={window:c,interleave:!0,samples:h,pool:s,width:n,height:i,resampleMethod:o,signal:l},{fileDirectory:d}=this,g=await this.readRasters(u),p=2**this.fileDirectory.BitsPerSample[0];let y;switch(f){case M.WhiteIsZero:y=Ht(g,p);break;case M.BlackIsZero:y=$t(g,p);break;case M.Palette:y=Xt(g,d.ColorMap);break;case M.CMYK:y=Zt(g);break;case M.YCbCr:y=Jt(g);break;case M.CIELab:y=tr(g);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const m=new Uint8Array(y.length/3),x=new Uint8Array(y.length/3),I=new Uint8Array(y.length/3);for(let b=0,S=0;b<y.length;b+=3,++S)m[S]=y[b],x[S]=y[b+1],I[S]=y[b+2];y=[m,x,I]}return y.width=g.width,y.height=g.height,y}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const s=this.fileDirectory.GDAL_METADATA;let n=Kt(s,"Item");e===null?n=n.filter(i=>oe(i,"sample")===void 0):n=n.filter(i=>Number(oe(i,"sample"))===e);for(let i=0;i<n.length;++i){const o=n[i];t[oe(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,s=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(s)return s[1]===0&&s[4]===0?[s[0],-s[5],s[10]]:[Math.sqrt(s[0]*s[0]+s[4]*s[4]),-Math.sqrt(s[1]*s[1]+s[5]*s[5]),s[10]];if(e){const[n,i,o]=e.getResolution();return[n*e.getWidth()/this.getWidth(),i*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),s=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[n,i,o,a,l,c,f,h]=this.fileDirectory.ModelTransformation,d=[[0,0],[0,t],[s,0],[s,t]].map(([y,m])=>[a+n*y+i*m,h+l*y+c*m]),g=d.map(y=>y[0]),p=d.map(y=>y[1]);return[Math.min(...g),Math.min(...p),Math.max(...g),Math.max(...p)]}else{const n=this.getOrigin(),i=this.getResolution(),o=n[0],a=n[1],l=o+i[0]*s,c=a+i[1]*t;return[Math.min(o,l),Math.min(a,c),Math.max(o,l),Math.max(a,c)]}}}class dr{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const s=this.getUint32(e,t),n=this.getUint32(e+4,t);let i;if(t){if(i=s+2**32*n,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}if(i=2**32*s+n,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}getInt64(e,t){let s=0;const n=(this._dataView.getUint8(e+(t?7:0))&128)>0;let i=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));n&&(i?a!==0&&(a=~(a-1)&255,i=!1):a=~a&255),s+=a*256**o}return n&&(s=-s),s}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return $e(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class gr{constructor(e,t,s,n){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=s,this._bigTiff=n}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),s=this.readUint32(e+4);let n;if(this._littleEndian){if(n=t+2**32*s,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*t+s,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}readInt64(e){let t=0;const s=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let n=!0;for(let i=0;i<8;i++){let o=this._dataView.getUint8(e+(this._littleEndian?i:7-i));s&&(n?o!==0&&(o=~(o-1)&255,n=!1):o=~o&255),t+=o*256**i}return s&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const Pe=`\r
\r
`;function Je(r){if(typeof Object.fromEntries<"u")return Object.fromEntries(r);const e={};for(const[t,s]of r)e[t.toLowerCase()]=s;return e}function yr(r){const e=r.split(`\r
`).map(t=>{const s=t.split(":").map(n=>n.trim());return s[0]=s[0].toLowerCase(),s});return Je(e)}function pr(r){const[e,...t]=r.split(";").map(n=>n.trim()),s=t.map(n=>n.split("="));return{type:e,params:Je(s)}}function fe(r){let e,t,s;return r&&([,e,t,s]=r.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),s=parseInt(s,10)),{start:e,end:t,total:s}}function xr(r,e){let t=null;const s=new TextDecoder("ascii"),n=[],i=`--${e}`,o=`${i}--`;for(let a=0;a<10;++a)s.decode(new Uint8Array(r,a,i.length))===i&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<r.byteLength;){const a=s.decode(new Uint8Array(r,t,Math.min(i.length+1024,r.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(i))throw new Error("Part does not start with boundary");const l=a.substr(i.length+2);if(l.length===0)break;const c=l.indexOf(Pe),f=yr(l.substr(0,c)),{start:h,end:u,total:d}=fe(f["content-range"]),g=t+i.length+c+Pe.length,p=parseInt(u,10)+1-parseInt(h,10);n.push({headers:f,data:r.slice(g,g+p),offset:h,length:p,fileSize:d}),t=g+p+4}return n}class Qe{async fetch(e,t=void 0){return Promise.all(e.map(s=>this.fetchSlice(s,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class wr extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,s]of e)this.onEviction(t,s.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const s=t.get(e);return this._getItemValue(e,s)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,s]=e;this.cache.has(t)||this._deleteIfExpired(t,s)===!1&&(yield e)}for(const e of this.cache){const[t,s]=e;this._deleteIfExpired(t,s)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:s=this.maxAge}={}){const n=typeof s=="number"&&s!==Number.POSITIVE_INFINITY?Date.now()+s:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:n}):this._set(e,{value:t,expiry:n}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],s=t.length-e;s<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(s>0&&this._emitEvictions(t.slice(0,s)),this.oldCache=new Map(t.slice(s)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,s]=e;this._deleteIfExpired(t,s)===!1&&(yield[t,s.value])}for(const e of this.oldCache){const[t,s]=e;this.cache.has(t)||this._deleteIfExpired(t,s)===!1&&(yield[t,s.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const s=e[t],[n,i]=s;this._deleteIfExpired(n,i)===!1&&(yield[n,i.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const s=e[t],[n,i]=s;this.cache.has(n)||this._deleteIfExpired(n,i)===!1&&(yield[n,i.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[s,n]of this.entriesAscending())e.call(t,n,s,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function mr(r){return new Promise(e=>setTimeout(e,r))}function br(r,e){const t=Array.isArray(r)?r:Array.from(r),s=Array.isArray(e)?e:Array.from(e);return t.map((n,i)=>[n,s[i]])}class U extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,U),this.name="AbortError"}}class Ir extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const Sr=Ir;class Tr{constructor(e,t,s=null){this.offset=e,this.length=t,this.data=s}get top(){return this.offset+this.length}}class Ue{constructor(e,t,s){this.offset=e,this.length=t,this.blockIds=s}}class Ar extends Qe{constructor(e,{blockSize:t=65536,cacheSize:s=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new wr({maxSize:s,onEviction:(n,i)=>{this.evictedBlocks.set(n,i)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const s=[],n=[],i=[];this.evictedBlocks.clear();for(const{offset:u,length:d}of e){let g=u+d;const{fileSize:p}=this;p!==null&&(g=Math.min(g,p));const y=Math.floor(u/this.blockSize)*this.blockSize;for(let m=y;m<g;m+=this.blockSize){const x=Math.floor(m/this.blockSize);!this.blockCache.has(x)&&!this.blockRequests.has(x)&&(this.blockIdsToFetch.add(x),n.push(x)),this.blockRequests.has(x)&&s.push(this.blockRequests.get(x)),i.push(x)}}await mr(),this.fetchBlocks(t);const o=[];for(const u of n)this.blockRequests.has(u)&&o.push(this.blockRequests.get(u));await Promise.allSettled(s),await Promise.allSettled(o);const a=[],l=i.filter(u=>this.abortedBlockIds.has(u)||!this.blockCache.has(u));if(l.forEach(u=>this.blockIdsToFetch.add(u)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const u of l){const d=this.blockRequests.get(u);if(!d)throw new Error(`Block ${u} is not in the block requests`);a.push(d)}await Promise.allSettled(a)}if(t&&t.aborted)throw new U("Request was aborted");const c=i.map(u=>this.blockCache.get(u)||this.evictedBlocks.get(u)),f=c.filter(u=>!u);if(f.length)throw new Sr(f,"Request failed");const h=new Map(br(i,c));return this.readSliceData(e,h)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),s=this.source.fetch(t,e);for(let n=0;n<t.length;++n){const i=t[n];for(const o of i.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await s)[n],l=o*this.blockSize,c=l-a.offset,f=Math.min(c+this.blockSize,a.data.byteLength),h=a.data.slice(c,f),u=new Tr(l,h.byteLength,h,o);this.blockCache.set(o,u),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let s=[],n=null;const i=[];for(const o of t)n===null||n+1===o?(s.push(o),n=o):(i.push(new Ue(s[0]*this.blockSize,s.length*this.blockSize,s)),s=[o],n=o);return i.push(new Ue(s[0]*this.blockSize,s.length*this.blockSize,s)),i}readSliceData(e,t){return e.map(s=>{let n=s.offset+s.length;this.fileSize!==null&&(n=Math.min(this.fileSize,n));const i=Math.floor(s.offset/this.blockSize),o=Math.floor(n/this.blockSize),a=new ArrayBuffer(s.length),l=new Uint8Array(a);for(let c=i;c<=o;++c){const f=t.get(c),h=f.offset-s.offset,u=f.top-n;let d=0,g=0,p;h<0?d=-h:h>0&&(g=h),u<0?p=f.length-d:p=n-f.offset-d;const y=new Uint8Array(f.data,d,p);l.set(y,g)}return a})}}class be{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class Ie{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class Er extends be{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class Dr extends Ie{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const s=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new Er(s)}}class Mr extends be{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class Or extends Ie{constructRequest(e,t){return new Promise((s,n)=>{const i=new XMLHttpRequest;i.open("GET",this.url),i.responseType="arraybuffer";for(const[o,a]of Object.entries(e))i.setRequestHeader(o,a);i.onload=()=>{const o=i.response;s(new Mr(i,o))},i.onerror=n,i.onabort=()=>n(new U("Request aborted")),i.send(),t&&(t.aborted&&i.abort(),t.addEventListener("abort",()=>i.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}var ce={};class kr extends be{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class Cr extends Ie{constructor(e){super(e),this.parsedUrl=ce.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",ce)}constructRequest(e,t){return new Promise((s,n)=>{const i=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const c=[];o.on("data",f=>{c.push(f)}),o.on("end",()=>{const f=Buffer.concat(c).buffer;l(f)}),o.on("error",n)});s(new kr(o,a))});i.on("error",n),t&&(t.aborted&&i.destroy(new U("Request aborted")),t.addEventListener("abort",()=>i.destroy(new U("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class Se extends Qe{constructor(e,t,s,n){super(),this.client=e,this.headers=t,this.maxRanges=s,this.allowFullFile=n,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(s=>this.fetchSlice(s,t))))}async fetchSlices(e,t){const s=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:n,length:i})=>`${n}-${n+i}`).join(",")}`},signal:t});if(s.ok)if(s.status===206){const{type:n,params:i}=pr(s.getHeader("content-type"));if(n==="multipart/byteranges"){const h=xr(await s.getData(),i.boundary);return this._fileSize=h[0].fileSize||null,h}const o=await s.getData(),{start:a,end:l,total:c}=fe(s.getHeader("content-range"));this._fileSize=c||null;const f=[{data:o,offset:a,length:l-a}];if(e.length>1){const h=await Promise.all(e.slice(1).map(u=>this.fetchSlice(u,t)));return f.concat(h)}return f}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const n=await s.getData();return this._fileSize=n.byteLength,[{data:n,offset:0,length:n.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:s,length:n}=e,i=await this.client.request({headers:{...this.headers,Range:`bytes=${s}-${s+n}`},signal:t});if(i.ok)if(i.status===206){const o=await i.getData(),{total:a}=fe(i.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:s,length:n}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await i.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function Te(r,{blockSize:e,cacheSize:t}){return e===null?r:new Ar(r,{blockSize:e,cacheSize:t})}function _r(r,{headers:e={},credentials:t,maxRanges:s=0,allowFullFile:n=!1,...i}={}){const o=new Dr(r,t),a=new Se(o,e,s,n);return Te(a,i)}function Br(r,{headers:e={},maxRanges:t=0,allowFullFile:s=!1,...n}={}){const i=new Or(r),o=new Se(i,e,t,s);return Te(o,n)}function Rr(r,{headers:e={},maxRanges:t=0,allowFullFile:s=!1,...n}={}){const i=new Cr(r),o=new Se(i,e,t,s);return Te(o,n)}function Fr(r,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?_r(r,t):typeof XMLHttpRequest<"u"?Br(r,t):Rr(r,t)}function he(r){switch(r){case w.BYTE:case w.ASCII:case w.SBYTE:case w.UNDEFINED:return 1;case w.SHORT:case w.SSHORT:return 2;case w.LONG:case w.SLONG:case w.FLOAT:case w.IFD:return 4;case w.RATIONAL:case w.SRATIONAL:case w.DOUBLE:case w.LONG8:case w.SLONG8:case w.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${r}`)}}function Pr(r){const e=r.GeoKeyDirectory;if(!e)return null;const t={};for(let s=4;s<=e[3]*4;s+=4){const n=Yt[e[s]],i=e[s+1]?K[e[s+1]]:null,o=e[s+2],a=e[s+3];let l=null;if(!i)l=a;else{if(l=r[i],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${n}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[n]=l}return t}function F(r,e,t,s){let n=null,i=null;const o=he(e);switch(e){case w.BYTE:case w.ASCII:case w.UNDEFINED:n=new Uint8Array(t),i=r.readUint8;break;case w.SBYTE:n=new Int8Array(t),i=r.readInt8;break;case w.SHORT:n=new Uint16Array(t),i=r.readUint16;break;case w.SSHORT:n=new Int16Array(t),i=r.readInt16;break;case w.LONG:case w.IFD:n=new Uint32Array(t),i=r.readUint32;break;case w.SLONG:n=new Int32Array(t),i=r.readInt32;break;case w.LONG8:case w.IFD8:n=new Array(t),i=r.readUint64;break;case w.SLONG8:n=new Array(t),i=r.readInt64;break;case w.RATIONAL:n=new Uint32Array(t*2),i=r.readUint32;break;case w.SRATIONAL:n=new Int32Array(t*2),i=r.readInt32;break;case w.FLOAT:n=new Float32Array(t),i=r.readFloat32;break;case w.DOUBLE:n=new Float64Array(t),i=r.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===w.RATIONAL||e===w.SRATIONAL)for(let a=0;a<t;a+=2)n[a]=i.call(r,s+a*o),n[a+1]=i.call(r,s+(a*o+4));else for(let a=0;a<t;++a)n[a]=i.call(r,s+a*o);return e===w.ASCII?new TextDecoder("utf-8").decode(n):n}class Ur{constructor(e,t,s){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=s}}class re extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class Gr{async readRasters(e={}){const{window:t,width:s,height:n}=e;let{resX:i,resY:o,bbox:a}=e;const l=await this.getImage();let c=l;const f=await this.getImageCount(),h=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(s||n){if(t){const[g,p]=l.getOrigin(),[y,m]=l.getResolution();a=[g+t[0]*y,p+t[1]*m,g+t[2]*y,p+t[3]*m]}const d=a||h;if(s){if(i)throw new Error("Both width and resX passed");i=(d[2]-d[0])/s}if(n){if(o)throw new Error("Both width and resY passed");o=(d[3]-d[1])/n}}if(i||o){const d=[];for(let g=0;g<f;++g){const p=await this.getImage(g),{SubfileType:y,NewSubfileType:m}=p.fileDirectory;(g===0||y===2||m&1)&&d.push(p)}d.sort((g,p)=>g.getWidth()-p.getWidth());for(let g=0;g<d.length;++g){const p=d[g],y=(h[2]-h[0])/p.getWidth(),m=(h[3]-h[1])/p.getHeight();if(c=p,i&&i>y||o&&o>m)break}}let u=t;if(a){const[d,g]=l.getOrigin(),[p,y]=c.getResolution(l);u=[Math.round((a[0]-d)/p),Math.round((a[1]-g)/y),Math.round((a[2]-d)/p),Math.round((a[3]-g)/y)],u=[Math.min(u[0],u[2]),Math.min(u[1],u[3]),Math.max(u[0],u[2]),Math.max(u[1],u[3])]}return c.readRasters({...e,window:u})}}class Ae extends Gr{constructor(e,t,s,n,i={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=s,this.firstIFDOffset=n,this.cache=i.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const s=this.bigTiff?4048:1024;return new gr((await this.source.fetch([{offset:e,length:typeof t<"u"?t:s}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,s=this.bigTiff?8:2;let n=await this.getSlice(e);const i=this.bigTiff?n.readUint64(e):n.readUint16(e),o=i*t+(this.bigTiff?16:6);n.covers(e,o)||(n=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let h=0;h<i;l+=t,++h){const u=n.readUint16(l),d=n.readUint16(l+2),g=this.bigTiff?n.readUint64(l+4):n.readUint32(l+4);let p,y;const m=he(d),x=l+(this.bigTiff?12:8);if(m*g<=(this.bigTiff?8:4))p=F(n,d,g,x);else{const I=n.readOffset(x),b=he(d)*g;if(n.covers(I,b))p=F(n,d,g,I);else{const S=await this.getSlice(I,b);p=F(S,d,g,I)}}g===1&&qt.indexOf(u)===-1&&!(d===w.RATIONAL||d===w.SRATIONAL)?y=p[0]:y=p,a[K[u]]=y}const c=Pr(a),f=n.readOffset(e+s+t*i);return new Ur(a,c,f)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof re?new re(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new re(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new ur(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(s){if(s instanceof re)t=!1;else throw s}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",s=t.length+100;let n=await this.getSlice(e,s);if(t===F(n,w.ASCII,t.length,e)){const o=F(n,w.ASCII,s,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>s&&(n=await this.getSlice(e,a));const l=F(n,w.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(c=>c.length>0).map(c=>c.split("=")).forEach(([c,f])=>{this.ghostValues[c]=f})}return this.ghostValues}static async fromSource(e,t,s){const n=(await e.fetch([{offset:0,length:1024}],s))[0],i=new dr(n),o=i.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=i.getUint16(2,a);let c;if(l===42)c=!1;else if(l===43){if(c=!0,i.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const f=c?i.getUint64(8,a):i.getUint32(4,a);return new Ae(e,a,c,f,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}async function Nr(r,e={},t){return Ae.fromSource(Fr(r,e),t)}const Lr=[EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError,globalThis.DOMException,globalThis.AssertionError,globalThis.SystemError].filter(Boolean).map(r=>[r.name,r]),Ee=new Map(Lr),vr=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0},{property:"cause",enumerable:!1}],ue=new WeakSet,zr=r=>{ue.add(r);const e=r.toJSON();return ue.delete(r),e},We=({from:r,seen:e,to:t,forceEnumerable:s,maxDepth:n,depth:i,useToJSON:o,serialize:a})=>{if(t||(Array.isArray(r)?t=[]:t={}),e.push(r),i>=n)return t;if(o&&typeof r.toJSON=="function"&&!ue.has(r))return zr(r);const l=c=>We({from:c,seen:[...e],forceEnumerable:s,maxDepth:n,depth:i,useToJSON:o,serialize:a});for(const[c,f]of Object.entries(r)){if(f&&f instanceof Uint8Array&&f.constructor.name==="Buffer"){t[c]="[object Buffer]";continue}if(f!==null&&typeof f=="object"&&typeof f.pipe=="function"){t[c]="[object Stream]";continue}if(typeof f!="function"){if(!f||typeof f!="object"){try{t[c]=f}catch{}continue}if(!e.includes(r[c])){i++,t[c]=l(r[c]);continue}t[c]="[Circular]"}}for(const{property:c,enumerable:f}of vr)typeof r[c]<"u"&&r[c]!==null&&Object.defineProperty(t,c,{value:Kr(r[c])?l(r[c]):r[c],enumerable:!0,configurable:!0,writable:!0});return t};function Vr(r,e={}){const{maxDepth:t=Number.POSITIVE_INFINITY,useToJSON:s=!0}=e;return typeof r=="object"&&r!==null?We({from:r,seen:[],forceEnumerable:!0,maxDepth:t,depth:0,useToJSON:s,serialize:!0}):typeof r=="function"?`[Function: ${r.name||"anonymous"}]`:r}function Kr(r){return!!r&&typeof r=="object"&&"name"in r&&"message"in r&&"stack"in r}class qr extends Error{constructor(e){super(e),this.name="NodeNotFoundError"}}class jr extends Error{constructor(e){super(e),this.name="KeyError"}}var de=(r=>(r.UNKNOWN="unknown",r.NOT_FOUND="not_found",r.TOO_LARGE="too_large",r.LOAD_DATA_FAILED="load_data_failed",r.INVALID_METADATA="invalid_metadata",r.INVALID_MULTI_SOURCE_ZARR="invalid_multi_source_zarr",r))(de||{});class ge extends Error{constructor(e,t){super(e,t),this.name="VolumeLoadError",this.type=(t==null?void 0:t.type)??"unknown"}}Ee.set("NodeNotFoundError",qr);Ee.set("KeyError",jr);Ee.set("VolumeLoadError",ge);const et=1,tt=2,rt=3;function Yr(r,e){if(r===rt){if(e===4)return"float32"}else if(r===tt){if(e===1)return"int8";if(e===2)return"int16";if(e===4)return"int32"}else if(r===et){if(e===1)return"uint8";if(e===2)return"uint16";if(e===4)return"uint32"}return console.error(`TIFF Worker: unsupported sample format ${r} and bytes per pixel ${e}`),"uint8"}function Hr(r,e,t){if(t===rt){if(e===4)return new Float32Array(r)}else if(t===tt){if(e===1)return new Int8Array(r);if(e===2)return new Int16Array(r);if(e===4)return new Int32Array(r)}else if(t===et){if(e===1)return new Uint8Array(r);if(e===2)return new Uint16Array(r);if(e===4)return new Uint32Array(r)}return console.error(`TIFF Worker: unsupported sample format ${t} and bytes per pixel ${e}`),new Uint8Array(r)}async function $r(r){const e=r.data.channel,t=r.data.tilesizex,s=r.data.tilesizey,n=r.data.sizez,i=r.data.sizec,o=r.data.dimensionOrder,a=r.data.bytesPerSample,l=await Nr(r.data.url,{allowFullFile:!0});let c=0,f=1;o==="XYZCT"?(c=n*e,f=1):o==="XYCZT"&&(c=e,f=i);const h=await l.getImage(c),u=h.getSampleFormat(),d=h.getBytesPerPixel(),g=new ArrayBuffer(t*s*n*d),p=new Uint8Array(g);for(let b=c,S=0;S<n;b+=f,++S){const _=await(await l.getImage(b)).readRasters({width:t,height:s}),T=Array.isArray(_)?_[0]:_,R=S*t*s;if(T.BYTES_PER_ELEMENT>4)throw new ge("byte size not supported yet: "+T.BYTES_PER_ELEMENT,{type:de.INVALID_METADATA});if(T.BYTES_PER_ELEMENT!==a)throw new ge("tiff bytes per element mismatch with OME metadata",{type:de.INVALID_METADATA});p.set(new Uint8Array(T.buffer),R*T.BYTES_PER_ELEMENT)}const y=Hr(g,d,u),m=Yr(u,d);let x=y[0],I=y[0];for(let b=0;b<y.length;++b){const S=y[b];S<x&&(x=S),S>I&&(I=S)}return{data:y,channel:e,range:[x,I],dtype:m,isError:!1}}self.onmessage=async r=>{try{const e=await $r(r);self.postMessage(e,[e.data.buffer])}catch(e){self.postMessage({isError:!0,error:Vr(e)})}};export{Xr as L,Zr as a,Xe as g};
