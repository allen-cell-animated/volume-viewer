var Kn=Object.defineProperty;var Js=n=>{throw TypeError(n)};var Wn=(n,t,e)=>t in n?Kn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var I=(n,t,e)=>Wn(n,typeof t!="symbol"?t+"":t,e),We=(n,t,e)=>t.has(n)||Js("Cannot "+e);var D=(n,t,e)=>(We(n,t,"read from private field"),e?e.call(n):t.get(n)),q=(n,t,e)=>t.has(n)?Js("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),B=(n,t,e,s)=>(We(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e),Qe=(n,t,e)=>(We(n,t,"access private method"),e);const Qn=[EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError,globalThis.DOMException,globalThis.AssertionError,globalThis.SystemError].filter(Boolean).map(n=>[n.name,n]),Ve=new Map(Qn);class Ds extends Error{constructor(e){super(Ds._prepareSuperMessage(e));I(this,"name","NonError")}static _prepareSuperMessage(e){try{return JSON.stringify(e)}catch{return String(e)}}}const Jn=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0},{property:"cause",enumerable:!1}],gs=new WeakSet,tr=n=>{gs.add(n);const t=n.toJSON();return gs.delete(n),t},tn=n=>Ve.get(n)??Error,Rs=({from:n,seen:t,to:e,forceEnumerable:s,maxDepth:i,depth:r,useToJSON:a,serialize:o})=>{if(!e)if(Array.isArray(n))e=[];else if(!o&&ti(n)){const l=tn(n.name);e=new l}else e={};if(t.push(n),r>=i)return e;if(a&&typeof n.toJSON=="function"&&!gs.has(n))return tr(n);const h=l=>Rs({from:l,seen:[...t],forceEnumerable:s,maxDepth:i,depth:r,useToJSON:a,serialize:o});for(const[l,c]of Object.entries(n)){if(c&&c instanceof Uint8Array&&c.constructor.name==="Buffer"){e[l]="[object Buffer]";continue}if(c!==null&&typeof c=="object"&&typeof c.pipe=="function"){e[l]="[object Stream]";continue}if(typeof c!="function"){if(!c||typeof c!="object"){try{e[l]=c}catch{}continue}if(!t.includes(n[l])){r++,e[l]=h(n[l]);continue}e[l]="[Circular]"}}for(const{property:l,enumerable:c}of Jn)typeof n[l]<"u"&&n[l]!==null&&Object.defineProperty(e,l,{value:ti(n[l])?h(n[l]):n[l],enumerable:s?!0:c,configurable:!0,writable:!0});return e};function er(n,t={}){const{maxDepth:e=Number.POSITIVE_INFINITY,useToJSON:s=!0}=t;return typeof n=="object"&&n!==null?Rs({from:n,seen:[],forceEnumerable:!0,maxDepth:e,depth:0,useToJSON:s,serialize:!0}):typeof n=="function"?`[Function: ${n.name||"anonymous"}]`:n}function sr(n,t={}){const{maxDepth:e=Number.POSITIVE_INFINITY}=t;if(n instanceof Error)return n;if(ir(n)){const s=tn(n.name);return Rs({from:n,seen:[],to:new s,maxDepth:e,depth:0,serialize:!1})}return new Ds(n)}function ti(n){return!!n&&typeof n=="object"&&"name"in n&&"message"in n&&"stack"in n}function ir(n){return!!n&&typeof n=="object"&&"message"in n&&!Array.isArray(n)}const nr=25e7;class rr{constructor(t=nr){this.entries=new Map,this.maxSize=t,this.currentSize=0,this.first=null,this.last=null}get size(){return this.currentSize}get numberOfEntries(){return this.entries.size}removeEntryFromStore(t){this.entries.delete(t.key),this.currentSize-=t.data.byteLength}removeEntryFromList(t){const{prev:e,next:s}=t;e?e.next=s:this.first=s,s?s.prev=e:this.last=e}addEntryAsFirst(t){this.first?this.first.prev=t:this.last=t,t.next=this.first,t.prev=null,this.first=t}moveEntryToFirst(t){t!==this.first&&(this.removeEntryFromList(t),this.addEntryAsFirst(t))}evictLast(){if(!this.last){console.error("VolumeCache: attempt to evict last entry from cache when no last entry is set");return}this.removeEntryFromStore(this.last),this.last.prev&&(this.last.prev.next=null),this.last=this.last.prev}evict(t){this.removeEntryFromStore(t),this.removeEntryFromList(t)}insert(t,e){if(e.byteLength>this.maxSize)return console.error("VolumeCache: attempt to insert a single entry larger than the cache"),!1;const s=this.getEntry(t);if(s!==void 0)return s.data=e,!0;const i={data:e,prev:null,next:null,key:t};for(this.addEntryAsFirst(i),this.entries.set(t,i),this.currentSize+=e.byteLength;this.currentSize>this.maxSize;)this.evictLast();return!0}getEntry(t){const e=this.entries.get(t);return e&&this.moveEntryToFirst(e),e}get(t){var e;return(e=this.getEntry(t))==null?void 0:e.data}clearWithPrefix(t){for(const[e,s]of this.entries.entries())e.startsWith(t)&&this.evict(s)}clear(){for(;this.last;)this.evictLast()}}/**
 * @license
 * Copyright 2010-2024 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const en="171",Ls=300,ei=1e3,Nt=1001,si=1002,Ne=1003,sn=1006,ar=1008,ke=1009,or=1010,hr=1011,lr=1012,cr=1013,ur=1014,fr=1015,nn=1023,dr=1024,mr=1028,zt=1029,yr="",ge=2e3,ii=2001;class rn{addEventListener(t,e){this._listeners===void 0&&(this._listeners={});const s=this._listeners;s[t]===void 0&&(s[t]=[]),s[t].indexOf(e)===-1&&s[t].push(e)}hasEventListener(t,e){if(this._listeners===void 0)return!1;const s=this._listeners;return s[t]!==void 0&&s[t].indexOf(e)!==-1}removeEventListener(t,e){if(this._listeners===void 0)return;const i=this._listeners[t];if(i!==void 0){const r=i.indexOf(e);r!==-1&&i.splice(r,1)}}dispatchEvent(t){if(this._listeners===void 0)return;const s=this._listeners[t.type];if(s!==void 0){t.target=this;const i=s.slice(0);for(let r=0,a=i.length;r<a;r++)i[r].call(this,t);t.target=null}}}const v=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];function Os(){const n=Math.random()*4294967295|0,t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,s=Math.random()*4294967295|0;return(v[n&255]+v[n>>8&255]+v[n>>16&255]+v[n>>24&255]+"-"+v[t&255]+v[t>>8&255]+"-"+v[t>>16&15|64]+v[t>>24&255]+"-"+v[e&63|128]+v[e>>8&255]+"-"+v[e>>16&255]+v[e>>24&255]+v[s&255]+v[s>>8&255]+v[s>>16&255]+v[s>>24&255]).toLowerCase()}function R(n,t,e){return Math.max(t,Math.min(e,n))}class xt{constructor(t=0,e=0){xt.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,s=this.y,i=t.elements;return this.x=i[0]*e+i[3]*s+i[6],this.y=i[1]*e+i[4]*s+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=R(this.x,t.x,e.x),this.y=R(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=R(this.x,t,e),this.y=R(this.y,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(R(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(R(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const s=Math.cos(e),i=Math.sin(e),r=this.x-t.x,a=this.y-t.y;return this.x=r*s-a*i+t.x,this.y=r*i+a*s+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class de{constructor(t,e,s,i,r,a,o,h,l){de.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],t!==void 0&&this.set(t,e,s,i,r,a,o,h,l)}set(t,e,s,i,r,a,o,h,l){const c=this.elements;return c[0]=t,c[1]=i,c[2]=o,c[3]=e,c[4]=r,c[5]=h,c[6]=s,c[7]=a,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,a=s[0],o=s[3],h=s[6],l=s[1],c=s[4],u=s[7],d=s[2],f=s[5],m=s[8],y=i[0],p=i[3],g=i[6],x=i[1],w=i[4],S=i[7],_=i[2],A=i[5],M=i[8];return r[0]=a*y+o*x+h*_,r[3]=a*p+o*w+h*A,r[6]=a*g+o*S+h*M,r[1]=l*y+c*x+u*_,r[4]=l*p+c*w+u*A,r[7]=l*g+c*S+u*M,r[2]=d*y+f*x+m*_,r[5]=d*p+f*w+m*A,r[8]=d*g+f*S+m*M,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8];return e*a*c-e*o*l-s*r*c+s*o*h+i*r*l-i*a*h}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=c*a-o*l,d=o*h-c*r,f=l*r-a*h,m=e*u+s*d+i*f;if(m===0)return this.set(0,0,0,0,0,0,0,0,0);const y=1/m;return t[0]=u*y,t[1]=(i*l-c*s)*y,t[2]=(o*s-i*a)*y,t[3]=d*y,t[4]=(c*e-i*h)*y,t[5]=(i*r-o*e)*y,t[6]=f*y,t[7]=(s*h-l*e)*y,t[8]=(a*e-s*r)*y,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,i,r,a,o){const h=Math.cos(r),l=Math.sin(r);return this.set(s*h,s*l,-s*(h*a+l*o)+a+t,-i*l,i*h,-i*(-l*a+h*o)+o+e,0,0,1),this}scale(t,e){return this.premultiply(Je.makeScale(t,e)),this}rotate(t){return this.premultiply(Je.makeRotation(-t)),this}translate(t,e){return this.premultiply(Je.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,s,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,s=t.elements;for(let i=0;i<9;i++)if(e[i]!==s[i])return!1;return!0}fromArray(t,e=0){for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}clone(){return new this.constructor().fromArray(this.elements)}}const Je=new de;function ni(n){return document.createElementNS("http://www.w3.org/1999/xhtml",n)}function ts(n){return n<.04045?n*.0773993808:Math.pow(n*.9478672986+.0521327014,2.4)}let Et;class pr{static getDataURL(t){if(/^data:/i.test(t.src)||typeof HTMLCanvasElement>"u")return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{Et===void 0&&(Et=ni("canvas")),Et.width=t.width,Et.height=t.height;const s=Et.getContext("2d");t instanceof ImageData?s.putImageData(t,0,0):s.drawImage(t,0,0,t.width,t.height),e=Et}return e.width>2048||e.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}static sRGBToLinear(t){if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap){const e=ni("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0,t.width,t.height);const i=s.getImageData(0,0,t.width,t.height),r=i.data;for(let a=0;a<r.length;a++)r[a]=ts(r[a]/255)*255;return s.putImageData(i,0,0),e}else if(t.data){const e=t.data.slice(0);for(let s=0;s<e.length;s++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[s]=Math.floor(ts(e[s]/255)*255):e[s]=ts(e[s]);return{data:e,width:t.width,height:t.height}}else return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let gr=0;class xr{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:gr++}),this.uuid=Os(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){t===!0&&this.version++}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.images[this.uuid]!==void 0)return t.images[this.uuid];const s={uuid:this.uuid,url:""},i=this.data;if(i!==null){let r;if(Array.isArray(i)){r=[];for(let a=0,o=i.length;a<o;a++)i[a].isDataTexture?r.push(es(i[a].image)):r.push(es(i[a]))}else r=es(i);s.url=r}return e||(t.images[this.uuid]=s),s}}function es(n){return typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&n instanceof ImageBitmap?pr.getDataURL(n):n.data?{data:Array.from(n.data),width:n.width,height:n.height,type:n.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let _r=0;class dt extends rn{constructor(t=dt.DEFAULT_IMAGE,e=dt.DEFAULT_MAPPING,s=Nt,i=Nt,r=sn,a=ar,o=nn,h=ke,l=dt.DEFAULT_ANISOTROPY,c=yr){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:_r++}),this.uuid=Os(),this.name="",this.source=new xr(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=s,this.wrapT=i,this.magFilter=r,this.minFilter=a,this.anisotropy=l,this.format=o,this.internalFormat=null,this.type=h,this.offset=new xt(0,0),this.repeat=new xt(1,1),this.center=new xt(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new de,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=t===void 0||typeof t=="string";if(!e&&t.textures[this.uuid]!==void 0)return t.textures[this.uuid];const s={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(s.userData=this.userData),e||(t.textures[this.uuid]=s),s}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping!==Ls)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case ei:t.x=t.x-Math.floor(t.x);break;case Nt:t.x=t.x<0?0:1;break;case si:Math.abs(Math.floor(t.x)%2)===1?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x);break}if(t.y<0||t.y>1)switch(this.wrapT){case ei:t.y=t.y-Math.floor(t.y);break;case Nt:t.y=t.y<0?0:1;break;case si:Math.abs(Math.floor(t.y)%2)===1?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y);break}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){t===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){t===!0&&this.pmremVersion++}}dt.DEFAULT_IMAGE=null;dt.DEFAULT_MAPPING=Ls;dt.DEFAULT_ANISOTROPY=1;class me{constructor(t=0,e=0,s=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=s,this._w=i}static slerpFlat(t,e,s,i,r,a,o){let h=s[i+0],l=s[i+1],c=s[i+2],u=s[i+3];const d=r[a+0],f=r[a+1],m=r[a+2],y=r[a+3];if(o===0){t[e+0]=h,t[e+1]=l,t[e+2]=c,t[e+3]=u;return}if(o===1){t[e+0]=d,t[e+1]=f,t[e+2]=m,t[e+3]=y;return}if(u!==y||h!==d||l!==f||c!==m){let p=1-o;const g=h*d+l*f+c*m+u*y,x=g>=0?1:-1,w=1-g*g;if(w>Number.EPSILON){const _=Math.sqrt(w),A=Math.atan2(_,g*x);p=Math.sin(p*A)/_,o=Math.sin(o*A)/_}const S=o*x;if(h=h*p+d*S,l=l*p+f*S,c=c*p+m*S,u=u*p+y*S,p===1-o){const _=1/Math.sqrt(h*h+l*l+c*c+u*u);h*=_,l*=_,c*=_,u*=_}}t[e]=h,t[e+1]=l,t[e+2]=c,t[e+3]=u}static multiplyQuaternionsFlat(t,e,s,i,r,a){const o=s[i],h=s[i+1],l=s[i+2],c=s[i+3],u=r[a],d=r[a+1],f=r[a+2],m=r[a+3];return t[e]=o*m+c*u+h*f-l*d,t[e+1]=h*m+c*d+l*u-o*f,t[e+2]=l*m+c*f+o*d-h*u,t[e+3]=c*m-o*u-h*d-l*f,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,i){return this._x=t,this._y=e,this._z=s,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const s=t._x,i=t._y,r=t._z,a=t._order,o=Math.cos,h=Math.sin,l=o(s/2),c=o(i/2),u=o(r/2),d=h(s/2),f=h(i/2),m=h(r/2);switch(a){case"XYZ":this._x=d*c*u+l*f*m,this._y=l*f*u-d*c*m,this._z=l*c*m+d*f*u,this._w=l*c*u-d*f*m;break;case"YXZ":this._x=d*c*u+l*f*m,this._y=l*f*u-d*c*m,this._z=l*c*m-d*f*u,this._w=l*c*u+d*f*m;break;case"ZXY":this._x=d*c*u-l*f*m,this._y=l*f*u+d*c*m,this._z=l*c*m+d*f*u,this._w=l*c*u-d*f*m;break;case"ZYX":this._x=d*c*u-l*f*m,this._y=l*f*u+d*c*m,this._z=l*c*m-d*f*u,this._w=l*c*u+d*f*m;break;case"YZX":this._x=d*c*u+l*f*m,this._y=l*f*u+d*c*m,this._z=l*c*m-d*f*u,this._w=l*c*u-d*f*m;break;case"XZY":this._x=d*c*u-l*f*m,this._y=l*f*u-d*c*m,this._z=l*c*m+d*f*u,this._w=l*c*u+d*f*m;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+a)}return e===!0&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,i=Math.sin(s);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],i=e[4],r=e[8],a=e[1],o=e[5],h=e[9],l=e[2],c=e[6],u=e[10],d=s+o+u;if(d>0){const f=.5/Math.sqrt(d+1);this._w=.25/f,this._x=(c-h)*f,this._y=(r-l)*f,this._z=(a-i)*f}else if(s>o&&s>u){const f=2*Math.sqrt(1+s-o-u);this._w=(c-h)/f,this._x=.25*f,this._y=(i+a)/f,this._z=(r+l)/f}else if(o>u){const f=2*Math.sqrt(1+o-s-u);this._w=(r-l)/f,this._x=(i+a)/f,this._y=.25*f,this._z=(h+c)/f}else{const f=2*Math.sqrt(1+u-s-o);this._w=(a-i)/f,this._x=(r+l)/f,this._y=(h+c)/f,this._z=.25*f}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<Number.EPSILON?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(R(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(s===0)return this;const i=Math.min(1,e/s);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return t===0?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,i=t._y,r=t._z,a=t._w,o=e._x,h=e._y,l=e._z,c=e._w;return this._x=s*c+a*o+i*l-r*h,this._y=i*c+a*h+r*o-s*l,this._z=r*c+a*l+s*h-i*o,this._w=a*c-s*o-i*h-r*l,this._onChangeCallback(),this}slerp(t,e){if(e===0)return this;if(e===1)return this.copy(t);const s=this._x,i=this._y,r=this._z,a=this._w;let o=a*t._w+s*t._x+i*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=a,this._x=s,this._y=i,this._z=r,this;const h=1-o*o;if(h<=Number.EPSILON){const f=1-e;return this._w=f*a+e*this._w,this._x=f*s+e*this._x,this._y=f*i+e*this._y,this._z=f*r+e*this._z,this.normalize(),this}const l=Math.sqrt(h),c=Math.atan2(l,o),u=Math.sin((1-e)*c)/l,d=Math.sin(e*c)/l;return this._w=a*u+this._w*d,this._x=s*u+this._x*d,this._y=i*u+this._y*d,this._z=r*u+this._z*d,this._onChangeCallback(),this}slerpQuaternions(t,e,s){return this.copy(t).slerp(e,s)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),s=Math.random(),i=Math.sqrt(1-s),r=Math.sqrt(s);return this.set(i*Math.sin(t),i*Math.cos(t),r*Math.sin(e),r*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class b{constructor(t=0,e=0,s=0){b.prototype.isVector3=!0,this.x=t,this.y=e,this.z=s}set(t,e,s){return s===void 0&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(ri.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(ri.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*s+r[6]*i,this.y=r[1]*e+r[4]*s+r[7]*i,this.z=r[2]*e+r[5]*s+r[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=t.elements,a=1/(r[3]*e+r[7]*s+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*s+r[8]*i+r[12])*a,this.y=(r[1]*e+r[5]*s+r[9]*i+r[13])*a,this.z=(r[2]*e+r[6]*s+r[10]*i+r[14])*a,this}applyQuaternion(t){const e=this.x,s=this.y,i=this.z,r=t.x,a=t.y,o=t.z,h=t.w,l=2*(a*i-o*s),c=2*(o*e-r*i),u=2*(r*s-a*e);return this.x=e+h*l+a*u-o*c,this.y=s+h*c+o*l-r*u,this.z=i+h*u+r*c-a*l,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*i,this.y=r[1]*e+r[5]*s+r[9]*i,this.z=r[2]*e+r[6]*s+r[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=R(this.x,t.x,e.x),this.y=R(this.y,t.y,e.y),this.z=R(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=R(this.x,t,e),this.y=R(this.y,t,e),this.z=R(this.z,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(R(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,i=t.y,r=t.z,a=e.x,o=e.y,h=e.z;return this.x=i*h-r*o,this.y=r*a-s*h,this.z=s*o-i*a,this}projectOnVector(t){const e=t.lengthSq();if(e===0)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return ss.copy(this).projectOnVector(t),this.sub(ss)}reflect(t){return this.sub(ss.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(R(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return e*e+s*s+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const i=Math.sin(e)*t;return this.x=i*Math.sin(s),this.y=Math.cos(e)*t,this.z=i*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,e*4)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,e*3)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=Math.random()*2-1,s=Math.sqrt(1-e*e);return this.x=s*Math.cos(t),this.y=e,this.z=s*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const ss=new b,ri=new me;class et{constructor(t=new b(1/0,1/0,1/0),e=new b(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e+=3)this.expandByPoint(X.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,s=t.count;e<s;e++)this.expandByPoint(X.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const s=X.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(s),this.max.copy(t).add(s),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return new this.constructor().copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const s=t.geometry;if(s!==void 0){const r=s.getAttribute("position");if(e===!0&&r!==void 0&&t.isInstancedMesh!==!0)for(let a=0,o=r.count;a<o;a++)t.isMesh===!0?t.getVertexPosition(a,X):X.fromBufferAttribute(r,a),X.applyMatrix4(t.matrixWorld),this.expandByPoint(X);else t.boundingBox!==void 0?(t.boundingBox===null&&t.computeBoundingBox(),xe.copy(t.boundingBox)):(s.boundingBox===null&&s.computeBoundingBox(),xe.copy(s.boundingBox)),xe.applyMatrix4(t.matrixWorld),this.union(xe)}const i=t.children;for(let r=0,a=i.length;r<a;r++)this.expandByObject(i[r],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,X),X.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,s;return t.normal.x>0?(e=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),e<=-t.constant&&s>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(Zt),_e.subVectors(this.max,Zt),It.subVectors(t.a,Zt),Tt.subVectors(t.b,Zt),Ct.subVectors(t.c,Zt),ot.subVectors(Tt,It),ht.subVectors(Ct,Tt),yt.subVectors(It,Ct);let e=[0,-ot.z,ot.y,0,-ht.z,ht.y,0,-yt.z,yt.y,ot.z,0,-ot.x,ht.z,0,-ht.x,yt.z,0,-yt.x,-ot.y,ot.x,0,-ht.y,ht.x,0,-yt.y,yt.x,0];return!is(e,It,Tt,Ct,_e)||(e=[1,0,0,0,1,0,0,0,1],!is(e,It,Tt,Ct,_e))?!1:(we.crossVectors(ot,ht),e=[we.x,we.y,we.z],is(e,It,Tt,Ct,_e))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,X).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=this.getSize(X).length()*.5),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()?this:(it[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),it[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),it[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),it[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),it[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),it[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),it[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),it[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(it),this)}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const it=[new b,new b,new b,new b,new b,new b,new b,new b],X=new b,xe=new et,It=new b,Tt=new b,Ct=new b,ot=new b,ht=new b,yt=new b,Zt=new b,_e=new b,we=new b,pt=new b;function is(n,t,e,s,i){for(let r=0,a=n.length-3;r<=a;r+=3){pt.fromArray(n,r);const o=i.x*Math.abs(pt.x)+i.y*Math.abs(pt.y)+i.z*Math.abs(pt.z),h=t.dot(pt),l=e.dot(pt),c=s.dot(pt);if(Math.max(-Math.max(h,l,c),Math.min(h,l,c))>o)return!1}return!0}class rt{constructor(t,e,s,i,r,a,o,h,l,c,u,d,f,m,y,p){rt.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t!==void 0&&this.set(t,e,s,i,r,a,o,h,l,c,u,d,f,m,y,p)}set(t,e,s,i,r,a,o,h,l,c,u,d,f,m,y,p){const g=this.elements;return g[0]=t,g[4]=e,g[8]=s,g[12]=i,g[1]=r,g[5]=a,g[9]=o,g[13]=h,g[2]=l,g[6]=c,g[10]=u,g[14]=d,g[3]=f,g[7]=m,g[11]=y,g[15]=p,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new rt().fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,s){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,s=t.elements,i=1/Dt.setFromMatrixColumn(t,0).length(),r=1/Dt.setFromMatrixColumn(t,1).length(),a=1/Dt.setFromMatrixColumn(t,2).length();return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=0,e[4]=s[4]*r,e[5]=s[5]*r,e[6]=s[6]*r,e[7]=0,e[8]=s[8]*a,e[9]=s[9]*a,e[10]=s[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,s=t.x,i=t.y,r=t.z,a=Math.cos(s),o=Math.sin(s),h=Math.cos(i),l=Math.sin(i),c=Math.cos(r),u=Math.sin(r);if(t.order==="XYZ"){const d=a*c,f=a*u,m=o*c,y=o*u;e[0]=h*c,e[4]=-h*u,e[8]=l,e[1]=f+m*l,e[5]=d-y*l,e[9]=-o*h,e[2]=y-d*l,e[6]=m+f*l,e[10]=a*h}else if(t.order==="YXZ"){const d=h*c,f=h*u,m=l*c,y=l*u;e[0]=d+y*o,e[4]=m*o-f,e[8]=a*l,e[1]=a*u,e[5]=a*c,e[9]=-o,e[2]=f*o-m,e[6]=y+d*o,e[10]=a*h}else if(t.order==="ZXY"){const d=h*c,f=h*u,m=l*c,y=l*u;e[0]=d-y*o,e[4]=-a*u,e[8]=m+f*o,e[1]=f+m*o,e[5]=a*c,e[9]=y-d*o,e[2]=-a*l,e[6]=o,e[10]=a*h}else if(t.order==="ZYX"){const d=a*c,f=a*u,m=o*c,y=o*u;e[0]=h*c,e[4]=m*l-f,e[8]=d*l+y,e[1]=h*u,e[5]=y*l+d,e[9]=f*l-m,e[2]=-l,e[6]=o*h,e[10]=a*h}else if(t.order==="YZX"){const d=a*h,f=a*l,m=o*h,y=o*l;e[0]=h*c,e[4]=y-d*u,e[8]=m*u+f,e[1]=u,e[5]=a*c,e[9]=-o*c,e[2]=-l*c,e[6]=f*u+m,e[10]=d-y*u}else if(t.order==="XZY"){const d=a*h,f=a*l,m=o*h,y=o*l;e[0]=h*c,e[4]=-u,e[8]=l*c,e[1]=d*u+y,e[5]=a*c,e[9]=f*u-m,e[2]=m*u-f,e[6]=o*c,e[10]=y*u+d}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(wr,t,br)}lookAt(t,e,s){const i=this.elements;return V.subVectors(t,e),V.lengthSq()===0&&(V.z=1),V.normalize(),lt.crossVectors(s,V),lt.lengthSq()===0&&(Math.abs(s.z)===1?V.x+=1e-4:V.z+=1e-4,V.normalize(),lt.crossVectors(s,V)),lt.normalize(),be.crossVectors(V,lt),i[0]=lt.x,i[4]=be.x,i[8]=V.x,i[1]=lt.y,i[5]=be.y,i[9]=V.y,i[2]=lt.z,i[6]=be.z,i[10]=V.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,a=s[0],o=s[4],h=s[8],l=s[12],c=s[1],u=s[5],d=s[9],f=s[13],m=s[2],y=s[6],p=s[10],g=s[14],x=s[3],w=s[7],S=s[11],_=s[15],A=i[0],M=i[4],E=i[8],P=i[12],U=i[1],C=i[5],T=i[9],L=i[13],$=i[2],Z=i[6],St=i[10],At=i[14],at=i[3],j=i[7],st=i[11],Mt=i[15];return r[0]=a*A+o*U+h*$+l*at,r[4]=a*M+o*C+h*Z+l*j,r[8]=a*E+o*T+h*St+l*st,r[12]=a*P+o*L+h*At+l*Mt,r[1]=c*A+u*U+d*$+f*at,r[5]=c*M+u*C+d*Z+f*j,r[9]=c*E+u*T+d*St+f*st,r[13]=c*P+u*L+d*At+f*Mt,r[2]=m*A+y*U+p*$+g*at,r[6]=m*M+y*C+p*Z+g*j,r[10]=m*E+y*T+p*St+g*st,r[14]=m*P+y*L+p*At+g*Mt,r[3]=x*A+w*U+S*$+_*at,r[7]=x*M+w*C+S*Z+_*j,r[11]=x*E+w*T+S*St+_*st,r[15]=x*P+w*L+S*At+_*Mt,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],i=t[8],r=t[12],a=t[1],o=t[5],h=t[9],l=t[13],c=t[2],u=t[6],d=t[10],f=t[14],m=t[3],y=t[7],p=t[11],g=t[15];return m*(+r*h*u-i*l*u-r*o*d+s*l*d+i*o*f-s*h*f)+y*(+e*h*f-e*l*d+r*a*d-i*a*f+i*l*c-r*h*c)+p*(+e*l*u-e*o*f-r*a*u+s*a*f+r*o*c-s*l*c)+g*(-i*o*c-e*h*u+e*o*d+i*a*u-s*a*d+s*h*c)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=s),this}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=t[9],d=t[10],f=t[11],m=t[12],y=t[13],p=t[14],g=t[15],x=u*p*l-y*d*l+y*h*f-o*p*f-u*h*g+o*d*g,w=m*d*l-c*p*l-m*h*f+a*p*f+c*h*g-a*d*g,S=c*y*l-m*u*l+m*o*f-a*y*f-c*o*g+a*u*g,_=m*u*h-c*y*h-m*o*d+a*y*d+c*o*p-a*u*p,A=e*x+s*w+i*S+r*_;if(A===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const M=1/A;return t[0]=x*M,t[1]=(y*d*r-u*p*r-y*i*f+s*p*f+u*i*g-s*d*g)*M,t[2]=(o*p*r-y*h*r+y*i*l-s*p*l-o*i*g+s*h*g)*M,t[3]=(u*h*r-o*d*r-u*i*l+s*d*l+o*i*f-s*h*f)*M,t[4]=w*M,t[5]=(c*p*r-m*d*r+m*i*f-e*p*f-c*i*g+e*d*g)*M,t[6]=(m*h*r-a*p*r-m*i*l+e*p*l+a*i*g-e*h*g)*M,t[7]=(a*d*r-c*h*r+c*i*l-e*d*l-a*i*f+e*h*f)*M,t[8]=S*M,t[9]=(m*u*r-c*y*r-m*s*f+e*y*f+c*s*g-e*u*g)*M,t[10]=(a*y*r-m*o*r+m*s*l-e*y*l-a*s*g+e*o*g)*M,t[11]=(c*o*r-a*u*r-c*s*l+e*u*l+a*s*f-e*o*f)*M,t[12]=_*M,t[13]=(c*y*i-m*u*i+m*s*d-e*y*d-c*s*p+e*u*p)*M,t[14]=(m*o*i-a*y*i-m*s*h+e*y*h+a*s*p-e*o*p)*M,t[15]=(a*u*i-c*o*i+c*s*h-e*u*h-a*s*d+e*o*d)*M,this}scale(t){const e=this.elements,s=t.x,i=t.y,r=t.z;return e[0]*=s,e[4]*=i,e[8]*=r,e[1]*=s,e[5]*=i,e[9]*=r,e[2]*=s,e[6]*=i,e[10]*=r,e[3]*=s,e[7]*=i,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,i))}makeTranslation(t,e,s){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),i=Math.sin(e),r=1-s,a=t.x,o=t.y,h=t.z,l=r*a,c=r*o;return this.set(l*a+s,l*o-i*h,l*h+i*o,0,l*o+i*h,c*o+s,c*h-i*a,0,l*h-i*o,c*h+i*a,r*h*h+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s,i,r,a){return this.set(1,s,r,0,t,1,a,0,e,i,1,0,0,0,0,1),this}compose(t,e,s){const i=this.elements,r=e._x,a=e._y,o=e._z,h=e._w,l=r+r,c=a+a,u=o+o,d=r*l,f=r*c,m=r*u,y=a*c,p=a*u,g=o*u,x=h*l,w=h*c,S=h*u,_=s.x,A=s.y,M=s.z;return i[0]=(1-(y+g))*_,i[1]=(f+S)*_,i[2]=(m-w)*_,i[3]=0,i[4]=(f-S)*A,i[5]=(1-(d+g))*A,i[6]=(p+x)*A,i[7]=0,i[8]=(m+w)*M,i[9]=(p-x)*M,i[10]=(1-(d+y))*M,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,s){const i=this.elements;let r=Dt.set(i[0],i[1],i[2]).length();const a=Dt.set(i[4],i[5],i[6]).length(),o=Dt.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),t.x=i[12],t.y=i[13],t.z=i[14],H.copy(this);const l=1/r,c=1/a,u=1/o;return H.elements[0]*=l,H.elements[1]*=l,H.elements[2]*=l,H.elements[4]*=c,H.elements[5]*=c,H.elements[6]*=c,H.elements[8]*=u,H.elements[9]*=u,H.elements[10]*=u,e.setFromRotationMatrix(H),s.x=r,s.y=a,s.z=o,this}makePerspective(t,e,s,i,r,a,o=ge){const h=this.elements,l=2*r/(e-t),c=2*r/(s-i),u=(e+t)/(e-t),d=(s+i)/(s-i);let f,m;if(o===ge)f=-(a+r)/(a-r),m=-2*a*r/(a-r);else if(o===ii)f=-a/(a-r),m=-a*r/(a-r);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);return h[0]=l,h[4]=0,h[8]=u,h[12]=0,h[1]=0,h[5]=c,h[9]=d,h[13]=0,h[2]=0,h[6]=0,h[10]=f,h[14]=m,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(t,e,s,i,r,a,o=ge){const h=this.elements,l=1/(e-t),c=1/(s-i),u=1/(a-r),d=(e+t)*l,f=(s+i)*c;let m,y;if(o===ge)m=(a+r)*u,y=-2*u;else if(o===ii)m=r*u,y=-1*u;else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);return h[0]=2*l,h[4]=0,h[8]=0,h[12]=-d,h[1]=0,h[5]=2*c,h[9]=0,h[13]=-f,h[2]=0,h[6]=0,h[10]=y,h[14]=-m,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let i=0;i<16;i++)if(e[i]!==s[i])return!1;return!0}fromArray(t,e=0){for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}}const Dt=new b,H=new rt,wr=new b(0,0,0),br=new b(1,1,1),lt=new b,be=new b,V=new b,ai=new rt,oi=new me;class Ge{constructor(t=0,e=0,s=0,i=Ge.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=s,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,s,i=this._order){return this._x=t,this._y=e,this._z=s,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,s=!0){const i=t.elements,r=i[0],a=i[4],o=i[8],h=i[1],l=i[5],c=i[9],u=i[2],d=i[6],f=i[10];switch(e){case"XYZ":this._y=Math.asin(R(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,f),this._z=Math.atan2(-a,r)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-R(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(o,f),this._z=Math.atan2(h,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(R(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,f),this._z=Math.atan2(-a,l)):(this._y=0,this._z=Math.atan2(h,r));break;case"ZYX":this._y=Math.asin(-R(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,f),this._z=Math.atan2(h,r)):(this._x=0,this._z=Math.atan2(-a,l));break;case"YZX":this._z=Math.asin(R(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(o,f));break;case"XZY":this._z=Math.asin(-R(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-c,f),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,s===!0&&this._onChangeCallback(),this}setFromQuaternion(t,e,s){return ai.makeRotationFromQuaternion(t),this.setFromRotationMatrix(ai,e,s)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return oi.setFromEuler(this),this.setFromQuaternion(oi,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],t[3]!==void 0&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Ge.DEFAULT_ORDER="XYZ";class Sr{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return(this.mask&t.mask)!==0}isEnabled(t){return(this.mask&(1<<t|0))!==0}}let Ar=0;const hi=new b,Rt=new me,nt=new rt,Se=new b,jt=new b,Mr=new b,zr=new me,li=new b(1,0,0),ci=new b(0,1,0),ui=new b(0,0,1),fi={type:"added"},Er={type:"removed"},Lt={type:"childadded",child:null},ns={type:"childremoved",child:null};class _t extends rn{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Ar++}),this.uuid=Os(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=_t.DEFAULT_UP.clone();const t=new b,e=new Ge,s=new me,i=new b(1,1,1);function r(){s.setFromEuler(e,!1)}function a(){e.setFromQuaternion(s,void 0,!1)}e._onChange(r),s._onChange(a),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new rt},normalMatrix:{value:new de}}),this.matrix=new rt,this.matrixWorld=new rt,this.matrixAutoUpdate=_t.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=_t.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Sr,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return Rt.setFromAxisAngle(t,e),this.quaternion.multiply(Rt),this}rotateOnWorldAxis(t,e){return Rt.setFromAxisAngle(t,e),this.quaternion.premultiply(Rt),this}rotateX(t){return this.rotateOnAxis(li,t)}rotateY(t){return this.rotateOnAxis(ci,t)}rotateZ(t){return this.rotateOnAxis(ui,t)}translateOnAxis(t,e){return hi.copy(t).applyQuaternion(this.quaternion),this.position.add(hi.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(li,t)}translateY(t){return this.translateOnAxis(ci,t)}translateZ(t){return this.translateOnAxis(ui,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(nt.copy(this.matrixWorld).invert())}lookAt(t,e,s){t.isVector3?Se.copy(t):Se.set(t,e,s);const i=this.parent;this.updateWorldMatrix(!0,!1),jt.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?nt.lookAt(jt,Se,this.up):nt.lookAt(Se,jt,this.up),this.quaternion.setFromRotationMatrix(nt),i&&(nt.extractRotation(i.matrixWorld),Rt.setFromRotationMatrix(nt),this.quaternion.premultiply(Rt.invert()))}add(t){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(fi),Lt.child=t,this.dispatchEvent(Lt),Lt.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let s=0;s<arguments.length;s++)this.remove(arguments[s]);return this}const e=this.children.indexOf(t);return e!==-1&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Er),ns.child=t,this.dispatchEvent(ns),ns.child=null),this}removeFromParent(){const t=this.parent;return t!==null&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),nt.copy(this.matrixWorld).invert(),t.parent!==null&&(t.parent.updateWorldMatrix(!0,!1),nt.multiply(t.parent.matrixWorld)),t.applyMatrix4(nt),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(fi),Lt.child=t,this.dispatchEvent(Lt),Lt.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let s=0,i=this.children.length;s<i;s++){const a=this.children[s].getObjectByProperty(t,e);if(a!==void 0)return a}}getObjectsByProperty(t,e,s=[]){this[t]===e&&s.push(this);const i=this.children;for(let r=0,a=i.length;r<a;r++)i[r].getObjectsByProperty(t,e,s);return s}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(jt,t,Mr),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(jt,zr,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverse(t)}traverseVisible(t){if(this.visible===!1)return;t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverseVisible(t)}traverseAncestors(t){const e=this.parent;e!==null&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].updateMatrixWorld(t)}updateWorldMatrix(t,e){const s=this.parent;if(t===!0&&s!==null&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),e===!0){const i=this.children;for(let r=0,a=i.length;r<a;r++)i[r].updateWorldMatrix(!1,!0)}}toJSON(t){const e=t===void 0||typeof t=="string",s={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},s.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const i={};i.uuid=this.uuid,i.type=this.type,this.name!==""&&(i.name=this.name),this.castShadow===!0&&(i.castShadow=!0),this.receiveShadow===!0&&(i.receiveShadow=!0),this.visible===!1&&(i.visible=!1),this.frustumCulled===!1&&(i.frustumCulled=!1),this.renderOrder!==0&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.visibility=this._visibility,i.active=this._active,i.bounds=this._bounds.map(o=>({boxInitialized:o.boxInitialized,boxMin:o.box.min.toArray(),boxMax:o.box.max.toArray(),sphereInitialized:o.sphereInitialized,sphereRadius:o.sphere.radius,sphereCenter:o.sphere.center.toArray()})),i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.geometryCount=this._geometryCount,i.matricesTexture=this._matricesTexture.toJSON(t),this._colorsTexture!==null&&(i.colorsTexture=this._colorsTexture.toJSON(t)),this.boundingSphere!==null&&(i.boundingSphere={center:i.boundingSphere.center.toArray(),radius:i.boundingSphere.radius}),this.boundingBox!==null&&(i.boundingBox={min:i.boundingBox.min.toArray(),max:i.boundingBox.max.toArray()}));function r(o,h){return o[h.uuid]===void 0&&(o[h.uuid]=h.toJSON(t)),h.uuid}if(this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(t.geometries,this.geometry);const o=this.geometry.parameters;if(o!==void 0&&o.shapes!==void 0){const h=o.shapes;if(Array.isArray(h))for(let l=0,c=h.length;l<c;l++){const u=h[l];r(t.shapes,u)}else r(t.shapes,h)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(r(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const o=[];for(let h=0,l=this.material.length;h<l;h++)o.push(r(t.materials,this.material[h]));i.material=o}else i.material=r(t.materials,this.material);if(this.children.length>0){i.children=[];for(let o=0;o<this.children.length;o++)i.children.push(this.children[o].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let o=0;o<this.animations.length;o++){const h=this.animations[o];i.animations.push(r(t.animations,h))}}if(e){const o=a(t.geometries),h=a(t.materials),l=a(t.textures),c=a(t.images),u=a(t.shapes),d=a(t.skeletons),f=a(t.animations),m=a(t.nodes);o.length>0&&(s.geometries=o),h.length>0&&(s.materials=h),l.length>0&&(s.textures=l),c.length>0&&(s.images=c),u.length>0&&(s.shapes=u),d.length>0&&(s.skeletons=d),f.length>0&&(s.animations=f),m.length>0&&(s.nodes=m)}return s.object=i,s;function a(o){const h=[];for(const l in o){const c=o[l];delete c.metadata,h.push(c)}return h}}clone(t){return new this.constructor().copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),e===!0)for(let s=0;s<t.children.length;s++){const i=t.children[s];this.add(i.clone())}return this}}_t.DEFAULT_UP=new b(0,1,0);_t.DEFAULT_MATRIX_AUTO_UPDATE=!0;_t.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;class rs extends dt{constructor(t=null,e=1,s=1,i,r,a,o,h,l=Ne,c=Ne,u,d){super(null,a,o,h,l,c,i,r,u,d),this.isDataTexture=!0,this.image={data:t,width:e,height:s},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:en}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=en);class Gt extends Error{constructor(t){super(t),this.name="NodeNotFoundError"}}class an extends Error{constructor(t){super(t),this.name="KeyError"}}var Y;class Ye{constructor(t,e,s){q(this,Y);typeof t=="number"?B(this,Y,new Uint8Array(t)):t instanceof ArrayBuffer?B(this,Y,new Uint8Array(t,e,s)):B(this,Y,new Uint8Array(Array.from(t,i=>i?1:0)))}get BYTES_PER_ELEMENT(){return 1}get byteOffset(){return D(this,Y).byteOffset}get byteLength(){return D(this,Y).byteLength}get buffer(){return D(this,Y).buffer}get length(){return D(this,Y).length}get(t){let e=D(this,Y)[t];return typeof e=="number"?e!==0:e}set(t,e){D(this,Y)[t]=e?1:0}fill(t){D(this,Y).fill(t?1:0)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}Y=new WeakMap;class $e{constructor(t,e,s,i){I(this,"_data");if(this.chars=t,typeof e=="number")this._data=new Uint8Array(e*t);else if(e instanceof ArrayBuffer)i&&(i=i*t),this._data=new Uint8Array(e,s,i);else{let r=Array.from(e);this._data=new Uint8Array(r.length*t);for(let a=0;a<r.length;a++)this.set(a,r[a])}}get BYTES_PER_ELEMENT(){return this.chars}get byteOffset(){return this._data.byteOffset}get byteLength(){return this._data.byteLength}get buffer(){return this._data.buffer}get length(){return this.byteLength/this.BYTES_PER_ELEMENT}get(t){const e=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);return new TextDecoder().decode(e).replace(/\x00/g,"")}_encode(t){return new TextEncoder().encode(t)}set(t,e){const s=new Uint8Array(this.buffer,this.byteOffset+this.chars*t,this.chars);s.fill(0),s.set(this._encode(e))}fill(t){const e=this._encode(t);for(let s=0;s<this.length;s++)this._data.set(e,s*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}class Xe{constructor(t,e,s,i){I(this,"_data");if(this.chars=t,typeof e=="number")this._data=new Int32Array(e*t);else if(e instanceof ArrayBuffer)i&&(i*=t),this._data=new Int32Array(e,s,i);else{const r=e,a=this._encode.bind(this);this._data=new Int32Array(function*(){for(let o of r)yield*a(o)}())}}get BYTES_PER_ELEMENT(){return this._data.BYTES_PER_ELEMENT*this.chars}get byteLength(){return this._data.byteLength}get byteOffset(){return this._data.byteOffset}get buffer(){return this._data.buffer}get length(){return this._data.length/this.chars}_encode(t){let e=new Int32Array(this.chars);for(let s=0;s<this.chars;s++)e[s]=t.codePointAt(s)??0;return e}get(t){const e=this.chars*t;let s="";for(let i=0;i<this.chars;i++)s+=String.fromCodePoint(this._data[e+i]);return s.replace(/\u0000/g,"")}set(t,e){const s=this.chars*t,i=this._data.subarray(s,s+this.chars);i.fill(0),i.set(this._encode(e))}fill(t){const e=this._encode(t);for(let s=0;s<this.length;s++)this._data.set(e,s*this.chars)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}}function He(n){const t=new TextDecoder().decode(n);return JSON.parse(t)}function di(n,t){const e=t/2,s=t-1;let i=0;for(let r=0;r<n.length;r+=t)for(let a=0;a<e;a+=1)i=n[r+a],n[r+a]=n[r+s-a],n[r+s-a]=i}const Ir={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float32:Float32Array,float64:Float64Array,bool:Ye},Tr=/v2:([US])(\d+)/;function on(n){if(n==="v2:object")return globalThis.Array;let t=n.match(Tr);if(t){let[,s,i]=t;return(s==="U"?Xe:$e).bind(null,Number(i))}let e=Ir[n];if(!e)throw new Error(`Unknown or unsupported data_type: ${n}`);return e}function qt(n,t){return(t==="C"?Cr:Dr)(n)}function Cr(n){const t=n.length,e=globalThis.Array(t);for(let s=t-1,i=1;s>=0;s--)e[s]=i,i*=n[s];return e}function Dr(n){const t=n.length,e=globalThis.Array(t);for(let s=0,i=1;s<t;s++)e[s]=i,i*=n[s];return e}function Rr({name:n,configuration:t}){if(n==="default")return e=>["c",...e].join(t.separator);if(n==="v2")return e=>e.join(t.separator)||"0";throw new Error(`Unknown chunk key encoding: ${n}`)}function xs(n){var e;const t=n.find(s=>s.name==="transpose");return((e=t==null?void 0:t.configuration)==null?void 0:e.order)==="F"?"F":"C"}const Lr=/^([<|>])(.*)$/;function Or(n){if(n==="|O")return{data_type:"v2:object"};let t=n.match(Lr);if(!t)throw new Error(`Invalid dtype: ${n}`);let[,e,s]=t,i={b1:"bool",i1:"int8",u1:"uint8",i2:"int16",u2:"uint16",i4:"int32",u4:"uint32",i8:"int64",u8:"uint64",f4:"float32",f8:"float64"}[s]??(s.startsWith("S")||s.startsWith("U")?`v2:${s}`:void 0);if(!i)throw new Error(`Unsupported or unknown dtype: ${n}`);return e==="|"?{data_type:i}:{data_type:i,endian:e==="<"?"little":"big"}}function kr(n,t={}){let e=[],s=Or(n.dtype);n.order==="F"&&e.push({name:"transpose",configuration:{order:"F"}}),"endian"in s&&s.endian==="big"&&e.push({name:"endian",configuration:{endian:"big"}});for(let{id:i,...r}of n.filters??[])e.push({name:i,configuration:r});if(n.compressor){let{id:i,...r}=n.compressor;e.push({name:i,configuration:r})}return{zarr_format:3,node_type:"array",shape:n.shape,data_type:s.data_type,chunk_grid:{name:"regular",configuration:{chunk_shape:n.chunks}},chunk_key_encoding:{name:"v2",configuration:{separator:n.dimension_separator??"."}},codecs:e,fill_value:n.fill_value,attributes:t}}function Pr(n,t={}){return{zarr_format:3,node_type:"group",attributes:t}}function vr(n,t){if(t!=="number"&&t!=="bigint"&&t!=="boolean"&&t!=="object"&&t!=="string")return n===t;let e=n==="bool";if(t==="boolean")return e;let s=n.startsWith("v2:U")||n.startsWith("v2:S");if(t==="string")return s;let i=n==="int64"||n==="uint64";if(t==="bigint")return i;let r=n==="v2:object";return t==="object"?r:!s&&!i&&!e&&!r}function Nr(n){return(n==null?void 0:n.name)==="sharding_indexed"}function Ur(n){return(n.data_type==="uint64"||n.data_type==="int64")&&n.fill_value!=null?BigInt(n.fill_value):n.fill_value}function mi(n){return n instanceof Ye||n instanceof $e||n instanceof Xe?new Proxy(n,{get(t,e){return t.get(Number(e))},set(t,e,s){return t.set(Number(e),s),!0}}):n}function Fr(n,t){let e;return n.data instanceof $e||n.data instanceof Xe?e=new n.constructor(n.data.length,n.data.chars):e=new n.constructor(n.data.length),{data:e,shape:n.shape,stride:qt(n.shape,t)}}function Br(n,t){let e=Fr(n,t),s=n.shape.length,i=n.data.length,r=Array(s).fill(0),a=mi(n.data),o=mi(e.data);for(let h=0;h<i;h++){let l=0;for(let c=0;c<s;c++)l+=r[c]*e.stride[c];o[l]=a[h],r[0]+=1;for(let c=0;c<s;c++)if(r[c]===n.shape[c]){if(c+1===s)break;r[c]=0,r[c+1]+=1}}return e}function qr(n){if(!n.stride)return"C";let t=qt(n.shape,"C");return n.stride.every((e,s)=>e===t[s])?"C":"F"}class ks{constructor(t){I(this,"configuration");I(this,"kind","array_to_array");this.configuration=t}static fromConfig(t){return new ks(t)}encode(t){return qr(t)===this.configuration.order?t:Br(t,this.configuration.order)}decode(t){return t}}const yi=Vr();function Vr(){const n=new Uint32Array([305419896]);return new Uint8Array(n.buffer,n.byteOffset,n.byteLength)[0]!==18}function pi(n){return"BYTES_PER_ELEMENT"in n?n.BYTES_PER_ELEMENT:4}var re,ut,ae,oe;const Ks=class Ks{constructor(t,e){I(this,"configuration");I(this,"kind","array_to_bytes");q(this,re);q(this,ut);q(this,ae);q(this,oe);this.configuration=t,B(this,ut,on(e.data_type)),B(this,oe,e.shape),B(this,re,qt(e.shape,xs(e.codecs))),B(this,ae,new(D(this,ut))(0).BYTES_PER_ELEMENT)}static fromConfig(t,e){return new Ks(t,e)}encode(t){let e=new Uint8Array(t.data.buffer);return yi&&this.configuration.endian==="big"&&di(e,pi(D(this,ut))),e}decode(t){return yi&&this.configuration.endian==="big"&&di(t,pi(D(this,ut))),{data:new(D(this,ut))(t.buffer,t.byteOffset,t.byteLength/D(this,ae)),shape:D(this,oe),stride:D(this,re)}}};re=new WeakMap,ut=new WeakMap,ae=new WeakMap,oe=new WeakMap;let Ue=Ks;class Ps{constructor(){I(this,"kind","bytes_to_bytes")}static fromConfig(){return new Ps}encode(t){throw new Error("Not implemented")}decode(t){return new Uint8Array(t.buffer,t.byteOffset,t.byteLength-4)}}var he,le;const Ws=class Ws{constructor(t){I(this,"kind","array_to_bytes");q(this,he);q(this,le);B(this,he,t),B(this,le,qt(t,"C"))}static fromConfig(t,e){return new Ws(e.shape)}encode(t){throw new Error("Method not implemented.")}decode(t){let e=new TextDecoder,s=new DataView(t.buffer),i=Array(s.getUint32(0,!0)),r=4;for(let a=0;a<i.length;a++){let o=s.getUint32(r,!0);r+=4,i[a]=e.decode(t.buffer.slice(r,r+o)),r+=o}return{data:i,shape:D(this,he),stride:D(this,le)}}};he=new WeakMap,le=new WeakMap;let _s=Ws;function Gr(){return new Map().set("blosc",()=>import("./blosc-DYi33WKg.js").then(n=>n.default)).set("gzip",()=>import("./gzip-Bwve3JUf.js").then(n=>n.default)).set("lz4",()=>import("./lz4-WP0ln0YW.js").then(n=>n.default)).set("zlib",()=>import("./zlib-SxMJTk60.js").then(n=>n.default)).set("zstd",()=>import("./zstd-DcHKBiK5.js").then(n=>n.default)).set("transpose",()=>ks).set("endian",()=>Ue).set("crc32c",()=>Ps).set("vlen-utf8",()=>_s)}const Yr=Gr();function ws(n){let t;return{async encode(e){t||(t=await gi(n));for(const i of t.array_to_array)e=await i.encode(e);let s=await t.array_to_bytes.encode(e);for(const i of t.bytes_to_bytes)s=await i.encode(s);return s},async decode(e){t||(t=await gi(n));for(let i=t.bytes_to_bytes.length-1;i>=0;i--)e=await t.bytes_to_bytes[i].decode(e);let s=await t.array_to_bytes.decode(e);for(let i=t.array_to_array.length-1;i>=0;i--)s=await t.array_to_array[i].decode(s);return s}}}async function gi(n){let t=n.codecs.map(async r=>{var o;let a=await((o=Yr.get(r.name))==null?void 0:o());if(!a)throw new Error(`Unknown codec: ${r.name}`);return{Codec:a,meta:r}}),e=[],s=Ue.fromConfig({endian:"little"},n),i=[];for await(let{Codec:r,meta:a}of t){let o=r.fromConfig(a.configuration,n);switch(o.kind){case"array_to_array":e.push(o);break;case"array_to_bytes":s=o;break;default:i.push(o)}}return{array_to_array:e,array_to_bytes:s,bytes_to_bytes:i}}const xi=18446744073709551615n;function $r(n,t,e,s){if(n.store.getRange===void 0)throw new Error("Store does not support range requests");let i=n.store.getRange.bind(n.store),r=t.map((h,l)=>h/s.chunk_shape[l]),a=ws({data_type:"uint64",shape:[...r,2],codecs:s.index_codecs}),o={};return async h=>{let l=h.map((x,w)=>Math.floor(x/r[w])),c=n.resolve(e(l)).path,u;if(c in o)u=o[c];else{let x=4,w=16*r.reduce((_,A)=>_*A,1),S=await i(c,{suffixLength:w+x});u=o[c]=S?await a.decode(S):null}if(u===null)return;let{data:d,shape:f,stride:m}=u,y=h.map((x,w)=>x%f[w]).reduce((x,w,S)=>x+w*m[S],0),p=d[y],g=d[y+1];if(!(p===xi&&g===xi))return i(c,{offset:Number(p),length:Number(g)})}}class bt{constructor(t,e="/"){I(this,"store");I(this,"path");this.store=t,this.path=e}resolve(t){let e=new URL(`file://${this.path.endsWith("/")?this.path:`${this.path}/`}`);return new bt(this.store,new URL(t,e).pathname)}}function Xr(n){return new bt(n??new Map)}var ce;class vs extends bt{constructor(e,s,i){super(e,s);I(this,"kind","group");q(this,ce);B(this,ce,i)}get attrs(){return D(this,ce).attributes}}ce=new WeakMap;const Qt=Symbol("zarrita.context");function Hr(n){return n[Qt]}function Zr(n,t){let{configuration:e}=t.codecs.find(Nr)??{},s={encode_chunk_key:Rr(t.chunk_key_encoding),TypedArray:on(t.data_type),fill_value:t.fill_value};if(e){let r=xs(e.codecs);return{...s,kind:"sharded",chunk_shape:e.chunk_shape,codec:ws({data_type:t.data_type,shape:e.chunk_shape,codecs:e.codecs}),get_strides(a,o){return qt(a,o??r)},get_chunk_bytes:$r(n,t.chunk_grid.configuration.chunk_shape,s.encode_chunk_key,e)}}let i=xs(t.codecs);return{...s,kind:"regular",chunk_shape:t.chunk_grid.configuration.chunk_shape,codec:ws({data_type:t.data_type,shape:t.chunk_grid.configuration.chunk_shape,codecs:t.codecs}),get_strides(r,a){return qt(r,a??i)},async get_chunk_bytes(r,a){let o=s.encode_chunk_key(r),h=n.resolve(o).path;return n.store.get(h,a)}}}var Wi,Qi,gt,Ji;let Fe=(Ji=class extends(Qi=bt,Wi=Qt,Qi){constructor(e,s,i){super(e,s);I(this,"kind","array");q(this,gt);I(this,Wi);B(this,gt,{...i,fill_value:Ur(i)}),this[Qt]=Zr(this,i)}get attrs(){return D(this,gt).attributes}get shape(){return D(this,gt).shape}get chunks(){return this[Qt].chunk_shape}get dtype(){return D(this,gt).data_type}async getChunk(e,s){let i=this[Qt],r=await i.get_chunk_bytes(e,s);if(!r){let a=i.chunk_shape.reduce((h,l)=>h*l,1),o=new i.TypedArray(a);return o.fill(i.fill_value),{data:o,shape:i.chunk_shape,stride:i.get_strides(i.chunk_shape)}}return i.codec.decode(r)}is(e){return vr(this.dtype,e)}},gt=new WeakMap,Ji);async function jr(n){let t=await n.store.get(n.resolve(".zattrs").path);return t?He(t):{}}async function hn(n,t={}){let e="store"in n?n:new bt(n),s={};return(t.attrs??!0)&&(s=await jr(e)),t.kind==="array"?_i(e,s):t.kind==="group"?wi(e,s):_i(e,s).catch(i=>{if(i instanceof Gt)return wi(e,s);throw i})}async function _i(n,t){let{path:e}=n.resolve(".zarray"),s=await n.store.get(e);if(!s)throw new Gt(e);return new Fe(n.store,n.path,kr(He(s),t))}async function wi(n,t){let{path:e}=n.resolve(".zgroup"),s=await n.store.get(e);if(!s)throw new Gt(e);return new vs(n.store,n.path,Pr(He(s),t))}async function Kr(n){let{store:t,path:e}=n.resolve("zarr.json"),s=await n.store.get(e);if(!s)throw new Gt(e);let i=He(s);return i.node_type==="array"&&(i.data_type==="uint64"||i.data_type==="int64")&&i.fill_value!=null&&(i.fill_value=BigInt(i.fill_value)),i.node_type==="array"?new Fe(t,n.path,i):new vs(t,n.path,i)}async function ln(n,t={}){let e="store"in n?n:new bt(n),s=await Kr(e);if(t.kind===void 0||t.kind==="array"&&s instanceof Fe||t.kind==="group"&&s instanceof vs)return s;let i=s instanceof Fe?"array":"group";throw new Error(`Expected node of kind ${t.kind}, found ${i}.`)}async function Be(n,t={}){return ln(n,t).catch(e=>{if(e instanceof Gt)return hn(n,t);throw e})}Be.v2=hn;Be.v3=ln;function*Wr(n,t,e=1){t===void 0&&(t=n,n=0);for(let s=n;s<t;s+=e)yield s}function*Qr(...n){if(n.length===0)return;const t=n.map(s=>s[Symbol.iterator]()),e=t.map(s=>s.next());if(e.some(s=>s.done))throw new Error("Input contains an empty iterator.");for(let s=0;;){if(e[s].done){if(t[s]=n[s][Symbol.iterator](),e[s]=t[s].next(),++s>=t.length)return}else yield e.map(({value:i})=>i),s=0;e[s]=t[s].next()}}function Jr(n,t,e,s){if(e===0)throw new Error("slice step cannot be zero");e=e??1;const i=e<0,[r,a]=i?[-1,s-1]:[0,s];return n===null?n=i?a:r:n<0?(n+=s,n<r&&(n=r)):n>a&&(n=a),t===null?t=i?r:a:t<0?(t+=s,t<r&&(t=r)):t>a&&(t=a),[n,t,e]}function Jt(n,t,e=null){return t===void 0&&(t=n,n=null),{start:n,stop:t,step:e,indices(s){return Jr(this.start,this.stop,this.step,s)}}}function ta(){const n=[];return{add:t=>n.push(t()),onIdle:()=>Promise.all(n)}}class Ns extends Error{constructor(t){super(t),this.name="IndexError"}}function ea(n,t){throw new Ns(`too many indicies for array; expected ${t.length}, got ${n.length}`)}function sa(n){throw new Ns(`index out of bounds for dimension with length ${n}`)}function ia(){throw new Ns("only slices with step >= 1 are supported")}function na(n,t){n.length>t.length&&ea(n,t)}function ra(n,t){return n=Math.trunc(n),n<0&&(n=t+n),(n>=t||n<0)&&sa(t),n}class aa{constructor({dim_sel:t,dim_len:e,dim_chunk_len:s}){I(this,"dim_sel");I(this,"dim_len");I(this,"dim_chunk_len");I(this,"nitems");t=ra(t,e),this.dim_sel=t,this.dim_len=e,this.dim_chunk_len=s,this.nitems=1}*[Symbol.iterator](){const t=Math.floor(this.dim_sel/this.dim_chunk_len),e=t*this.dim_chunk_len,s=this.dim_sel-e;yield{dim_chunk_ix:t,dim_chunk_sel:s}}}class bi{constructor({dim_sel:t,dim_len:e,dim_chunk_len:s}){I(this,"start");I(this,"stop");I(this,"step");I(this,"dim_len");I(this,"dim_chunk_len");I(this,"nitems");I(this,"nchunks");const[i,r,a]=t.indices(e);this.start=i,this.stop=r,this.step=a,this.step<1&&ia(),this.dim_len=e,this.dim_chunk_len=s,this.nitems=Math.max(0,Math.ceil((this.stop-this.start)/this.step)),this.nchunks=Math.ceil(this.dim_len/this.dim_chunk_len)}*[Symbol.iterator](){const t=Math.floor(this.start/this.dim_chunk_len),e=Math.ceil(this.stop/this.dim_chunk_len);for(const s of Wr(t,e)){const i=s*this.dim_chunk_len,r=Math.min(this.dim_len,(s+1)*this.dim_chunk_len),a=r-i;let o=0,h=0;if(this.start<i){const f=(i-this.start)%this.step;f&&(h+=this.step-f),o=Math.ceil((i-this.start)/this.step)}else h=this.start-i;const l=this.stop>r?a:this.stop-i,c=[h,l,this.step],u=Math.ceil((l-h)/this.step),d=[o,o+u,1];yield{dim_chunk_ix:s,dim_chunk_sel:c,dim_out_sel:d}}}}function oa(n,t){let e=[];return n===null?e=t.map(s=>Jt(null)):Array.isArray(n)&&(e=n.map(s=>s??Jt(null))),na(e,t),e}class ha{constructor({selection:t,shape:e,chunk_shape:s}){I(this,"dim_indexers");I(this,"shape");this.dim_indexers=oa(t,e).map((i,r)=>new(typeof i=="number"?aa:bi)({dim_sel:i,dim_len:e[r],dim_chunk_len:s[r]})),this.shape=this.dim_indexers.filter(i=>i instanceof bi).map(i=>i.nitems)}*[Symbol.iterator](){for(const t of Qr(...this.dim_indexers)){const e=t.map(i=>i.dim_chunk_ix),s=t.map(i=>"dim_out_sel"in i?{from:i.dim_chunk_sel,to:i.dim_out_sel}:{from:i.dim_chunk_sel,to:null});yield{chunk_coords:e,mapping:s}}}}function la(n,t){return"get"in n?n.get(t):n[t]}async function ca(n,t,e,s){var h;const i=Hr(n),r=new ha({selection:t,shape:n.shape,chunk_shape:n.chunks}),a=s.prepare(new i.TypedArray(r.shape.reduce((l,c)=>l*c,1)),r.shape,i.get_strides(r.shape,e.order)),o=((h=e.create_queue)==null?void 0:h.call(e))??ta();for(const{chunk_coords:l,mapping:c}of r)o.add(()=>n.getChunk(l,e.opts).then(({data:u,shape:d,stride:f})=>{const m=s.prepare(u,d,f);s.set_from_chunk(a,m,c)}).catch(u=>{if(!(u instanceof an))throw u;i.fill_value&&s.set_scalar(a,c.map(d=>d.to).filter(d=>d!==null),i.fill_value)}));return await o.onIdle(),r.shape.length===0?la(a.data,0):a}function cn(n,t=0,e){let s=e??n.length-t;return new Proxy(n,{get(i,r){let a=+r;return Number.isNaN(a)?r==="subarray"?(o,h=s)=>cn(i,t+o,h-o):r==="set"?(o,h)=>{for(let l=0;l<o.length;l++)i[t+h+l]=o[l]}:Reflect.get(i,r):i[t+a]},set(i,r,a){return i[t+Number(r)]=a,!0}})}function un(n){const t=n.constructor.bind(null,n.chars);return new Proxy(n,{get(e,s){let i=+s;return Number.isNaN(i)?s==="subarray"?(r,a=n.length)=>un(new t(e.buffer,e.byteOffset+n.BYTES_PER_ELEMENT*r,a-r)):s==="set"?(r,a)=>{for(let o=0;o<r.length;o++)e.set(a+o,r.get(o))}:s==="fill"?(r,a,o)=>{for(let h=a;h<o;h++)e.set(h,r)}:Reflect.get(e,s):e.get(i)},set(e,s,i){return e.set(Number(s),i),!0}})}function as(n){let t=n.data;return n.data instanceof Ye?t=new Uint8Array(n.data.buffer):n.data instanceof $e||n.data instanceof Xe?t=un(n.data):n.data instanceof globalThis.Array&&(t=cn(n.data)),{data:t,stride:n.stride}}function ua(n,t){return n.data instanceof Ye?t?1:0:t}const fa={prepare(n,t,e){return{data:n,shape:t,stride:e}},set_scalar(n,t,e){bs(as(n),t,ua(n,e))},set_from_chunk(n,t,e){Pe(as(n),as(t),e)}};async function da(n,t=null,e={}){return ca(n,t,e,fa)}function fn(n,t,e){return e<0&&t<n?Math.floor((n-t-1)/-e)+1:n<t?Math.floor((t-n-1)/e)+1:0}function bs(n,t,e){if(t.length===0){n.data[0]=e;return}const[s,...i]=t,[r,...a]=n.stride;if(typeof s=="number"){const u=n.data.subarray(r*s);bs({data:u,stride:a},i,e);return}const[o,h,l]=s,c=fn(o,h,l);if(i.length===0){if(l===1&&r===1)n.data.fill(e,o,o+c);else for(let u=0;u<c;u++)n.data[r*(o+l*u)]=e;return}for(let u=0;u<c;u++){const d=n.data.subarray(r*(o+l*u));bs({data:d,stride:a},i,e)}}function Pe(n,t,e){const[s,...i]=e,[r,...a]=n.stride,[o,...h]=t.stride;if(s.from===null){if(i.length===0){n.data[s.to]=t.data[0];return}Pe({data:n.data.subarray(r*s.to),stride:a},t,i);return}if(s.to===null){if(i.length===0){n.data[0]=t.data[s.from];return}let p={data:t.data.subarray(o*s.from),stride:h};Pe(n,p,i);return}const[l,c,u]=s.to,[d,f,m]=s.from,y=fn(l,c,u);if(i.length===0){if(u===1&&m===1&&r===1&&o===1)n.data.set(t.data.subarray(d,d+y),l);else for(let p=0;p<y;p++)n.data[r*(l+u*p)]=t.data[o*(d+m*p)];return}for(let p=0;p<y;p++)Pe({data:n.data.subarray(r*(l+p*u)),stride:a},{data:t.data.subarray(o*(d+p*m)),stride:h},i)}function dn(n,t,e,s={}){return t!==void 0&&e!==void 0&&(s={...s,headers:{...s.headers,Range:`bytes=${t}-${t+e-1}`}}),fetch(n,s)}function Si(n,t){const e=typeof n=="string"?new URL(n):n;e.pathname.endsWith("/")||(e.pathname+="/");const s=new URL(t.slice(1),e);return s.search=e.search,s}async function Ai(n){if(!(n.status===404||n.status===403)){if(n.status==200||n.status==206)return new Uint8Array(await n.arrayBuffer());throw new Error(`Unexpected response status ${n.status} ${n.statusText}`)}}async function ma(n,t,e,s){if(s)return fetch(n,{...e,headers:{...e.headers,Range:`bytes=-${t}`}});let i=await fetch(n,{...e,method:"HEAD"});if(!i.ok)return i;let r=i.headers.get("Content-Length"),a=Number(r);return dn(n,a-t,a,e)}var Bt,ue,fe,Ss;class ya{constructor(t,e={}){q(this,fe);I(this,"url");q(this,Bt);q(this,ue);this.url=t,B(this,Bt,e.overrides??{}),B(this,ue,e.useSuffixRequest??!1)}async get(t,e={}){let s=Si(this.url,t).href,i=await fetch(s,Qe(this,fe,Ss).call(this,e));return Ai(i)}async getRange(t,e,s={}){let i=Si(this.url,t),r=Qe(this,fe,Ss).call(this,s),a;return"suffixLength"in e?a=await ma(i,e.suffixLength,r,D(this,ue)):a=await dn(i,e.offset,e.length,r),Ai(a)}}Bt=new WeakMap,ue=new WeakMap,fe=new WeakSet,Ss=function(t){return{...D(this,Bt),...t,headers:{...D(this,Bt).headers,...t.headers}}};const Mi="request cancelled";class mn{constructor(t=10,e=5){this.allRequests=new Map,this.activeRequests=new Set,this.queue=[],this.queueLowPriority=[],this.maxActiveRequests=t,this.maxLowPriorityRequests=Math.min(t,e)}registerRequest(t,e){let s,i;const r=new Promise((o,h)=>{s=o,i=h}),a={key:t,action:e,resolve:s,reject:i,promise:r};return this.allRequests.set(t,a),a}addRequestToQueue(t,e){if(this.allRequests.has(t)){const s=this.allRequests.get(t);s&&s.timeoutId&&(clearTimeout(s.timeoutId),s.timeoutId=void 0),!this.queue.includes(t)&&!this.queueLowPriority.includes(t)&&(e?this.queueLowPriority.push(t):this.queue.push(t),this.dequeue())}}addRequest(t,e,s=!1,i=0){var a;if(this.allRequests.has(t)){const o=this.queueLowPriority.indexOf(t);o>-1&&!s?(this.queueLowPriority.splice(o,1),this.addRequestToQueue(t)):i<=0&&this.addRequestToQueue(t,s)}else{const o=this.registerRequest(t,e);if(i>0){const h=setTimeout(()=>this.addRequestToQueue(t,s),i);o.timeoutId=h}else this.addRequestToQueue(t,s)}const r=(a=this.allRequests.get(t))==null?void 0:a.promise;if(!r)throw new Error("Found no promise to return when getting stored request data.");return r}addRequests(t,e=!1,s=10){const i=[];for(let r=0;r<t.length;r++){const a=t[r],o=this.addRequest(a.key,a.requestAction,e,s*r);i.push(o)}return i}async dequeue(){const t=this.activeRequests.size;if(t>=this.maxActiveRequests||this.queue.length===0&&(t>=this.maxLowPriorityRequests||this.queueLowPriority.length===0))return;const e=this.queue.shift()??this.queueLowPriority.shift();if(!e)return;if(this.activeRequests.has(e)){this.dequeue();return}const s=this.allRequests.get(e);if(!s)return;const i=s.key;this.activeRequests.add(i),await s.action().then(s.resolve,s.reject),this.activeRequests.delete(i),this.allRequests.delete(i),this.dequeue()}cancelRequest(t,e=Mi){if(!this.allRequests.has(t))return;const s=this.allRequests.get(t);s&&(s.timeoutId&&clearTimeout(s.timeoutId),s.reject(e));const i=this.queue.indexOf(t);if(i>-1)this.queue.splice(i,1);else{const r=this.queueLowPriority.indexOf(t);r>-1&&this.queueLowPriority.splice(r,1)}this.allRequests.delete(t),this.activeRequests.delete(t)}cancelAllRequests(t=Mi){this.queue=[],this.queueLowPriority=[];for(const e of this.allRequests.keys())this.cancelRequest(e,t)}hasRequest(t){return this.allRequests.has(t)}requestRunning(t){return this.activeRequests.has(t)}}class yn{constructor(t,e){typeof t=="number"||t===void 0?this.queue=new mn(t,e):this.queue=t,this.nextSubscriberId=0,this.subscribers=new Map,this.requests=new Map}resolveAll(t,e){var i;const s=this.requests.get(t);if(s){for(const{resolve:r,subscriberId:a}of s)r(e),(i=this.subscribers.get(a))==null||i.delete(t);this.requests.delete(t)}}rejectAll(t,e){var i;const s=this.requests.get(t);if(s){for(const{reject:r,subscriberId:a}of s)r(e),(i=this.subscribers.get(a))==null||i.delete(t);this.requests.delete(t)}}addSubscriber(){const t=this.nextSubscriberId;return this.nextSubscriberId++,this.subscribers.set(t,new Map),t}addRequest(t,e,s,i,r){if(this.queue.addRequest(t,s,i,r).then(o=>this.resolveAll(t,o)).catch(o=>this.rejectAll(t,o)),this.requests.has(t)||this.requests.set(t,[]),e>=this.nextSubscriberId||e<0)throw new Error(`SubscribableRequestQueue: subscriber id ${e} has not been registered`);if(!this.subscribers.get(e))throw new Error(`SubscribableRequestQueue: subscriber id ${e} has been removed`);return new Promise((o,h)=>{var u;(u=this.requests.get(t))==null||u.push({resolve:o,reject:h,subscriberId:e});const l=this.subscribers.get(e),c=l==null?void 0:l.get(t);c?c.push(h):l==null||l.set(t,[h])})}rejectSubscription(t,e,s){e(s);const i=this.requests.get(t);if(!i)return;const r=i.findIndex(a=>a.reject===e);r>=0&&i.splice(r,1),i.length<1&&!this.queue.requestRunning(t)&&(this.queue.cancelRequest(t,s),this.requests.delete(t))}cancelRequest(t,e,s){const i=this.subscribers.get(e);if(!i)return!1;const r=i.get(t);if(!r||!r.length)return!1;for(const a of r)this.rejectSubscription(t,a,s);return i.delete(t),!0}removeSubscriber(t,e){const s=this.subscribers.get(t);if(s){for(const[i,r]of s.entries())for(const a of r)this.rejectSubscription(i,a,e);this.subscribers.delete(t)}}hasRequest(t){return this.queue.hasRequest(t)}requestRunning(t){return this.queue.requestRunning(t)}hasSubscriber(t){return this.subscribers.has(t)}isSubscribed(t,e){var s;return((s=this.subscribers.get(t))==null?void 0:s.has(e))??!1}}const zi=256;class wt{constructor(t){this.dataMinBin=0,this.dataMaxBin=0,this.maxBin=0,this.bins=new Uint32Array,this.min=0,this.max=0,this.binSize=0;const e=wt.calculateHistogram(t,zi);this.bins=e.bins,this.min=e.min,this.max=e.max,this.binSize=e.binSize;for(let i=0;i<this.bins.length;i++)if(this.bins[i]>0){this.dataMinBin=i;break}for(let i=this.bins.length-1;i>=0;i--)if(this.bins[i]>0){this.dataMaxBin=i;break}this.pixelCount=t.length,this.maxBin=1;let s=this.bins[1];for(let i=1;i<this.bins.length;i++)this.bins[i]>s&&(this.maxBin=i,s=this.bins[i])}static findBin(t,e,s,i){let r=Math.floor((t-e)/s);return r===i&&r--,r}findBinOfValue(t){return wt.findBin(t,this.min,this.binSize,zi)}getDataMin(){return this.min}getDataMax(){return this.max}getMin(){return this.dataMinBin}getMax(){return this.dataMaxBin}getNumBins(){return this.bins.length}getBin(t){return this.bins[t]}getBinRange(t){return[this.min+t*this.binSize,this.min+(t+1)*this.binSize]}findBinOfPercentile(t){const e=this.pixelCount*t;let s=0,i=0;for(s=0;s<this.bins.length&&(i+=this.bins[s],!(i>e));++s);return s}findBestFitBins(){const e=this.pixelCount/10;let s=0,i=0;for(s=1;s<this.bins.length&&(i+=this.bins[s],!(i>e));++s);const r=s;for(i=0,s=this.bins.length-1;s>=1&&(i+=this.bins[s],!(i>e));--s);return[r,s]}findAutoIJBins(){const e=this.pixelCount,s=e/10,i=e/5e3;let r=this.bins.length-1,a=1;for(let o=1;o<this.bins.length;++o)if(this.bins[o]>i&&this.bins[o]<=s){r=o;break}for(let o=this.bins.length-1;o>=1;--o)if(this.bins[o]>i&&this.bins[o]<=s){a=o;break}return a<r&&(r=0,a=255),[r,a]}findAutoMinMax(){const e=Math.floor(this.bins[this.maxBin]*.1);let s=0,i=this.bins.length-1;for(let r=1;r<this.bins.length;++r)if(this.bins[r]>e){s=r;break}for(let r=this.bins.length-1;r>=1;--r)if(this.bins[r]>e){i=r;break}return[s,i]}static calculateHistogram(t,e=1){e<1&&(e=1);let s=t[0],i=t[0];for(let o=1;o<t.length;o++)t[o]<s?s=t[o]:t[o]>i&&(i=t[o]);const r=new Uint32Array(e).fill(0),a=(i-s)/e===0?1:(i-s)/e;for(let o=0;o<t.length;o++){const h=t[o],l=wt.findBin(h,s,a,e);r[l]++}return{bins:r,min:s,max:i,binSize:a}}}const os=[[255,0,255],[255,255,255],[0,255,255]];function pa(n,t,e){let s,i,r,a=0;if(arguments.length===1){const d=n;t=d.s,e=d.v,a=d.h}else a=n;const o=Math.floor(a*6),h=a*6-o,l=e*(1-t),c=e*(1-h*t),u=e*(1-(1-h)*t);switch(o%6){case 0:s=e,i=u,r=l;break;case 1:s=c,i=e,r=l;break;case 2:s=l,i=e,r=u;break;case 3:s=l,i=c,r=e;break;case 4:s=u,i=l,r=e;break;case 5:s=e,i=l,r=c;break}return[Math.round(s*255),Math.round(i*255),Math.round(r*255)]}function ga(n){return function(){return n=Math.imul(48271,n)|0%2147483647,(n&2147483647)/2147483648}}const hs=ga(123),ve=n=>(os[n]||(os[n]=pa(hs(),hs()*.5+.5,hs()*.5+.5)),os[n]);function Pt(n,t,e){return Math.min(Math.max(t,n),e)}function ft(n,t,e){return e*(t-n)+n}function xa(n,t,e,s,i,r,a){const o=(n-t)/(e-t),l=((a-r)*o+r-s)/(i-s);return t+l*(e-t)}function _a(n,t,e,s,i,r,a){const o=(n-t)/(e-t),l=((i-s)*o+s-r)/(a-r);return t+l*(e-t)}const tt=256,ct=tt*4;function wa(n){const t=tt,e=new Uint8Array(t*4).fill(0);if(n.length===0)return e;if(n.sort((l,c)=>l.x-c.x),n.length===1){const l=Ae(n[0]),c=Pt(n[0].x,0,255);for(let u=c;u<t;++u)e[u*4+0]=l[0],e[u*4+1]=l[1],e[u*4+2]=l[2],e[u*4+3]=l[3];return e}let s=n[0],i=n[1],r=Ae(s),a=Ae(i),o=1,h=0;for(let l=0;l<t;++l){for(;l>i.x;)s=i,r=a,o++,o>=n.length?i={x:255,color:i.color,opacity:i.opacity}:i=n[o],a=Ae(i);i.x===s.x?h=1:h=(l-s.x)/(i.x-s.x),e[l*4+0]=Pt(ft(r[0],a[0],h),0,255),e[l*4+1]=Pt(ft(r[1],a[1],h),0,255),e[l*4+2]=Pt(ft(r[2],a[2],h),0,255),e[l*4+3]=Pt(ft(r[3],a[3],h),0,255)}return e}function Ae(n){return[n.color[0],n.color[1],n.color[2],Math.floor(n.opacity*255)]}const ls=(n=0,t=1)=>[{x:0,opacity:n,color:[255,255,255]},{x:255,opacity:t,color:[255,255,255]}];class ba{constructor(){this.lut=new Uint8Array(ct),this.controlPoints=[],this.createFullRange()}createFromMinMax(t,e){if(e<t){const a=e;e=t,t=a}if(t<0&&e<0)return this.controlPoints=ls(1,1),this.createFromControlPoints(this.controlPoints);if(t>=255&&e>=255)return this.controlPoints=ls(0,0),this.createFromControlPoints(this.controlPoints);const s=[];let i=0;t<0&&(i=-t/(e-t)),s.push({x:0,opacity:i,color:[255,255,255]}),t>0&&s.push({x:t,opacity:0,color:[255,255,255]}),e<255&&(e===t?s.push({x:t+.5,opacity:1,color:[255,255,255]}):s.push({x:e,opacity:1,color:[255,255,255]}));let r=1;return e>255&&(r=(255-t)/(e-t)),s.push({x:255,opacity:r,color:[255,255,255]}),this.createFromControlPoints(s)}createFullRange(){return this.controlPoints=ls(),this.createFromControlPoints(this.controlPoints)}createFromWindowLevel(t,e){const s=e-t*.5,i=e+t*.5;return this.createFromMinMax(s*255,i*255)}createFromControlPoints(t){return this.lut=wa(t),this.controlPoints=t,this}createFromEqHistogram(t){const e=[];for(let i=0;i<t.getNumBins();++i)e[i]=0;e[0]=t.getBin(0);for(let i=1;i<t.getNumBins();++i)e[i]=e[i-1]+t.getBin(i);if(e[e.length-1]-e[0]>0){const i=[{x:0,opacity:0,color:[255,255,255]}];let r=0,a=0,o=0,h=0;for(let l=1;l<tt;++l)h=o,o=Pt(Math.round(255*(e[l]-e[0])),0,255),r=o-h,r!=a&&(i.push({x:l-1,opacity:h/255,color:[255,255,255]}),a=r);return i.push({x:255,opacity:1,color:[255,255,255]}),this.createFromControlPoints(i)}else return this.createFullRange()}createLabelColors(t){const e=new Uint8Array(ct).fill(0),s=[];s.push({x:0,opacity:0,color:[0,0,0]});let i=0,r=0,a=0,o=0,h=0,l=0,c=0,u=0;for(let d=1;d<tt;++d){const f=Math.floor(d/(tt-1)*(t.getNumBins()-1));if(t.getBin(f)>0){const m=ve(f);e[d*4+0]=m[0],e[d*4+1]=m[1],e[d*4+2]=m[2],e[d*4+3]=255,h=m[0],l=m[1],c=m[2],u=1}else h=0,l=0,c=0,u=0;(h!==i||l!==r||c!==a||u!==o)&&(o===0&&s.push({x:d-.5,opacity:o,color:[i,r,a]}),s.push({x:d,opacity:u,color:[h,l,c]}),i=h,r=l,a=c,o=u)}return this.lut=e,this.controlPoints=s,this}remapDomains(t,e,s,i){this.lut=Sa(this.lut,t,e,s,i),this.controlPoints=Aa(this.controlPoints,t,e,s,i)}}function Sa(n,t,e,s,i){const r=new Uint8Array(ct);for(let a=0;a<tt;++a){let o=xa(a,0,tt-1,t,e,s,i);o<0&&(o=0),o>tt-1&&(o=tt-1);const h=Math.floor(o),l=Math.ceil(o),c=o-h;r[a*4+0]=Math.round(ft(n[h*4+0],n[l*4+0],c)),r[a*4+1]=Math.round(ft(n[h*4+1],n[l*4+1],c)),r[a*4+2]=Math.round(ft(n[h*4+2],n[l*4+2],c)),r[a*4+3]=Math.round(ft(n[h*4+3],n[l*4+3],c))}return r}function Aa(n,t,e,s,i,r=!0){if(n.length===0)return n;const a=[],o=n[0].x,h=n[n.length-1].x;for(let l=0;l<n.length;++l){const c=n[l],d={x:_a(c.x,0,tt-1,t,e,s,i),opacity:c.opacity,color:[c.color[0],c.color[1],c.color[2]]};a.push(d)}return r?Ma(a,o,h):a}function Ma(n,t,e){const i=n[0],r=n[1],a=n[n.length-2],o=n[n.length-1];return Math.abs(i.opacity-((r==null?void 0:r.opacity)??1/0))<1e-4&&(i.x<0?i.x=Math.min(0,r.x-1):t<1e-4&&(i.x=0)),Math.abs(o.opacity-((a==null?void 0:a.opacity)??1/0))<1e-4&&(o.x>255?o.x=Math.max(255,a.x+1):e>255-1e-4&&(o.x=255)),n}const Ei={int8:Int8Array,int16:Int16Array,int32:Int32Array,int64:globalThis.BigInt64Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,uint64:globalThis.BigUint64Array,float32:Float32Array,float64:Float64Array};class Ii{constructor(t){this.loaded=!1,this.dtype="uint8",this.imgData={data:new Uint8Array,width:0,height:0},this.rawMin=0,this.rawMax=255,this.dataTexture=new rs(new Uint8Array,0,0),this.lutTexture=new rs(new Uint8Array(ct),256,1,nn,ke),this.lutTexture.minFilter=this.lutTexture.magFilter=sn,this.lutTexture.generateMipmaps=!1,this.volumeData=new Uint8Array,this.name=t,this.histogram=new wt(new Uint8Array),this.dims=[0,0,0],this.lut=new ba().createFromMinMax(0,255),this.colorPalette=new Uint8Array(ct).fill(0),this.colorPaletteAlpha=0}combineLuts(t,e){const s=e||new Uint8Array(ct);if(!t)return s;const i=[t[0]/255,t[1]/255,t[2]/255];if(this.colorPaletteAlpha===1)s.set(this.colorPalette);else if(this.colorPaletteAlpha===0){s.set(this.lut.lut);for(let r=0;r<ct/4;++r)s[r*4+0]*=i[0],s[r*4+1]*=i[1],s[r*4+2]*=i[2]}else for(let r=0;r<ct/4;++r)s[r*4+0]=this.colorPalette[r*4+0]*this.colorPaletteAlpha+this.lut.lut[r*4+0]*(1-this.colorPaletteAlpha)*i[0],s[r*4+1]=this.colorPalette[r*4+1]*this.colorPaletteAlpha+this.lut.lut[r*4+1]*(1-this.colorPaletteAlpha)*i[1],s[r*4+2]=this.colorPalette[r*4+2]*this.colorPaletteAlpha+this.lut.lut[r*4+2]*(1-this.colorPaletteAlpha)*i[2],s[r*4+3]=this.colorPalette[r*4+3]*this.colorPaletteAlpha+this.lut.lut[r*4+3]*(1-this.colorPaletteAlpha);return this.lutTexture.image.data.set(s),this.lutTexture.needsUpdate=!0,s}setRawDataRange(t,e){!(this.rawMin===0&&this.rawMax===0)&&!(t===0&&e===0)&&(this.lut.remapDomains(this.rawMin,this.rawMax,t,e),this.rawMin=t,this.rawMax=e)}getHistogram(){return this.histogram}getIntensity(t,e,s){return this.volumeData[t+e*this.dims[0]+s*(this.dims[0]*this.dims[1])]}normalizeRaw(t){return(t-this.rawMin)/(this.rawMax-this.rawMin)}getIntensityFromAtlas(t,e,s){const i=this.imgData.width/this.dims[0],r=s%i,a=Math.floor(s/i),o=r*this.dims[0]+t+(a*this.dims[1]+e)*this.imgData.width;return this.imgData.data[o]}rebuildDataTexture(t,e,s){this.dataTexture&&this.dataTexture.dispose();let i=dr,r=ke,a="LUMINANCE";switch(this.dtype){case"uint8":r=ke,i=zt,a="R8UI";break;case"int8":r=or,i=zt,a="R8I";break;case"uint16":r=lr,i=zt,a="R16UI";break;case"int16":r=hr,i=zt,a="R16I";break;case"uint32":r=ur,i=zt,a="R32UI";break;case"int32":r=cr,i=zt,a="R32I";break;case"float32":r=fr,i=mr,a="R32F";break;default:console.warn("unsupported dtype for channel data",this.dtype);break}this.dataTexture=new rs(t,e,s,i,r,Ls,Nt,Nt,Ne,Ne),this.dataTexture.internalFormat=a,this.dataTexture.needsUpdate=!0}setFromAtlas(t,e,s,i,r,a,o){this.dtype=i,this.imgData={data:t,width:e,height:s},this.rebuildDataTexture(this.imgData.data,e,s),this.loaded=!0,this.histogram=new wt(t),this.setRawDataRange(r,a),this.unpackFromAtlas(o.x,o.y,o.z)}unpackFromAtlas(t,e,s){const i=this.imgData.data;this.dims=[t,e,s];const r=Ei[this.dtype];this.volumeData=new r(t*e*s);const a=this.imgData.width/t,o=this.imgData.width;let h=0,l=0,c=0,u=0,d=0;for(let f=0;f<s;++f){h=f%a,l=Math.floor(f/a),c=h*t+l*e*o;for(let m=0;m<e;++m)u=m*o,d=f*(t*e)+m*t,this.volumeData.set(i.subarray(c+u,c+u+t),d)}}setFromVolumeData(t,e,s,i,r,a,o,h,l){this.dims=[e,s,i],this.volumeData=t,this.dtype=l,this.packToAtlas(e,s,i,r,a),this.loaded=!0,this.setRawDataRange(o,h),this.histogram=new wt(this.volumeData)}packToAtlas(t,e,s,i,r){(i%t!==0||r%e!==0||i/t*(r/e)<s)&&(console.log("ERROR - atlas and volume dims are inconsistent"),console.log(i,r,t,e,s));const a=Ei[this.dtype];this.imgData={width:i,height:r,data:new a(i*r)},this.imgData.data.fill(0);const o=this.imgData.data,h=t,l=e,c=s,u=this.imgData.width/h,d=this.imgData.width;let f=0,m=0,y=0,p=0,g=0;for(let x=0;x<c;++x){f=x%u,m=Math.floor(x/u),y=f*h+m*l*d;for(let w=0;w<l;++w)p=w*d,g=x*(h*l)+w*h,o.set(this.volumeData.subarray(g,g+h),y+p)}this.rebuildDataTexture(this.imgData.data,i,r)}setLut(t){this.lut=t}setColorPalette(t){this.colorPalette=t}setColorPaletteAlpha(t){this.colorPaletteAlpha=t}}function Ti(n){return new b(n.shape[4],n.shape[3],n.shape[2])}function za(n){return new b(n.spacing[4],n.spacing[3],n.spacing[2])}function pn(){return{name:"",atlasTileDims:[1,1],subregionSize:[1,1,1],subregionOffset:[0,0,0],combinedNumChannels:1,channelNames:["0"],channelColors:[[255,255,255]],multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,1,1,1,1],spacing:[1,1,1,1,1],spaceUnit:"",timeUnit:"",dataType:"uint8"}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}}}class Ze{constructor(t){this.imageInfo=t||pn()}get currentLevelDims(){return this.imageInfo.multiscaleLevelDims[this.imageInfo.multiscaleLevel]}get numChannels(){return this.imageInfo.combinedNumChannels}get originalSize(){return Ti(this.imageInfo.multiscaleLevelDims[0])}get volumeSize(){return Ti(this.currentLevelDims)}get physicalPixelSize(){return za(this.imageInfo.multiscaleLevelDims[0])}get spatialUnit(){return this.imageInfo.multiscaleLevelDims[0].spaceUnit}get times(){return this.currentLevelDims.shape[0]}get timeScale(){return this.currentLevelDims.spacing[0]}get timeUnit(){return this.currentLevelDims.timeUnit}get numMultiscaleLevels(){return this.imageInfo.multiscaleLevelDims.length}get channelNames(){return this.imageInfo.channelNames}get channelColors(){return this.imageInfo.channelColors}get subregionSize(){return new b(...this.imageInfo.subregionSize)}get subregionOffset(){return new b(...this.imageInfo.subregionOffset)}get multiscaleLevel(){return this.imageInfo.multiscaleLevel}get atlasTileDims(){return new xt(...this.imageInfo.atlasTileDims)}get transform(){return{translation:new b(...this.imageInfo.transform.translation),rotation:new b(...this.imageInfo.transform.rotation),scale:new b(...this.imageInfo.transform.scale)}}}function Ea(n){const{atlasTileDims:t}=n,e=n.multiscaleLevelDims[n.multiscaleLevel];return[t[0]*e.shape[4],t[1]*e.shape[3]]}const ee=4096,Me={angstrom:"",day:"d",foot:"ft",hour:"h",inch:"in",meter:"m",micron:"m",mile:"mi",minute:"min",parsec:"pc",second:"s",yard:"yd"},Ia=["meter","second"],Ci={micro:"",deca:"da"};function Di(n){if(n===void 0)return null;if(Me[n])return Me[n];const t=Ia.find(e=>n.endsWith(e));if(t){const e=n.substring(0,n.length-t.length);return Ci[e]?Ci[e]+Me[t]:(e.endsWith("a")?e[0].toUpperCase():e[0])+Me[t]}return null}function se(n,t,e){let s=1,i=n,r=i*t/(s*e),a=s,o=i;for(;r>1;)a=s,o=i,i-=1,s=Math.ceil(n/i),r=i*t/(s*e);return new xt(a,o)}function gn(n,t=ee){const e=n[2],s=n[1],i=n[0],r=Math.floor(t/e),a=Math.floor(t/s);return r*a>=i}function Ta(n,t=ee){if(n.length<=1)return 0;for(let e=0;e<n.length;++e)if(gn(n[e],t))return e}const cs=n=>Math.max(Math.ceil(n),1),Ca=(n,[t,e,s])=>[cs(t*n.z),cs(e*n.y),cs(s*n.x)];function Da(n,t){const e=n.getSize(new b);return t.map(s=>Ca(e,s))}function xn(n,t){if(n.useExplicitLevel&&n.multiscaleLevel!==void 0)return Math.max(0,Math.min(t.length-1,n.multiscaleLevel));let e=Ta(t,n.maxAtlasEdge);if(e!==void 0&&(e=Math.max(e+(n.scaleLevelBias??0),n.multiscaleLevel??0),e=Math.max(0,Math.min(t.length-1,e)),gn(t[e],n.maxAtlasEdge)))return e;e===void 0&&(e=t.length-1);const s=t[e];return console.error(`Volume is too large; no multiscale level found that fits in preferred memory footprint. Selected level ${e}  has dimensions `,s,`. Max atlas edge allowed is ${n.maxAtlasEdge}.`),console.log("All available levels: ",t),e}function Ri(n,t){const e=Da(n.subregion,t);return xn(n,e)}function Li(n,t){const e=n.min.clone().multiply(t).floor(),s=n.max.clone().multiply(t).ceil();return e.x===s.x&&e.x<t.x&&(s.x+=1),e.y===s.y&&e.y<t.y&&(s.y+=1),e.z===s.z&&e.z<t.z&&(s.z+=1),new et(e,s)}function Oi(n,t){const e=t.getSize(new b),s=n.min.clone().multiply(e).add(t.min),i=n.max.clone().multiply(e).add(t.min);return new et(s,i)}function Ra(n){for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t))return!1;return!0}function La(n){const t=new Ze(n),e=t.volumeSize.clone().multiply(t.physicalPixelSize),s={};return s.Dimensions={...t.subregionSize},s["Original dimensions"]={...t.originalSize},s["Physical size"]={x:e.x+t.spatialUnit,y:e.y+t.spatialUnit,z:e.z+t.spatialUnit},s["Physical size per pixel"]={x:t.physicalPixelSize.x+t.spatialUnit,y:t.physicalPixelSize.y+t.spatialUnit,z:t.physicalPixelSize.z+t.spatialUnit},s["Multiresolution levels"]=n.multiscaleLevelDims,s.Channels=n.combinedNumChannels,s["Time series frames"]=t.times||1,n.userData&&!Ra(n.userData)&&(s["User data"]=n.userData),s}class Oa{constructor(t=pn(),e=new _n,s){if(this.loaded=!1,this.imageInfo=new Ze(t),this.name=t.name,this.loadSpec={multiscaleLevel:0,scaleLevelBias:0,maxAtlasEdge:ee,channels:Array.from({length:this.imageInfo.numChannels},(i,r)=>r),...e},this.loadSpecRequired={...this.loadSpec,channels:this.loadSpec.channels.slice(),subregion:this.loadSpec.subregion.clone()},this.loader=s,this.imageMetadata={},this.normRegionSize=new b(1,1,1),this.normRegionOffset=new b(0,0,0),this.physicalSize=new b(1,1,1),this.physicalScale=1,this.normPhysicalSize=new b(1,1,1),this.physicalPixelSize=this.imageInfo.physicalPixelSize,this.tickMarkPhysicalLength=1,this.setVoxelSize(this.physicalPixelSize),this.numChannels=this.imageInfo.numChannels,this.channelNames=this.imageInfo.channelNames.slice(),this.channelColorsDefault=this.imageInfo.channelColors?this.imageInfo.channelColors.slice():this.channelNames.map((i,r)=>ve(r)),this.channelColorsDefault.length<this.imageInfo.numChannels)for(let i=this.channelColorsDefault.length-1;i<this.imageInfo.numChannels;++i)this.channelColorsDefault[i]=ve(i);this.channels=[];for(let i=0;i<this.imageInfo.numChannels;++i){const r=new Ii(this.channelNames[i]);this.channels.push(r),r.dims=this.imageInfo.subregionSize.toArray()}this.physicalUnitSymbol=this.imageInfo.spatialUnit,this.volumeDataObservers=[]}setUnloaded(){this.loaded=!1,this.channels.forEach(t=>{t.loaded=!1})}isLoaded(){return this.loaded}updateDimensions(){const{volumeSize:t,subregionSize:e,subregionOffset:s}=this.imageInfo;this.setVoxelSize(this.physicalPixelSize),this.normRegionSize=e.clone().divide(t),this.normRegionOffset=s.clone().divide(t)}mustLoadNewData(){return this.loadSpec.useExplicitLevel!==this.loadSpecRequired.useExplicitLevel||this.loadSpec.time!==this.loadSpecRequired.time||!this.loadSpec.subregion.containsBox(this.loadSpecRequired.subregion)||this.loadSpecRequired.channels.some(t=>!this.loadSpec.channels.includes(t))}mayLoadNewScaleLevel(){return!this.loadSpec.subregion.equals(this.loadSpecRequired.subregion)||this.loadSpecRequired.maxAtlasEdge!==this.loadSpec.maxAtlasEdge||this.loadSpecRequired.multiscaleLevel!==this.loadSpec.multiscaleLevel||this.loadSpecRequired.scaleLevelBias!==this.loadSpec.scaleLevelBias}async updateRequiredData(t,e){this.loadSpecRequired={...this.loadSpecRequired,...t};let s=this.mustLoadNewData();if(!s&&this.mayLoadNewScaleLevel()){const i=await this.loadScaleLevelDims();if(i){const r=i.map(({shape:o})=>[o[2],o[3],o[4]]),a=xn(this.loadSpecRequired,r);s=this.imageInfo.multiscaleLevel!==a}}s&&this.loadNewData(e)}async loadScaleLevelDims(){var t;try{return await((t=this.loader)==null?void 0:t.loadDims(this.loadSpecRequired))}catch(e){this.volumeDataObservers.forEach(s=>s.onVolumeLoadError(this,e));return}}async loadNewData(t){var e;this.setUnloaded(),this.loadSpec={...this.loadSpecRequired,subregion:this.loadSpecRequired.subregion.clone()};try{await((e=this.loader)==null?void 0:e.loadVolumeData(this,void 0,t))}catch(s){throw this.volumeDataObservers.forEach(i=>i.onVolumeLoadError(this,s)),s}}setVoxelSize(t){t.x=t.x>0?t.x:1,t.y=t.y>0?t.y:1,t.z=t.z>0?t.z:1,this.physicalPixelSize=t,this.physicalSize=this.imageInfo.originalSize.clone().multiply(this.physicalPixelSize),this.physicalScale=Math.max(this.physicalSize.x,this.physicalSize.y,this.physicalSize.z),this.normPhysicalSize=this.physicalSize.clone().divideScalar(this.physicalScale),this.tickMarkPhysicalLength=10**Math.floor(Math.log10(this.physicalScale/2))}setUnitSymbol(t){this.physicalUnitSymbol=t}getContentCenter(){return this.normRegionSize.clone().divideScalar(2).add(this.normRegionOffset).subScalar(.5).multiply(this.normPhysicalSize)}cleanup(){}getChannel(t){return this.channels[t]}onChannelLoaded(t){this.loadSpec.channels.every(e=>this.channels[e].loaded)&&(this.loaded=!0),t.forEach(e=>{var s;return(s=this.channelLoadCallback)==null?void 0:s.call(this,this,e)}),this.volumeDataObservers.forEach(e=>e.onVolumeData(this,t))}setChannelDataFromAtlas(t,e,s,i,r,a="uint8"){this.channels[t].setFromAtlas(e,s,i,a,r[0],r[1],this.imageInfo.subregionSize),this.onChannelLoaded([t])}setChannelDataFromVolume(t,e,s,i="uint8"){const{subregionSize:r,atlasTileDims:a}=this.imageInfo;this.channels[t].setFromVolumeData(e,r.x,r.y,r.z,a.x*r.x,a.y*r.y,s[0],s[1],i),this.onChannelLoaded([t])}appendEmptyChannel(t,e){const s=this.imageInfo.numChannels,i=t||"channel_"+s,r=e||ve(s);this.numChannels+=1,this.channelNames.push(i),this.channelColorsDefault.push(r),this.channels.push(new Ii(i));for(let a=0;a<this.volumeDataObservers.length;++a)this.volumeDataObservers[a].onVolumeChannelAdded(this,s);return s}getIntensity(t,e,s,i){return this.channels[t].getIntensity(e,s,i)}getHistogram(t){return this.channels[t].getHistogram()}setLut(t,e){this.channels[t].setLut(e)}setColorPalette(t,e){this.channels[t].setColorPalette(e)}setColorPaletteAlpha(t,e){this.channels[t].setColorPaletteAlpha(e)}getRotation(){return this.imageInfo.transform.rotation.toArray()}getTranslation(){return this.voxelsToWorldSpace(this.imageInfo.transform.translation.toArray())}voxelsToWorldSpace(t){const e=1/Math.max(this.physicalSize.x,Math.max(this.physicalSize.y,this.physicalSize.z));return new b().fromArray(t).multiply(this.physicalPixelSize).multiplyScalar(e).toArray()}addVolumeDataObserver(t){this.volumeDataObservers.push(t)}removeVolumeDataObserver(t){if(t){const e=this.volumeDataObservers.indexOf(t);e!==-1&&this.volumeDataObservers.splice(e,1)}}removeAllVolumeDataObservers(){this.volumeDataObservers=[]}}class _n{constructor(){this.time=0,this.subregion=new et(new b(0,0,0),new b(1,1,1)),this.useExplicitLevel=!1}}class je{setPrefetchPriority(t){}syncMultichannelLoading(t){}updateFetchOptions(t){}async createVolume(t,e){const{imageInfo:s,loadSpec:i}=await this.createImageInfo(t),r=new Oa(s,i,this);return r.channelLoadCallback=e,r.imageMetadata=La(s),r}async loadVolumeData(t,e,s){const i=(o,h)=>{o&&(t.imageInfo=new Ze(o),t.updateDimensions()),t.loadSpec={...h,...a}},r=(o,h,l,c,u)=>{for(let d=0;d<o.length;d++){const f=o[d],m=h[d],y=l[d],p=c[d];u?t.setChannelDataFromAtlas(f,y,u[0],u[1],p,m):t.setChannelDataFromVolume(f,y,p,m),s==null||s(t,f)}},a={...t.loadSpec,...e};return this.loadRawChannelData(t.imageInfo.imageInfo,a,i,r)}}const ka=n=>n.every(t=>t===n[0]),Pa=(n,t,e)=>{for(let s=0;s<e;s++)n.push(t)},ze=n=>{const t=n>>1;return t+ +(t!==0)};function Ee(n,t){n<t[0]&&(t[0]=n),n>t[1]&&(t[1]=n)}class qe{constructor(t,e,s,i,r=!1){const a=[[1/0,-1/0],[1/0,-1/0],[1/0,-1/0],[1/0,-1/0]];for(const o of t)Ee(o[0],a[0]),Ee(o[2],a[1]),Ee(o[3],a[2]),Ee(o[4],a[3]);this.directionStates=[],this.priorityDirectionStates=[];for(const[o,h]of a.flat().entries()){const l=o>>1,c=l+ +(l!==0);let u;if(o&1){const f=s.map(m=>Math.min(h+e[l],m[c]-1));if(ka(f))u=f[0];else{u=[];for(const[m,y]of f.entries())Pa(u,y,s[m][1])}}else u=Math.max(h-e[l],0);const d={direction:o,start:h,end:u,chunks:[]};i&&i.includes(o)?this.priorityDirectionStates.push(d):r||this.directionStates.push(d)}for(const o of t){for(const h of this.directionStates)o[ze(h.direction)]===h.start&&h.chunks.push(o);for(const h of this.priorityDirectionStates)o[ze(h.direction)]===h.start&&h.chunks.push(o)}}static*iterateDirections(t){let e=1;for(;t.length>0;){t=t.filter(s=>{const i=Array.isArray(s.end)?Math.max(...s.end):s.end;return s.direction&1?s.start+e<=i:s.start-e>=i});for(const s of t){const i=e*(s.direction&1?1:-1);for(const r of s.chunks){if(Array.isArray(s.end)&&r[ze(s.direction)]+i>s.end[r[1]])continue;const a=r.slice();a[ze(s.direction)]+=i,yield a}}e+=1}}*[Symbol.iterator](){if(this.priorityDirectionStates.length>0)for(const t of qe.iterateDirections(this.priorityDirectionStates))yield t;for(const t of qe.iterateDirections(this.directionStates))yield t}}class va{constructor(t,e,s){this.baseStore=t,this.cache=e,this.queue=s}set(t,e){return Promise.resolve()}async getAndCache(t,e,s){const i=await this.baseStore.get(t,s);return this.cache&&i&&this.cache.insert(e,i),i}async get(t,e){const s=[".zarray",".zgroup",".zattrs","zarr.json"];if(!this.cache||s.some(o=>t.endsWith(o)))return this.baseStore.get(t,e==null?void 0:e.options);e!=null&&e.reportKey&&e.reportKey(t,e.subscriber);let i=this.baseStore.url??"";i!==""&&!(i instanceof URL)&&!i.endsWith("/")&&(i+="/");const r=i+t.slice(1),a=this.cache.get(r);return a?new Uint8Array(a):this.queue&&e?this.queue.addRequest(r,e.subscriber,()=>this.getAndCache(t,r,e==null?void 0:e.options),e.isPrefetch):this.getAndCache(t,r,e==null?void 0:e.options)}}var O=(n=>(n.UNKNOWN="unknown",n.NOT_FOUND="not_found",n.TOO_LARGE="too_large",n.LOAD_DATA_FAILED="load_data_failed",n.INVALID_METADATA="invalid_metadata",n.INVALID_MULTI_SOURCE_ZARR="invalid_multi_source_zarr",n))(O||{});class N extends Error{constructor(t,e){super(t,e),this.name="VolumeLoadError",this.type=(e==null?void 0:e.type)??"unknown"}}Ve.set("NodeNotFoundError",Gt);Ve.set("KeyError",an);Ve.set("VolumeLoadError",N);function Ut(n="Unknown error occurred while loading volume data",t="unknown",e){return s=>{if(e!==void 0&&s===e)return s;throw s instanceof N?s:(console.log(`Error loading volume data: ${s}`),new N(n,{type:t,cause:s}))}}function Na(n){var e;if((e=n.omeroMetadata)!=null&&e.channels)return n.omeroMetadata.channels.map(({label:s},i)=>s??`Channel ${i+n.channelOffset}`);const t=n.scaleLevels[0].shape[n.axesTCZYX[1]];return Array.from({length:t},(s,i)=>`Channel ${i+n.channelOffset}`)}const wn=([n,t,e])=>2+ +(n>-1)+ +(t>-1)+ +(e>-1);function Ua(n){const t=[-1,-1,-1,-1,-1],e=["t","c","z","y","x"];n.forEach((i,r)=>{const a=e.indexOf(i.name);if(a>-1)t[a]=r;else throw new N(`Unrecognized axis in zarr: ${i.name}`,{type:O.INVALID_METADATA})});const s=t[4]===-1;if(s||t[3]===-1)throw new N(`Did not find ${s?"an X":"a Y"} axis in zarr`,{type:O.INVALID_METADATA});return t}function Fa(n,t){const e=wn(t),s=Array(e);return t.forEach((i,r)=>{if(i>=0){if(i>=e)throw new N(`Unexpected axis index in zarr: ${i}`,{type:O.INVALID_METADATA});s[i]=n[r]}}),s}function bn(n,t,e){const s=[e,e,e,e,e];return t.forEach((i,r)=>{if(i>=0){if(i>=n.length)throw new N(`Unexpected axis index in zarr: ${i}`,{type:O.INVALID_METADATA});s[r]=n[i]}}),s}function As(n,t){const e=n.coordinateTransformations;if(e===void 0)return console.warn("WARNING: OMEZarrLoader: no coordinate transformations for scale level."),[1,1,1,1,1];const s=a=>a.type==="scale",i=e.find(s);if(!i)return console.warn('WARNING: OMEZarrLoader: no coordinate transformation of type "scale" for scale level.'),[1,1,1,1,1];const r=i.scale.slice();return bn(r,t,1)}function ki(n,t,e,s){const i=t[2]>-1?n.shape[t[2]]:1,r=s[2]>-1?e.shape[s[2]]:1,a=i-r,o=n.shape[t[3]]-e.shape[s[3]],h=n.shape[t[4]]-e.shape[s[4]];return a===0&&o===0&&h===0?0:a<=0&&o<=0&&h<=0?-1:a>=0&&o>=0&&h>=0?1:void 0}const Ba=1e-5,us=(n,t)=>Math.abs(n-t)<Ba;function qa(n,t,e,s){const i=As(n.multiscaleMetadata.datasets[t],n.axesTCZYX),r=As(e.multiscaleMetadata.datasets[s],e.axesTCZYX);return us(i[2],r[2])&&us(i[3],r[3])&&us(i[4],r[4])}function Va(n){if(n.length<2)return;const t=Array.from({length:n.length},()=>[]),e=Array.from({length:n.length},()=>[]),s=new Array(n.length).fill(0);for(;s.every((i,r)=>i<n[r].scaleLevels.length);){let i=!0,r=0,a=n[0],o=a.scaleLevels[s[0]];for(let h=1;h<n.length;h++){const l=n[h],c=l.scaleLevels[s[h]],u=ki(o,a.axesTCZYX,c,l.axesTCZYX);if(u)i=!1,u>0&&(r=h,a=l,o=c);else{if(u===void 0)throw new N("Incompatible zarr arrays: pixel dimensions are mismatched",{type:O.INVALID_MULTI_SOURCE_ZARR});qa(a,s[r],l,s[h])||console.warn("Incompatible zarr arrays: scale levels of equal size have different scale transformations");const d=a.axesTCZYX[0]>-1?o.shape[a.axesTCZYX[0]]:1,f=l.axesTCZYX[0]>-1?c.shape[l.axesTCZYX[0]]:1;d!==f&&console.warn(`Incompatible zarr arrays: different numbers of timesteps: ${d} vs ${f}`)}}if(i)for(let h=0;h<s.length;h++){const l=n[h],c=s[h];t[h].push(l.scaleLevels[c]),e[h].push(l.multiscaleMetadata.datasets[c]),s[h]+=1}else for(const[h,l]of s.entries()){const c=n[h],u=c.scaleLevels[l];ki(o,a.axesTCZYX,u,c.axesTCZYX)!==0&&(s[h]+=1)}}if(n[0].scaleLevels.length===0)throw new N("Incompatible zarr arrays: no sets of scale levels found that matched in all sources",{type:O.INVALID_MULTI_SOURCE_ZARR});for(let i=0;i<n.length;i++)n[i].scaleLevels=t[i],n[i].multiscaleMetadata.datasets=e[i]}function Sn(n,t){return typeof n=="object"&&n!==null&&t in n}function Kt(n,t,e="zarr"){if(!Sn(n,t))throw new N(`${e} metadata is missing required entry "${t}"`,{type:O.INVALID_METADATA})}function fs(n,t,e="zarr"){if(!Array.isArray(n[t]))throw new N(`${e} metadata entry "${t}" is not an array`,{type:O.INVALID_METADATA})}function Ga(n,t=0,e="zarr"){Kt(n,"multiscales",e),fs(n,"multiscales",e);const s=n.multiscales[t];if(!s)throw new N(`${e} metadata does not have requested multiscale level ${t}`,{type:O.INVALID_METADATA});const i=Sn(s,"name")?` ("${s.name})`:"",r=`${e} multiscale ${t}${i}`;Kt(s,"axes",r),fs(s,"axes",r),s.axes.forEach((a,o)=>Kt(a,"name",`${r} axis ${o}`)),Kt(s,"datasets",e),fs(s,"datasets",e),s.datasets.forEach((a,o)=>Kt(a,"path",`${r} dataset ${o}`))}const Wt="chunk request cancelled";function Ya(n,t){let e=n[0],s=n[0];for(let i=0;i<n.length;i++){const r=n[i];r<e&&(e=r),r>s&&(s=r)}if(t==="float64"){const i=new Float32Array(n.length);for(let r=0;r<n.length;r++)i[r]=n[r];t="float32",n=i}return{data:n,dtype:t,min:e,max:s}}const $a={maxPrefetchDistance:[5,5,5,5],maxPrefetchChunks:30};class Us extends je{constructor(t,e,s=$a,i=[]){super(),this.sources=t,this.requestQueue=e,this.fetchOptions=s,this.priorityDirections=i,this.syncChannels=!1}static async createLoader(t,e=0,s,i,r){var d;i||(i=new yn(r==null?void 0:r.concurrencyLimit,r==null?void 0:r.prefetchConcurrencyLimit));const a=Array.isArray(t)?t:[t],o=Array.isArray(e)?e:[e],h=a.map(async(f,m)=>{var P;const y=new va(new ya(f),s,i),p=Xr(y),g=await Be(p,{kind:"group"}).catch(Ut(`Failed to open OME-Zarr data at ${f}`,O.NOT_FOUND));let x=o[Math.min(m,o.length-1)];x>((P=g.attrs.multiscales)==null?void 0:P.length)&&(console.warn(`WARNING: OMEZarrLoader: scene ${x} is invalid. Using scene 0.`),x=0),Ga(g.attrs,x,a.length>1?`Zarr source ${m}`:"Zarr");const{multiscales:w,omero:S}=g.attrs,_=w[x],A=_.datasets.map(({path:U})=>Be(p.resolve(U),{kind:"array"}).catch(Ut(`Failed to open scale level ${U} of OME-Zarr data at ${f}`,O.NOT_FOUND))),M=await Promise.all(A),E=Ua(_.axes);return{scaleLevels:M,multiscaleMetadata:_,omeroMetadata:S,axesTCZYX:E,channelOffset:0}}),l=await Promise.all(h);let c=0;for(const f of l)f.channelOffset=c,c+=((d=f.omeroMetadata)==null?void 0:d.channels.length)??f.scaleLevels[0].shape[f.axesTCZYX[1]];Va(l);const u=r!=null&&r.priorityDirections?r.priorityDirections.slice():void 0;return new Us(l,i,r,u)}getUnitSymbols(){const t=this.sources[0],e=t.axesTCZYX[4],s=t.multiscaleMetadata.axes[e].unit,i=Di(s)||s||"",r=t.axesTCZYX[0],a=r>-1?t.multiscaleMetadata.axes[r].unit:void 0,o=Di(a)||a||"";return[i,o]}getLevelShapesZYX(){const t=this.sources[0],[e,s,i]=t.axesTCZYX.slice(-3);return t.scaleLevels.map(({shape:r})=>[e===-1?1:r[e],r[s],r[i]])}getScale(t){return As(this.sources[0].multiscaleMetadata.datasets[t],this.sources[0].axesTCZYX)}orderByDimension(t,e=0){return Fa(t,this.sources[e].axesTCZYX)}orderByTCZYX(t,e,s=0){return bn(t,this.sources[s].axesTCZYX,e)}matchChannelToSource(t){const e=this.sources.length-1,s=this.sources[e],i=s.scaleLevels[0].shape[s.axesTCZYX[1]],r=s.channelOffset+i;if(t>r)throw new N(`Volume channel index ${t} out of range (${r} channels available)`,{type:O.INVALID_METADATA});const a=this.sources.findIndex(l=>l.channelOffset>t),o=a===-1?e:a-1,h=t-this.sources[o].channelOffset;return{sourceIndex:o,channelIndexInSource:h}}setPrefetchPriority(t){this.priorityDirections=t}syncMultichannelLoading(t){this.syncChannels=t}updateFetchOptions(t){this.fetchOptions={...this.fetchOptions,...t}}loadDims(t){const[e,s]=this.getUnitSymbols(),i=this.maxExtent??new et(new b(0,0,0),new b(1,1,1)),a=Oi(t.subregion,i).getSize(new b),o=[1,1,a.z,a.y,a.x],h=this.sources[0].scaleLevels.map((l,c)=>{const u=this.getScale(c);return{spaceUnit:e,timeUnit:s,shape:this.orderByTCZYX(l.shape,1).map((f,m)=>Math.max(Math.ceil(f*o[m]),1)),spacing:this.orderByTCZYX(u,1),dataType:l.dtype}});return Promise.resolve(h)}createImageInfo(t){var U;const e=this.sources[0],[s,,i,r,a]=e.axesTCZYX,o=s>-1,h=i>-1,l=Ri(t,this.getLevelShapesZYX()),c=e.scaleLevels[l].shape,[u,d]=this.getUnitSymbols(),f=this.sources[this.sources.length-1],m=f.axesTCZYX[1],y=m>-1,p=f.channelOffset+(y?f.scaleLevels[l].shape[m]:1);let g=1;if(o){g=c[s];for(let C=0;C<this.sources.length;C++){const T=this.sources[C].scaleLevels[l].shape,L=this.sources[C].axesTCZYX[0];T[L]<g&&(console.warn("The number of time points is not consistent across sources: ",T[L],g),g=T[L])}}this.maxExtent||(this.maxExtent=t.subregion.clone());const w=Li(t.subregion,new b(c[a],c[r],h?c[i]:1)).getSize(new b),S=se(w.z,w.x,w.y),_=new Map,A=this.sources.flatMap(C=>Na(C).map(L=>{const $=_.get(L);return $!==void 0?(_.set(L,$+1),`${L} (${$})`):(_.set(L,1),L)})),M=e.scaleLevels.map((C,T)=>({spaceUnit:u,timeUnit:d,shape:this.orderByTCZYX(C.shape,1),spacing:this.getScale(T),dataType:C.dtype})),E={name:((U=e.omeroMetadata)==null?void 0:U.name)||"Volume",atlasTileDims:[S.x,S.y],subregionSize:[w.x,w.y,w.z],subregionOffset:[0,0,0],combinedNumChannels:p,channelNames:A,multiscaleLevel:l,multiscaleLevelDims:M,transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},P={...t,subregion:new et(new b(0,0,0),new b(1,1,1))};return Promise.resolve({imageInfo:E,loadSpec:P})}async prefetchChunk(t,e,s){const{store:i,path:r}=t,a=r.endsWith("/")?"":"/",o=r+a+this.orderByDimension(e).join("/");await i.get(o,{subscriber:s,isPrefetch:!0}).catch(Ut(`Unable to prefetch chunk with key ${o}`,O.LOAD_DATA_FAILED,Wt))}beginPrefetch(t,e){const s=t.map(({sourceIdx:h,key:l})=>{const c=wn(this.sources[h].axesTCZYX),u=l.trim().split("/").slice(-c).filter(f=>f!=="").map(f=>parseInt(f,10)),d=this.orderByTCZYX(u,0,h);return d[1]+=this.sources[h].channelOffset,d}),i=this.sources.map(h=>{const l=h.scaleLevels[e],c=l.shape.map((u,d)=>Math.ceil(u/l.chunks[d]));return this.orderByTCZYX(c,1)}),r=new qe(s,this.fetchOptions.maxPrefetchDistance,i,this.priorityDirections,this.fetchOptions.onlyPriorityDirections),a=this.requestQueue.addSubscriber();let o=0;for(const h of r){if(o>=this.fetchOptions.maxPrefetchChunks)break;const{sourceIndex:l,channelIndexInSource:c}=this.matchChannelToSource(h[1]),u=this.sources[l].scaleLevels[e];h[1]=c,this.prefetchChunk(u,h,a),o++}this.prefetchSubscriber!==void 0&&this.requestQueue.removeSubscriber(this.prefetchSubscriber,Wt),this.prefetchSubscriber=a}updateImageInfoForLoad(t,e){const s=this.maxExtent??new et(new b(0,0,0),new b(1,1,1)),i=Oi(e.subregion,s),r=Ri({...e,subregion:i},this.getLevelShapesZYX()),a=this.sources[0].scaleLevels[r].shape,[o,h,l]=this.sources[0].axesTCZYX.slice(2),c=Li(i,new b(a[l],a[h],o===-1?1:a[o])),u=c.getSize(new b),d=se(u.z,u.x,u.y);return{...t,atlasTileDims:[d.x,d.y],subregionSize:[u.x,u.y,u.z],subregionOffset:[c.min.x,c.min.y,c.min.z],multiscaleLevel:r}}async loadRawChannelData(t,e,s,i){const r=this.syncChannels,a=this.updateImageInfoForLoad(t,e);s(a);const{combinedNumChannels:o,multiscaleLevel:h}=a,l=e.channels??Array.from({length:o},(x,w)=>w),c=this.requestQueue.addSubscriber(),u=[],d=(x,w,S)=>{S===c&&u.push({sourceIdx:x,key:w})},f=[],m=[],y=[],p=[],g=l.map(async x=>{const w=new b(...a.subregionOffset),S=w.clone().add(new b(...a.subregionSize)),{sourceIndex:_,channelIndexInSource:A}=this.matchChannelToSource(x),M=[e.time,A,Jt(w.z,S.z),Jt(w.y,S.y),Jt(w.x,S.x)],E=this.sources[_].scaleLevels[h],P=this.orderByDimension(M,_),C=await da(E,P,{opts:{subscriber:c,reportKey:(L,$)=>d(_,L,$)}}).catch(Ut("Could not load OME-Zarr volume data",O.LOAD_DATA_FAILED,Wt));if((C==null?void 0:C.data)===void 0)return;const T=Ya(C.data,E.dtype);r?(y.push(T.dtype),m.push(T.data),f.push(x),p.push([T.min,T.max])):i([x],[T.dtype],[T.data],[[T.min,T.max]])});this.loadSubscriber!==void 0&&this.requestQueue.removeSubscriber(this.loadSubscriber,Wt),this.loadSubscriber=c,this.beginPrefetch(u,h),await Promise.all(g),r&&i(f,y,m,p),this.requestQueue.removeSubscriber(c,Wt)}}var vt=(n=>(n[n.MILLISECOND=0]="MILLISECOND",n[n.SECOND=1]="SECOND",n[n.MINUTE=2]="MINUTE",n[n.HOUR=3]="HOUR",n[n.DAY=4]="DAY",n))(vt||{});const An=1e3,Mn=An*60,zn=Mn*60,Xa=zn*24;vt.MILLISECOND+"",vt.SECOND+"",vt.MINUTE+"",vt.HOUR+"",vt.DAY+"";function Ms(n){let t=n[0],e=n[0];for(let s=1;s<n.length;s++)t=Math.min(t,n[s]),e=Math.max(e,n[s]);return[t,e]}const En=n=>{const t=n.pixel_size_x*n.width/n.tile_width,e=n.pixel_size_y*n.height/n.tile_height,s=n.pixel_size_z;return[t,e,s]},Ha=n=>{var r,a;const[t,e,s]=En(n),i=((r=n.transform)==null?void 0:r.translation)??[0,0,0];return i[0]=i[0]*n.tile_width/n.width,i[1]=i[1]*n.tile_height/n.height,{name:n.name,atlasTileDims:[n.cols,n.rows],subregionSize:[n.tile_width,n.tile_height,n.tiles],subregionOffset:[0,0,0],combinedNumChannels:n.channels,channelNames:n.channel_names,channelColors:n.channel_colors,multiscaleLevel:0,multiscaleLevelDims:[{shape:[n.times||1,n.channels,n.tiles,n.tile_height,n.tile_width],spacing:[n.time_scale||1,1,s,e,t],spaceUnit:n.pixel_size_unit||"m",timeUnit:n.time_unit||"s",dataType:"uint8"}],transform:{translation:i,rotation:(a=n.transform)!=null&&a.rotation?n.transform.rotation:[0,0,0],scale:[1,1,1]},userData:{...n.userData,originalVolumeSize:[n.width,n.height,n.tiles],originalPhysicalPixelSize:[n.pixel_size_x,n.pixel_size_y,n.pixel_size_z]}}};class Fs extends je{constructor(t,e){super(),this.syncChannels=!1,Array.isArray(t)?this.urls=t:this.urls=[t],this.jsonInfo=new Array(this.urls.length),this.cache=e}async getJsonImageInfo(t){const e=this.jsonInfo[t];if(e)return e;const i=await(await fetch(this.urls[t])).json();return i.pixel_size_unit=i.pixel_size_unit||"m",i.times=i.times||this.urls.length,this.jsonInfo[t]=i,i}syncMultichannelLoading(t){this.syncChannels=t}async loadDims(t){const e=await this.getJsonImageInfo(t.time),[s,i,r]=En(e);return[{shape:[e.times||1,e.channels,e.tiles,e.tile_height,e.tile_width],spacing:[1,1,r,i,s],spaceUnit:e.pixel_size_unit??"m",dataType:"uint8",timeUnit:e.time_unit??"s"}]}async createImageInfo(t){const e=await this.getJsonImageInfo(t.time);return{imageInfo:Ha(e),loadSpec:t}}async loadRawChannelData(t,e,s,i){const r=await this.getJsonImageInfo(e.time);let a=r==null?void 0:r.images;if(!a)return;const o=e.channels;o&&(a=a.filter(({channels:f})=>f.some(m=>o.includes(m))));const h=this.urls[e.time].replace(/[^/]*$/,"");a=a.map(f=>({...f,name:h+f.name}));const l={...e,subregion:new et(new b(0,0,0),new b(1,1,1)),multiscaleLevel:0,channels:a.flatMap(({channels:f})=>f)};s(void 0,l);const[c,u]=Ea(t),d=(f,m,y,p)=>i(f,m,y,p,[c,u]);await Fs.loadVolumeAtlasData(a,d,this.cache,this.syncChannels)}static async loadVolumeAtlasData(t,e,s,i=!1){const r=[],a=[],o=[],h=[],l=t.map(async c=>{let u=!0;for(let _=0;_<Math.min(c.channels.length,4);++_){const A=c.channels[_],M=s==null?void 0:s.get(`${c.name}/${A}`);if(M){const E=new Uint8Array(M);i?(r.push(A),a.push("uint8"),o.push(E),h.push(Ms(E))):e([A],["uint8"],[E],[Ms(E)])}else{u=!1;break}}if(u)return;const f=await(await fetch(c.name,{mode:"cors"})).blob(),m=await createImageBitmap(f),p=new OffscreenCanvas(m.width,m.height).getContext("2d");if(!p){console.log("Error creating canvas 2d context for "+c.name);return}p.globalCompositeOperation="copy",p.globalAlpha=1,p.drawImage(m,0,0);const g=p.getImageData(0,0,m.width,m.height),x=[],w=m.width*m.height;for(let _=0;_<Math.min(c.channels.length,4);++_)x.push(new Uint8Array(w));const S=[];for(let _=0;_<Math.min(c.channels.length,4);++_){let A=1/0,M=-1/0;for(let E=0;E<w;E++)x[_][E]=g.data[E*4+_],A=Math.min(A,x[_][E]),M=Math.max(M,x[_][E]);S[_]=[A,M]}for(let _=0;_<Math.min(c.channels.length,4);++_){const A=c.channels[_];s==null||s.insert(`${c.name}/${A}`,x[_]),i?(r.push(A),a.push("uint8"),o.push(x[_]),h.push(S[_])):e([A],["uint8"],[x[_]],[S[_]],[m.width,m.height])}});await Promise.all(l),i&&e(r,a,o,h)}}const Za=n=>{const t=se(n.sizeZ,n.sizeX,n.sizeY);return{name:n.name,atlasTileDims:[t.x,t.y],subregionSize:[n.sizeX,n.sizeY,n.sizeZ],subregionOffset:[0,0,0],combinedNumChannels:n.sizeC,channelNames:n.channelNames,channelColors:void 0,multiscaleLevel:0,multiscaleLevelDims:[{shape:[1,n.sizeC,n.sizeZ,n.sizeY,n.sizeX],spacing:[1,1,n.physicalPixelSize[2],n.physicalPixelSize[1],n.physicalPixelSize[0]],spaceUnit:n.spatialUnit||"m",timeUnit:"s",dataType:"uint8"}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},userData:n.userData}};class ja extends je{constructor(t,e){if(super(),this.jsonInfo=e,this.data=t,this.data.shape[0]!==this.jsonInfo.sizeC||this.data.shape[1]!==this.jsonInfo.sizeZ||this.data.shape[2]!==this.jsonInfo.sizeY||this.data.shape[3]!==this.jsonInfo.sizeX)throw new Error("RawArrayLoader: data shape does not match metadata")}async loadDims(t){const e=this.jsonInfo;return[{shape:[1,e.sizeC,e.sizeZ,e.sizeY,e.sizeX],spacing:[1,1,e.physicalPixelSize[2],e.physicalPixelSize[1],e.physicalPixelSize[0]],spaceUnit:e.spatialUnit||"m",dataType:"uint8",timeUnit:"s"}]}async createImageInfo(t){return{imageInfo:Za(this.jsonInfo),loadSpec:t}}loadRawChannelData(t,e,s,i){const r=e.channels,a={...e,subregion:new et(new b(0,0,0),new b(1,1,1)),multiscaleLevel:0};s(void 0,a);for(let o=0;o<t.combinedNumChannels;++o){if(r&&r.length>0&&!r.includes(o))continue;const h=this.data.shape[3]*this.data.shape[2]*this.data.shape[1],l=new Uint8Array(this.data.buffer.buffer,o*h,h),c=Ms(l);i([o],["uint8"],[l],[c])}return Promise.resolve()}}function k(n){return(t,...e)=>Ka(n,t,e)}function Yt(n,t){return k(In(n,t).get)}const{apply:Ka,getOwnPropertyDescriptor:In,getPrototypeOf:Bs,ownKeys:Wa}=Reflect,{iterator:ye,toStringTag:Qa}=Symbol,Ja=Object,{create:qs,defineProperty:to}=Ja,eo=Array,so=eo.prototype,Tn=so[ye],io=k(Tn),Cn=ArrayBuffer,no=Cn.prototype;Yt(no,"byteLength");const Pi=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;Pi&&Yt(Pi.prototype,"byteLength");const Dn=Bs(Uint8Array);Dn.from;const F=Dn.prototype;F[ye];k(F.keys);k(F.values);k(F.entries);k(F.set);k(F.reverse);k(F.fill);k(F.copyWithin);k(F.sort);k(F.slice);k(F.subarray);Yt(F,"buffer");Yt(F,"byteOffset");Yt(F,"length");Yt(F,Qa);const ro=Uint8Array,Rn=Uint16Array,Vs=Uint32Array,ao=Float32Array,ie=Bs([][ye]()),Ln=k(ie.next),oo=k(function*(){}().next),ho=Bs(ie),lo=DataView.prototype,co=k(lo.getUint16),Gs=WeakMap,On=Gs.prototype,kn=k(On.get),uo=k(On.set),Pn=new Gs,fo=qs(null,{next:{value:function(){const t=kn(Pn,this);return Ln(t)}},[ye]:{value:function(){return this}}});function mo(n){if(n[ye]===Tn&&ie.next===Ln)return n;const t=qs(fo);return uo(Pn,t,io(n)),t}const yo=new Gs,po=qs(ho,{next:{value:function(){const t=kn(yo,this);return oo(t)},writable:!0,configurable:!0}});for(const n of Wa(ie))n!=="next"&&to(po,n,In(ie,n));const vn=new Cn(4),go=new ao(vn),xo=new Vs(vn),K=new Rn(512),W=new ro(512);for(let n=0;n<256;++n){const t=n-127;t<-24?(K[n]=0,K[n|256]=32768,W[n]=24,W[n|256]=24):t<-14?(K[n]=1024>>-t-14,K[n|256]=1024>>-t-14|32768,W[n]=-t-1,W[n|256]=-t-1):t<=15?(K[n]=t+15<<10,K[n|256]=t+15<<10|32768,W[n]=13,W[n|256]=13):t<128?(K[n]=31744,K[n|256]=64512,W[n]=24,W[n|256]=24):(K[n]=31744,K[n|256]=64512,W[n]=13,W[n|256]=13)}const Ys=new Vs(2048);for(let n=1;n<1024;++n){let t=n<<13,e=0;for(;!(t&8388608);)t<<=1,e-=8388608;t&=-8388609,e+=947912704,Ys[n]=t|e}for(let n=1024;n<2048;++n)Ys[n]=939524096+(n-1024<<13);const $t=new Vs(64);for(let n=1;n<31;++n)$t[n]=n<<23;$t[31]=1199570944;$t[32]=2147483648;for(let n=33;n<63;++n)$t[n]=2147483648+(n-32<<23);$t[63]=3347054592;const Nn=new Rn(64);for(let n=1;n<64;++n)n!==32&&(Nn[n]=1024);function _o(n){const t=n>>10;return xo[0]=Ys[Nn[t]+(n&1023)]+$t[t],go[0]}function Un(n,t,...e){return _o(co(n,t,...mo(e)))}function Fn(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Ie={exports:{}},vi;function wo(){if(vi)return Ie.exports;vi=1;function n(t,e,s){const i=s&&s.debug||!1;i&&console.log("[xml-utils] getting "+e+" in "+t);const r=typeof t=="object"?t.outer:t,a=r.slice(0,r.indexOf(">")+1),o=['"',"'"];for(let h=0;h<o.length;h++){const l=o[h],c=e+"\\="+l+"([^"+l+"]*)"+l;i&&console.log("[xml-utils] pattern:",c);const d=new RegExp(c).exec(a);if(i&&console.log("[xml-utils] match:",d),d)return d[1]}}return Ie.exports=n,Ie.exports.default=n,Ie.exports}var bo=wo(),ds=Fn(bo),Te={exports:{}},Ce={exports:{}},De={exports:{}},Ni;function So(){if(Ni)return De.exports;Ni=1;function n(t,e,s){const r=new RegExp(e).exec(t.slice(s));return r?s+r.index:-1}return De.exports=n,De.exports.default=n,De.exports}var Re={exports:{}},Ui;function Ao(){if(Ui)return Re.exports;Ui=1;function n(t,e,s){const r=new RegExp(e).exec(t.slice(s));return r?s+r.index+r[0].length-1:-1}return Re.exports=n,Re.exports.default=n,Re.exports}var Le={exports:{}},Fi;function Mo(){if(Fi)return Le.exports;Fi=1;function n(t,e){const s=new RegExp(e,"g"),i=t.match(s);return i?i.length:0}return Le.exports=n,Le.exports.default=n,Le.exports}var Bi;function zo(){if(Bi)return Ce.exports;Bi=1;const n=So(),t=Ao(),e=Mo();function s(i,r,a){const o=a&&a.debug||!1,h=!(a&&typeof a.nested===!1),l=a&&a.startIndex||0;o&&console.log("[xml-utils] starting findTagByName with",r," and ",a);const c=n(i,`<${r}[ 
>/]`,l);if(o&&console.log("[xml-utils] start:",c),c===-1)return;const u=i.slice(c+r.length);let d=t(u,"^[^<]*[ /]>",0);const f=d!==-1&&u[d-1]==="/";if(o&&console.log("[xml-utils] selfClosing:",f),f===!1)if(h){let g=0,x=1,w=0;for(;(d=t(u,"[ /]"+r+">",g))!==-1;){const S=u.substring(g,d+1);if(x+=e(S,"<"+r+`[ 
	>]`),w+=e(S,"</"+r+">"),w>=x)break;g=d}}else d=t(u,"[ /]"+r+">",0);const m=c+r.length+d+1;if(o&&console.log("[xml-utils] end:",m),m===-1)return;const y=i.slice(c,m);let p;return f?p=null:p=y.slice(y.indexOf(">")+1,y.lastIndexOf("<")),{inner:p,outer:y,start:c,end:m}}return Ce.exports=s,Ce.exports.default=s,Ce.exports}var qi;function Eo(){if(qi)return Te.exports;qi=1;const n=zo();function t(e,s,i){const r=[],a=i&&i.debug||!1,o=i&&typeof i.nested=="boolean"?i.nested:!0;let h=i&&i.startIndex||0,l;for(;l=n(e,s,{debug:a,startIndex:h});)o?h=l.start+1+s.length:h=l.end,r.push(l);return a&&console.log("findTagsByName found",r.length,"tags"),r}return Te.exports=t,Te.exports.default=t,Te.exports}var Io=Eo(),To=Fn(Io);const te={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},Q={};for(const n in te)te.hasOwnProperty(n)&&(Q[te[n]]=parseInt(n,10));const Co=[Q.BitsPerSample,Q.ExtraSamples,Q.SampleFormat,Q.StripByteCounts,Q.StripOffsets,Q.StripRowCounts,Q.TileByteCounts,Q.TileOffsets,Q.SubIFDs],ms={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},z={};for(const n in ms)ms.hasOwnProperty(n)&&(z[ms[n]]=parseInt(n,10));const G={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8},Do={Unspecified:0},kh={AddCompression:1},Ph={None:0,Deflate:1,Zstandard:2},Ro={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function Lo(n,t){const{width:e,height:s}=n,i=new Uint8Array(e*s*3);let r;for(let a=0,o=0;a<n.length;++a,o+=3)r=256-n[a]/t*256,i[o]=r,i[o+1]=r,i[o+2]=r;return i}function Oo(n,t){const{width:e,height:s}=n,i=new Uint8Array(e*s*3);let r;for(let a=0,o=0;a<n.length;++a,o+=3)r=n[a]/t*256,i[o]=r,i[o+1]=r,i[o+2]=r;return i}function ko(n,t){const{width:e,height:s}=n,i=new Uint8Array(e*s*3),r=t.length/3,a=t.length/3*2;for(let o=0,h=0;o<n.length;++o,h+=3){const l=n[o];i[h]=t[l]/65536*256,i[h+1]=t[l+r]/65536*256,i[h+2]=t[l+a]/65536*256}return i}function Po(n){const{width:t,height:e}=n,s=new Uint8Array(t*e*3);for(let i=0,r=0;i<n.length;i+=4,r+=3){const a=n[i],o=n[i+1],h=n[i+2],l=n[i+3];s[r]=255*((255-a)/256)*((255-l)/256),s[r+1]=255*((255-o)/256)*((255-l)/256),s[r+2]=255*((255-h)/256)*((255-l)/256)}return s}function vo(n){const{width:t,height:e}=n,s=new Uint8ClampedArray(t*e*3);for(let i=0,r=0;i<n.length;i+=3,r+=3){const a=n[i],o=n[i+1],h=n[i+2];s[r]=a+1.402*(h-128),s[r+1]=a-.34414*(o-128)-.71414*(h-128),s[r+2]=a+1.772*(o-128)}return s}const No=.95047,Uo=1,Fo=1.08883;function Bo(n){const{width:t,height:e}=n,s=new Uint8Array(t*e*3);for(let i=0,r=0;i<n.length;i+=3,r+=3){const a=n[i+0],o=n[i+1]<<24>>24,h=n[i+2]<<24>>24;let l=(a+16)/116,c=o/500+l,u=l-h/200,d,f,m;c=No*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),l=Uo*(l*l*l>.008856?l*l*l:(l-16/116)/7.787),u=Fo*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),d=c*3.2406+l*-1.5372+u*-.4986,f=c*-.9689+l*1.8758+u*.0415,m=c*.0557+l*-.204+u*1.057,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,m=m>.0031308?1.055*m**(1/2.4)-.055:12.92*m,s[r]=Math.max(0,Math.min(1,d))*255,s[r+1]=Math.max(0,Math.min(1,f))*255,s[r+2]=Math.max(0,Math.min(1,m))*255}return s}const Bn=new Map;function mt(n,t){Array.isArray(n)||(n=[n]),n.forEach(e=>Bn.set(e,t))}async function qo(n){const t=Bn.get(n.Compression);if(!t)throw new Error(`Unknown compression method identifier: ${n.Compression}`);const e=await t();return new e(n)}mt([void 0,1],()=>import("./raw-in9isEBO.js").then(n=>n.default));mt(5,()=>import("./lzw-_aCqfs4w.js").then(n=>n.default));mt(6,()=>{throw new Error("old style JPEG compression is not supported.")});mt(7,()=>import("./jpeg-JhJy4lL1.js").then(n=>n.default));mt([8,32946],()=>import("./deflate-Dthki0TA.js").then(n=>n.default));mt(32773,()=>import("./packbits-DDWKfGV_.js").then(n=>n.default));mt(34887,()=>import("./lerc-BITMu3sd.js").then(async n=>(await n.zstd.init(),n)).then(n=>n.default));mt(50001,()=>import("./webimage-DBgUwIbt.js").then(n=>n.default));function Ke(n,t,e,s=1){return new(Object.getPrototypeOf(n)).constructor(t*e*s)}function Vo(n,t,e,s,i){const r=t/s,a=e/i;return n.map(o=>{const h=Ke(o,s,i);for(let l=0;l<i;++l){const c=Math.min(Math.round(a*l),e-1);for(let u=0;u<s;++u){const d=Math.min(Math.round(r*u),t-1),f=o[c*t+d];h[l*s+u]=f}}return h})}function Ft(n,t,e){return(1-e)*n+e*t}function Go(n,t,e,s,i){const r=t/s,a=e/i;return n.map(o=>{const h=Ke(o,s,i);for(let l=0;l<i;++l){const c=a*l,u=Math.floor(c),d=Math.min(Math.ceil(c),e-1);for(let f=0;f<s;++f){const m=r*f,y=m%1,p=Math.floor(m),g=Math.min(Math.ceil(m),t-1),x=o[u*t+p],w=o[u*t+g],S=o[d*t+p],_=o[d*t+g],A=Ft(Ft(x,w,y),Ft(S,_,y),c%1);h[l*s+f]=A}}return h})}function Yo(n,t,e,s,i,r="nearest"){switch(r.toLowerCase()){case"nearest":return Vo(n,t,e,s,i);case"bilinear":case"linear":return Go(n,t,e,s,i);default:throw new Error(`Unsupported resampling method: '${r}'`)}}function $o(n,t,e,s,i,r){const a=t/s,o=e/i,h=Ke(n,s,i,r);for(let l=0;l<i;++l){const c=Math.min(Math.round(o*l),e-1);for(let u=0;u<s;++u){const d=Math.min(Math.round(a*u),t-1);for(let f=0;f<r;++f){const m=n[c*t*r+d*r+f];h[l*s*r+u*r+f]=m}}}return h}function Xo(n,t,e,s,i,r){const a=t/s,o=e/i,h=Ke(n,s,i,r);for(let l=0;l<i;++l){const c=o*l,u=Math.floor(c),d=Math.min(Math.ceil(c),e-1);for(let f=0;f<s;++f){const m=a*f,y=m%1,p=Math.floor(m),g=Math.min(Math.ceil(m),t-1);for(let x=0;x<r;++x){const w=n[u*t*r+p*r+x],S=n[u*t*r+g*r+x],_=n[d*t*r+p*r+x],A=n[d*t*r+g*r+x],M=Ft(Ft(w,S,y),Ft(_,A,y),c%1);h[l*s*r+f*r+x]=M}}}return h}function Ho(n,t,e,s,i,r,a="nearest"){switch(a.toLowerCase()){case"nearest":return $o(n,t,e,s,i,r);case"bilinear":case"linear":return Xo(n,t,e,s,i,r);default:throw new Error(`Unsupported resampling method: '${a}'`)}}function Zo(n,t,e){let s=0;for(let i=t;i<e;++i)s+=n[i];return s}function zs(n,t,e){switch(n){case 1:if(t<=8)return new Uint8Array(e);if(t<=16)return new Uint16Array(e);if(t<=32)return new Uint32Array(e);break;case 2:if(t===8)return new Int8Array(e);if(t===16)return new Int16Array(e);if(t===32)return new Int32Array(e);break;case 3:switch(t){case 16:case 32:return new Float32Array(e);case 64:return new Float64Array(e)}break}throw Error("Unsupported data format/bitsPerSample")}function jo(n,t){return(n===1||n===2)&&t<=32&&t%8===0?!1:!(n===3&&(t===16||t===32||t===64))}function Ko(n,t,e,s,i,r,a){const o=new DataView(n),h=e===2?a*r:a*r*s,l=e===2?1:s,c=zs(t,i,h),u=parseInt("1".repeat(i),2);if(t===1){let d;e===1?d=s*i:d=i;let f=r*d;f&7&&(f=f+7&-8);for(let m=0;m<a;++m){const y=m*f;for(let p=0;p<r;++p){const g=y+p*l*i;for(let x=0;x<l;++x){const w=g+x*i,S=(m*r+p)*l+x,_=Math.floor(w/8),A=w%8;if(A+i<=8)c[S]=o.getUint8(_)>>8-i-A&u;else if(A+i<=16)c[S]=o.getUint16(_)>>16-i-A&u;else if(A+i<=24){const M=o.getUint16(_)<<8|o.getUint8(_+2);c[S]=M>>24-i-A&u}else c[S]=o.getUint32(_)>>32-i-A&u}}}}return c.buffer}class Wo{constructor(t,e,s,i,r,a){this.fileDirectory=t,this.geoKeys=e,this.dataView=s,this.littleEndian=i,this.tiles=r?{}:null,this.isTiled=!t.StripOffsets;const o=t.PlanarConfiguration;if(this.planarConfiguration=typeof o>"u"?1:o,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=a}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(t){return this.isTiled||(t+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-t*this.getTileHeight()}getBytesPerPixel(){let t=0;for(let e=0;e<this.fileDirectory.BitsPerSample.length;++e)t+=this.getSampleByteSize(e);return t}getSampleByteSize(t){if(t>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${t} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[t]/8)}getReaderForSample(t){const e=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1,s=this.fileDirectory.BitsPerSample[t];switch(e){case 1:if(s<=8)return DataView.prototype.getUint8;if(s<=16)return DataView.prototype.getUint16;if(s<=32)return DataView.prototype.getUint32;break;case 2:if(s<=8)return DataView.prototype.getInt8;if(s<=16)return DataView.prototype.getInt16;if(s<=32)return DataView.prototype.getInt32;break;case 3:switch(s){case 16:return function(i,r){return Un(this,i,r)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(t=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[t]:1}getBitsPerSample(t=0){return this.fileDirectory.BitsPerSample[t]}getArrayForSample(t,e){const s=this.getSampleFormat(t),i=this.getBitsPerSample(t);return zs(s,i,e)}async getTileOrStrip(t,e,s,i,r){const a=Math.ceil(this.getWidth()/this.getTileWidth()),o=Math.ceil(this.getHeight()/this.getTileHeight());let h;const{tiles:l}=this;this.planarConfiguration===1?h=e*a+t:this.planarConfiguration===2&&(h=s*a*o+e*a+t);let c,u;this.isTiled?(c=this.fileDirectory.TileOffsets[h],u=this.fileDirectory.TileByteCounts[h]):(c=this.fileDirectory.StripOffsets[h],u=this.fileDirectory.StripByteCounts[h]);const d=(await this.source.fetch([{offset:c,length:u}],r))[0];let f;return l===null||!l[h]?(f=(async()=>{let m=await i.decode(this.fileDirectory,d);const y=this.getSampleFormat(),p=this.getBitsPerSample();return jo(y,p)&&(m=Ko(m,y,this.planarConfiguration,this.getSamplesPerPixel(),p,this.getTileWidth(),this.getBlockHeight(e))),m})(),l!==null&&(l[h]=f)):f=l[h],{x:t,y:e,sample:s,data:await f}}async _readRaster(t,e,s,i,r,a,o,h,l){const c=this.getTileWidth(),u=this.getTileHeight(),d=this.getWidth(),f=this.getHeight(),m=Math.max(Math.floor(t[0]/c),0),y=Math.min(Math.ceil(t[2]/c),Math.ceil(d/c)),p=Math.max(Math.floor(t[1]/u),0),g=Math.min(Math.ceil(t[3]/u),Math.ceil(f/u)),x=t[2]-t[0];let w=this.getBytesPerPixel();const S=[],_=[];for(let E=0;E<e.length;++E)this.planarConfiguration===1?S.push(Zo(this.fileDirectory.BitsPerSample,0,e[E])/8):S.push(0),_.push(this.getReaderForSample(e[E]));const A=[],{littleEndian:M}=this;for(let E=p;E<g;++E)for(let P=m;P<y;++P){let U;this.planarConfiguration===1&&(U=this.getTileOrStrip(P,E,0,r,l));for(let C=0;C<e.length;++C){const T=C,L=e[C];this.planarConfiguration===2&&(w=this.getSampleByteSize(L),U=this.getTileOrStrip(P,E,L,r,l));const $=U.then(Z=>{const St=Z.data,At=new DataView(St),at=this.getBlockHeight(Z.y),j=Z.y*u,st=Z.x*c,Mt=j+at,$n=(Z.x+1)*c,Xn=_[T],Hn=Math.min(at,at-(Mt-t[3]),f-j),Zn=Math.min(c,c-($n-t[2]),d-st);for(let Xt=Math.max(0,t[1]-j);Xt<Hn;++Xt)for(let Ht=Math.max(0,t[0]-st);Ht<Zn;++Ht){const jn=(Xt*c+Ht)*w,Qs=Xn.call(At,jn+S[T],M);let pe;i?(pe=(Xt+j-t[1])*x*e.length+(Ht+st-t[0])*e.length+T,s[pe]=Qs):(pe=(Xt+j-t[1])*x+Ht+st-t[0],s[T][pe]=Qs)}});A.push($)}}if(await Promise.all(A),a&&t[2]-t[0]!==a||o&&t[3]-t[1]!==o){let E;return i?E=Ho(s,t[2]-t[0],t[3]-t[1],a,o,e.length,h):E=Yo(s,t[2]-t[0],t[3]-t[1],a,o,h),E.width=a,E.height=o,E}return s.width=a||t[2]-t[0],s.height=o||t[3]-t[1],s}async readRasters({window:t,samples:e=[],interleave:s,pool:i=null,width:r,height:a,resampleMethod:o,fillValue:h,signal:l}={}){const c=t||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const u=c[2]-c[0],d=c[3]-c[1],f=u*d,m=this.getSamplesPerPixel();if(!e||!e.length)for(let x=0;x<m;++x)e.push(x);else for(let x=0;x<e.length;++x)if(e[x]>=m)return Promise.reject(new RangeError(`Invalid sample index '${e[x]}'.`));let y;if(s){const x=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,w=Math.max.apply(null,this.fileDirectory.BitsPerSample);y=zs(x,w,f*e.length),h&&y.fill(h)}else{y=[];for(let x=0;x<e.length;++x){const w=this.getArrayForSample(e[x],f);Array.isArray(h)&&x<h.length?w.fill(h[x]):h&&!Array.isArray(h)&&w.fill(h),y.push(w)}}const p=i||await qo(this.fileDirectory);return await this._readRaster(c,e,y,s,p,r,a,o,l)}async readRGB({window:t,interleave:e=!0,pool:s=null,width:i,height:r,resampleMethod:a,enableAlpha:o=!1,signal:h}={}){const l=t||[0,0,this.getWidth(),this.getHeight()];if(l[0]>l[2]||l[1]>l[3])throw new Error("Invalid subsets");const c=this.fileDirectory.PhotometricInterpretation;if(c===G.RGB){let g=[0,1,2];if(this.fileDirectory.ExtraSamples!==Do.Unspecified&&o){g=[];for(let x=0;x<this.fileDirectory.BitsPerSample.length;x+=1)g.push(x)}return this.readRasters({window:t,interleave:e,samples:g,pool:s,width:i,height:r,resampleMethod:a,signal:h})}let u;switch(c){case G.WhiteIsZero:case G.BlackIsZero:case G.Palette:u=[0];break;case G.CMYK:u=[0,1,2,3];break;case G.YCbCr:case G.CIELab:u=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const d={window:l,interleave:!0,samples:u,pool:s,width:i,height:r,resampleMethod:a,signal:h},{fileDirectory:f}=this,m=await this.readRasters(d),y=2**this.fileDirectory.BitsPerSample[0];let p;switch(c){case G.WhiteIsZero:p=Lo(m,y);break;case G.BlackIsZero:p=Oo(m,y);break;case G.Palette:p=ko(m,f.ColorMap);break;case G.CMYK:p=Po(m);break;case G.YCbCr:p=vo(m);break;case G.CIELab:p=Bo(m);break;default:throw new Error("Unsupported photometric interpretation.")}if(!e){const g=new Uint8Array(p.length/3),x=new Uint8Array(p.length/3),w=new Uint8Array(p.length/3);for(let S=0,_=0;S<p.length;S+=3,++_)g[_]=p[S],x[_]=p[S+1],w[_]=p[S+2];p=[g,x,w]}return p.width=m.width,p.height=m.height,p}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const t=[];for(let e=0;e<this.fileDirectory.ModelTiepoint.length;e+=6)t.push({i:this.fileDirectory.ModelTiepoint[e],j:this.fileDirectory.ModelTiepoint[e+1],k:this.fileDirectory.ModelTiepoint[e+2],x:this.fileDirectory.ModelTiepoint[e+3],y:this.fileDirectory.ModelTiepoint[e+4],z:this.fileDirectory.ModelTiepoint[e+5]});return t}getGDALMetadata(t=null){const e={};if(!this.fileDirectory.GDAL_METADATA)return null;const s=this.fileDirectory.GDAL_METADATA;let i=To(s,"Item");t===null?i=i.filter(r=>ds(r,"sample")===void 0):i=i.filter(r=>Number(ds(r,"sample"))===t);for(let r=0;r<i.length;++r){const a=i[r];e[ds(a,"name")]=a.inner}return e}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const t=this.fileDirectory.GDAL_NODATA;return Number(t.substring(0,t.length-1))}getOrigin(){const t=this.fileDirectory.ModelTiepoint,e=this.fileDirectory.ModelTransformation;if(t&&t.length===6)return[t[3],t[4],t[5]];if(e)return[e[3],e[7],e[11]];throw new Error("The image does not have an affine transformation.")}getResolution(t=null){const e=this.fileDirectory.ModelPixelScale,s=this.fileDirectory.ModelTransformation;if(e)return[e[0],-e[1],e[2]];if(s)return s[1]===0&&s[4]===0?[s[0],-s[5],s[10]]:[Math.sqrt(s[0]*s[0]+s[4]*s[4]),-Math.sqrt(s[1]*s[1]+s[5]*s[5]),s[10]];if(t){const[i,r,a]=t.getResolution();return[i*t.getWidth()/this.getWidth(),r*t.getHeight()/this.getHeight(),a*t.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(t=!1){const e=this.getHeight(),s=this.getWidth();if(this.fileDirectory.ModelTransformation&&!t){const[i,r,a,o,h,l,c,u]=this.fileDirectory.ModelTransformation,f=[[0,0],[0,e],[s,0],[s,e]].map(([p,g])=>[o+i*p+r*g,u+h*p+l*g]),m=f.map(p=>p[0]),y=f.map(p=>p[1]);return[Math.min(...m),Math.min(...y),Math.max(...m),Math.max(...y)]}else{const i=this.getOrigin(),r=this.getResolution(),a=i[0],o=i[1],h=a+r[0]*s,l=o+r[1]*e;return[Math.min(a,h),Math.min(o,l),Math.max(a,h),Math.max(o,l)]}}}class Qo{constructor(t){this._dataView=new DataView(t)}get buffer(){return this._dataView.buffer}getUint64(t,e){const s=this.getUint32(t,e),i=this.getUint32(t+4,e);let r;if(e){if(r=s+2**32*i,!Number.isSafeInteger(r))throw new Error(`${r} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return r}if(r=2**32*s+i,!Number.isSafeInteger(r))throw new Error(`${r} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return r}getInt64(t,e){let s=0;const i=(this._dataView.getUint8(t+(e?7:0))&128)>0;let r=!0;for(let a=0;a<8;a++){let o=this._dataView.getUint8(t+(e?a:7-a));i&&(r?o!==0&&(o=~(o-1)&255,r=!1):o=~o&255),s+=o*256**a}return i&&(s=-s),s}getUint8(t,e){return this._dataView.getUint8(t,e)}getInt8(t,e){return this._dataView.getInt8(t,e)}getUint16(t,e){return this._dataView.getUint16(t,e)}getInt16(t,e){return this._dataView.getInt16(t,e)}getUint32(t,e){return this._dataView.getUint32(t,e)}getInt32(t,e){return this._dataView.getInt32(t,e)}getFloat16(t,e){return Un(this._dataView,t,e)}getFloat32(t,e){return this._dataView.getFloat32(t,e)}getFloat64(t,e){return this._dataView.getFloat64(t,e)}}class Jo{constructor(t,e,s,i){this._dataView=new DataView(t),this._sliceOffset=e,this._littleEndian=s,this._bigTiff=i}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(t,e){return this.sliceOffset<=t&&this.sliceTop>=t+e}readUint8(t){return this._dataView.getUint8(t-this._sliceOffset,this._littleEndian)}readInt8(t){return this._dataView.getInt8(t-this._sliceOffset,this._littleEndian)}readUint16(t){return this._dataView.getUint16(t-this._sliceOffset,this._littleEndian)}readInt16(t){return this._dataView.getInt16(t-this._sliceOffset,this._littleEndian)}readUint32(t){return this._dataView.getUint32(t-this._sliceOffset,this._littleEndian)}readInt32(t){return this._dataView.getInt32(t-this._sliceOffset,this._littleEndian)}readFloat32(t){return this._dataView.getFloat32(t-this._sliceOffset,this._littleEndian)}readFloat64(t){return this._dataView.getFloat64(t-this._sliceOffset,this._littleEndian)}readUint64(t){const e=this.readUint32(t),s=this.readUint32(t+4);let i;if(this._littleEndian){if(i=e+2**32*s,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}if(i=2**32*e+s,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}readInt64(t){let e=0;const s=(this._dataView.getUint8(t+(this._littleEndian?7:0))&128)>0;let i=!0;for(let r=0;r<8;r++){let a=this._dataView.getUint8(t+(this._littleEndian?r:7-r));s&&(i?a!==0&&(a=~(a-1)&255,i=!1):a=~a&255),e+=a*256**r}return s&&(e=-e),e}readOffset(t){return this._bigTiff?this.readUint64(t):this.readUint32(t)}}const Vi=`\r
\r
`;function qn(n){if(typeof Object.fromEntries<"u")return Object.fromEntries(n);const t={};for(const[e,s]of n)t[e.toLowerCase()]=s;return t}function th(n){const t=n.split(`\r
`).map(e=>{const s=e.split(":").map(i=>i.trim());return s[0]=s[0].toLowerCase(),s});return qn(t)}function eh(n){const[t,...e]=n.split(";").map(i=>i.trim()),s=e.map(i=>i.split("="));return{type:t,params:qn(s)}}function Es(n){let t,e,s;return n&&([,t,e,s]=n.match(/bytes (\d+)-(\d+)\/(\d+)/),t=parseInt(t,10),e=parseInt(e,10),s=parseInt(s,10)),{start:t,end:e,total:s}}function sh(n,t){let e=null;const s=new TextDecoder("ascii"),i=[],r=`--${t}`,a=`${r}--`;for(let o=0;o<10;++o)s.decode(new Uint8Array(n,o,r.length))===r&&(e=o);if(e===null)throw new Error("Could not find initial boundary");for(;e<n.byteLength;){const o=s.decode(new Uint8Array(n,e,Math.min(r.length+1024,n.byteLength-e)));if(o.length===0||o.startsWith(a))break;if(!o.startsWith(r))throw new Error("Part does not start with boundary");const h=o.substr(r.length+2);if(h.length===0)break;const l=h.indexOf(Vi),c=th(h.substr(0,l)),{start:u,end:d,total:f}=Es(c["content-range"]),m=e+r.length+l+Vi.length,y=parseInt(d,10)+1-parseInt(u,10);i.push({headers:c,data:n.slice(m,m+y),offset:u,length:y,fileSize:f}),e=m+y+4}return i}class Vn{async fetch(t,e=void 0){return Promise.all(t.map(s=>this.fetchSlice(s,e)))}async fetchSlice(t){throw new Error(`fetching of slice ${t} not possible, not implemented`)}get fileSize(){return null}async close(){}}class ih extends Map{constructor(t={}){if(super(),!(t.maxSize&&t.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof t.maxAge=="number"&&t.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=t.maxSize,this.maxAge=t.maxAge||Number.POSITIVE_INFINITY,this.onEviction=t.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(t){if(typeof this.onEviction=="function")for(const[e,s]of t)this.onEviction(e,s.value)}_deleteIfExpired(t,e){return typeof e.expiry=="number"&&e.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(t,e.value),this.delete(t)):!1}_getOrDeleteIfExpired(t,e){if(this._deleteIfExpired(t,e)===!1)return e.value}_getItemValue(t,e){return e.expiry?this._getOrDeleteIfExpired(t,e):e.value}_peek(t,e){const s=e.get(t);return this._getItemValue(t,s)}_set(t,e){this.cache.set(t,e),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(t,e){this.oldCache.delete(t),this._set(t,e)}*_entriesAscending(){for(const t of this.oldCache){const[e,s]=t;this.cache.has(e)||this._deleteIfExpired(e,s)===!1&&(yield t)}for(const t of this.cache){const[e,s]=t;this._deleteIfExpired(e,s)===!1&&(yield t)}}get(t){if(this.cache.has(t)){const e=this.cache.get(t);return this._getItemValue(t,e)}if(this.oldCache.has(t)){const e=this.oldCache.get(t);if(this._deleteIfExpired(t,e)===!1)return this._moveToRecent(t,e),e.value}}set(t,e,{maxAge:s=this.maxAge}={}){const i=typeof s=="number"&&s!==Number.POSITIVE_INFINITY?Date.now()+s:void 0;return this.cache.has(t)?this.cache.set(t,{value:e,expiry:i}):this._set(t,{value:e,expiry:i}),this}has(t){return this.cache.has(t)?!this._deleteIfExpired(t,this.cache.get(t)):this.oldCache.has(t)?!this._deleteIfExpired(t,this.oldCache.get(t)):!1}peek(t){if(this.cache.has(t))return this._peek(t,this.cache);if(this.oldCache.has(t))return this._peek(t,this.oldCache)}delete(t){const e=this.cache.delete(t);return e&&this._size--,this.oldCache.delete(t)||e}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(t){if(!(t&&t>0))throw new TypeError("`maxSize` must be a number greater than 0");const e=[...this._entriesAscending()],s=e.length-t;s<0?(this.cache=new Map(e),this.oldCache=new Map,this._size=e.length):(s>0&&this._emitEvictions(e.slice(0,s)),this.oldCache=new Map(e.slice(s)),this.cache=new Map,this._size=0),this.maxSize=t}*keys(){for(const[t]of this)yield t}*values(){for(const[,t]of this)yield t}*[Symbol.iterator](){for(const t of this.cache){const[e,s]=t;this._deleteIfExpired(e,s)===!1&&(yield[e,s.value])}for(const t of this.oldCache){const[e,s]=t;this.cache.has(e)||this._deleteIfExpired(e,s)===!1&&(yield[e,s.value])}}*entriesDescending(){let t=[...this.cache];for(let e=t.length-1;e>=0;--e){const s=t[e],[i,r]=s;this._deleteIfExpired(i,r)===!1&&(yield[i,r.value])}t=[...this.oldCache];for(let e=t.length-1;e>=0;--e){const s=t[e],[i,r]=s;this.cache.has(i)||this._deleteIfExpired(i,r)===!1&&(yield[i,r.value])}}*entriesAscending(){for(const[t,e]of this._entriesAscending())yield[t,e.value]}get size(){if(!this._size)return this.oldCache.size;let t=0;for(const e of this.oldCache.keys())this.cache.has(e)||t++;return Math.min(this._size+t,this.maxSize)}entries(){return this.entriesAscending()}forEach(t,e=this){for(const[s,i]of this.entriesAscending())t.call(e,i,s,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function nh(n){return new Promise(t=>setTimeout(t,n))}function rh(n,t){const e=Array.isArray(n)?n:Array.from(n),s=Array.isArray(t)?t:Array.from(t);return e.map((i,r)=>[i,s[r]])}class Vt extends Error{constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,Vt),this.name="AbortError"}}class ah extends Error{constructor(t,e){super(e),this.errors=t,this.message=e,this.name="AggregateError"}}const oh=ah;class hh{constructor(t,e,s=null){this.offset=t,this.length=e,this.data=s}get top(){return this.offset+this.length}}class Gi{constructor(t,e,s){this.offset=t,this.length=e,this.blockIds=s}}class lh extends Vn{constructor(t,{blockSize:e=65536,cacheSize:s=100}={}){super(),this.source=t,this.blockSize=e,this.blockCache=new ih({maxSize:s,onEviction:(i,r)=>{this.evictedBlocks.set(i,r)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(t,e){const s=[],i=[],r=[];this.evictedBlocks.clear();for(const{offset:d,length:f}of t){let m=d+f;const{fileSize:y}=this;y!==null&&(m=Math.min(m,y));const p=Math.floor(d/this.blockSize)*this.blockSize;for(let g=p;g<m;g+=this.blockSize){const x=Math.floor(g/this.blockSize);!this.blockCache.has(x)&&!this.blockRequests.has(x)&&(this.blockIdsToFetch.add(x),i.push(x)),this.blockRequests.has(x)&&s.push(this.blockRequests.get(x)),r.push(x)}}await nh(),this.fetchBlocks(e);const a=[];for(const d of i)this.blockRequests.has(d)&&a.push(this.blockRequests.get(d));await Promise.allSettled(s),await Promise.allSettled(a);const o=[],h=r.filter(d=>this.abortedBlockIds.has(d)||!this.blockCache.has(d));if(h.forEach(d=>this.blockIdsToFetch.add(d)),h.length>0&&e&&!e.aborted){this.fetchBlocks(null);for(const d of h){const f=this.blockRequests.get(d);if(!f)throw new Error(`Block ${d} is not in the block requests`);o.push(f)}await Promise.allSettled(o)}if(e&&e.aborted)throw new Vt("Request was aborted");const l=r.map(d=>this.blockCache.get(d)||this.evictedBlocks.get(d)),c=l.filter(d=>!d);if(c.length)throw new oh(c,"Request failed");const u=new Map(rh(r,l));return this.readSliceData(t,u)}fetchBlocks(t){if(this.blockIdsToFetch.size>0){const e=this.groupBlocks(this.blockIdsToFetch),s=this.source.fetch(e,t);for(let i=0;i<e.length;++i){const r=e[i];for(const a of r.blockIds)this.blockRequests.set(a,(async()=>{try{const o=(await s)[i],h=a*this.blockSize,l=h-o.offset,c=Math.min(l+this.blockSize,o.data.byteLength),u=o.data.slice(l,c),d=new hh(h,u.byteLength,u,a);this.blockCache.set(a,d),this.abortedBlockIds.delete(a)}catch(o){if(o.name==="AbortError")o.signal=t,this.blockCache.delete(a),this.abortedBlockIds.add(a);else throw o}finally{this.blockRequests.delete(a)}})())}this.blockIdsToFetch.clear()}}groupBlocks(t){const e=Array.from(t).sort((a,o)=>a-o);if(e.length===0)return[];let s=[],i=null;const r=[];for(const a of e)i===null||i+1===a?(s.push(a),i=a):(r.push(new Gi(s[0]*this.blockSize,s.length*this.blockSize,s)),s=[a],i=a);return r.push(new Gi(s[0]*this.blockSize,s.length*this.blockSize,s)),r}readSliceData(t,e){return t.map(s=>{let i=s.offset+s.length;this.fileSize!==null&&(i=Math.min(this.fileSize,i));const r=Math.floor(s.offset/this.blockSize),a=Math.floor(i/this.blockSize),o=new ArrayBuffer(s.length),h=new Uint8Array(o);for(let l=r;l<=a;++l){const c=e.get(l),u=c.offset-s.offset,d=c.top-i;let f=0,m=0,y;u<0?f=-u:u>0&&(m=u),d<0?y=c.length-f:y=i-c.offset-f;const p=new Uint8Array(c.data,f,y);h.set(p,m)}return o})}}class $s{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(t){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class Xs{constructor(t){this.url=t}async request({headers:t,signal:e}={}){throw new Error("request is not implemented")}}class ch extends $s{constructor(t){super(),this.response=t}get status(){return this.response.status}getHeader(t){return this.response.headers.get(t)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class uh extends Xs{constructor(t,e){super(t),this.credentials=e}async request({headers:t,signal:e}={}){const s=await fetch(this.url,{headers:t,credentials:this.credentials,signal:e});return new ch(s)}}class fh extends $s{constructor(t,e){super(),this.xhr=t,this.data=e}get status(){return this.xhr.status}getHeader(t){return this.xhr.getResponseHeader(t)}async getData(){return this.data}}class dh extends Xs{constructRequest(t,e){return new Promise((s,i)=>{const r=new XMLHttpRequest;r.open("GET",this.url),r.responseType="arraybuffer";for(const[a,o]of Object.entries(t))r.setRequestHeader(a,o);r.onload=()=>{const a=r.response;s(new fh(r,a))},r.onerror=i,r.onabort=()=>i(new Vt("Request aborted")),r.send(),e&&(e.aborted&&r.abort(),e.addEventListener("abort",()=>r.abort()))})}async request({headers:t,signal:e}={}){return await this.constructRequest(t,e)}}var ys={};class mh extends $s{constructor(t,e){super(),this.response=t,this.dataPromise=e}get status(){return this.response.statusCode}getHeader(t){return this.response.headers[t]}async getData(){return await this.dataPromise}}class yh extends Xs{constructor(t){super(t),this.parsedUrl=ys.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",ys)}constructRequest(t,e){return new Promise((s,i)=>{const r=this.httpApi.get({...this.parsedUrl,headers:t},a=>{const o=new Promise(h=>{const l=[];a.on("data",c=>{l.push(c)}),a.on("end",()=>{const c=Buffer.concat(l).buffer;h(c)}),a.on("error",i)});s(new mh(a,o))});r.on("error",i),e&&(e.aborted&&r.destroy(new Vt("Request aborted")),e.addEventListener("abort",()=>r.destroy(new Vt("Request aborted"))))})}async request({headers:t,signal:e}={}){return await this.constructRequest(t,e)}}class Hs extends Vn{constructor(t,e,s,i){super(),this.client=t,this.headers=e,this.maxRanges=s,this.allowFullFile=i,this._fileSize=null}async fetch(t,e){return this.maxRanges>=t.length?this.fetchSlices(t,e):(this.maxRanges>0&&t.length>1,Promise.all(t.map(s=>this.fetchSlice(s,e))))}async fetchSlices(t,e){const s=await this.client.request({headers:{...this.headers,Range:`bytes=${t.map(({offset:i,length:r})=>`${i}-${i+r}`).join(",")}`},signal:e});if(s.ok)if(s.status===206){const{type:i,params:r}=eh(s.getHeader("content-type"));if(i==="multipart/byteranges"){const u=sh(await s.getData(),r.boundary);return this._fileSize=u[0].fileSize||null,u}const a=await s.getData(),{start:o,end:h,total:l}=Es(s.getHeader("content-range"));this._fileSize=l||null;const c=[{data:a,offset:o,length:h-o}];if(t.length>1){const u=await Promise.all(t.slice(1).map(d=>this.fetchSlice(d,e)));return c.concat(u)}return c}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const i=await s.getData();return this._fileSize=i.byteLength,[{data:i,offset:0,length:i.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(t,e){const{offset:s,length:i}=t,r=await this.client.request({headers:{...this.headers,Range:`bytes=${s}-${s+i}`},signal:e});if(r.ok)if(r.status===206){const a=await r.getData(),{total:o}=Es(r.getHeader("content-range"));return this._fileSize=o||null,{data:a,offset:s,length:i}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const a=await r.getData();return this._fileSize=a.byteLength,{data:a,offset:0,length:a.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function Zs(n,{blockSize:t,cacheSize:e}){return t===null?n:new lh(n,{blockSize:t,cacheSize:e})}function ph(n,{headers:t={},credentials:e,maxRanges:s=0,allowFullFile:i=!1,...r}={}){const a=new uh(n,e),o=new Hs(a,t,s,i);return Zs(o,r)}function gh(n,{headers:t={},maxRanges:e=0,allowFullFile:s=!1,...i}={}){const r=new dh(n),a=new Hs(r,t,e,s);return Zs(a,i)}function xh(n,{headers:t={},maxRanges:e=0,allowFullFile:s=!1,...i}={}){const r=new yh(n),a=new Hs(r,t,e,s);return Zs(a,i)}function _h(n,{forceXHR:t=!1,...e}={}){return typeof fetch=="function"&&!t?ph(n,e):typeof XMLHttpRequest<"u"?gh(n,e):xh(n,e)}function Is(n){switch(n){case z.BYTE:case z.ASCII:case z.SBYTE:case z.UNDEFINED:return 1;case z.SHORT:case z.SSHORT:return 2;case z.LONG:case z.SLONG:case z.FLOAT:case z.IFD:return 4;case z.RATIONAL:case z.SRATIONAL:case z.DOUBLE:case z.LONG8:case z.SLONG8:case z.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${n}`)}}function wh(n){const t=n.GeoKeyDirectory;if(!t)return null;const e={};for(let s=4;s<=t[3]*4;s+=4){const i=Ro[t[s]],r=t[s+1]?te[t[s+1]]:null,a=t[s+2],o=t[s+3];let h=null;if(!r)h=o;else{if(h=n[r],typeof h>"u"||h===null)throw new Error(`Could not get value of geoKey '${i}'.`);typeof h=="string"?h=h.substring(o,o+a-1):h.subarray&&(h=h.subarray(o,o+a),a===1&&(h=h[0]))}e[i]=h}return e}function Ot(n,t,e,s){let i=null,r=null;const a=Is(t);switch(t){case z.BYTE:case z.ASCII:case z.UNDEFINED:i=new Uint8Array(e),r=n.readUint8;break;case z.SBYTE:i=new Int8Array(e),r=n.readInt8;break;case z.SHORT:i=new Uint16Array(e),r=n.readUint16;break;case z.SSHORT:i=new Int16Array(e),r=n.readInt16;break;case z.LONG:case z.IFD:i=new Uint32Array(e),r=n.readUint32;break;case z.SLONG:i=new Int32Array(e),r=n.readInt32;break;case z.LONG8:case z.IFD8:i=new Array(e),r=n.readUint64;break;case z.SLONG8:i=new Array(e),r=n.readInt64;break;case z.RATIONAL:i=new Uint32Array(e*2),r=n.readUint32;break;case z.SRATIONAL:i=new Int32Array(e*2),r=n.readInt32;break;case z.FLOAT:i=new Float32Array(e),r=n.readFloat32;break;case z.DOUBLE:i=new Float64Array(e),r=n.readFloat64;break;default:throw new RangeError(`Invalid field type: ${t}`)}if(t===z.RATIONAL||t===z.SRATIONAL)for(let o=0;o<e;o+=2)i[o]=r.call(n,s+o*a),i[o+1]=r.call(n,s+(o*a+4));else for(let o=0;o<e;++o)i[o]=r.call(n,s+o*a);return t===z.ASCII?new TextDecoder("utf-8").decode(i):i}class bh{constructor(t,e,s){this.fileDirectory=t,this.geoKeyDirectory=e,this.nextIFDByteOffset=s}}class Oe extends Error{constructor(t){super(`No image at index ${t}`),this.index=t}}class Sh{async readRasters(t={}){const{window:e,width:s,height:i}=t;let{resX:r,resY:a,bbox:o}=t;const h=await this.getImage();let l=h;const c=await this.getImageCount(),u=h.getBoundingBox();if(e&&o)throw new Error('Both "bbox" and "window" passed.');if(s||i){if(e){const[m,y]=h.getOrigin(),[p,g]=h.getResolution();o=[m+e[0]*p,y+e[1]*g,m+e[2]*p,y+e[3]*g]}const f=o||u;if(s){if(r)throw new Error("Both width and resX passed");r=(f[2]-f[0])/s}if(i){if(a)throw new Error("Both width and resY passed");a=(f[3]-f[1])/i}}if(r||a){const f=[];for(let m=0;m<c;++m){const y=await this.getImage(m),{SubfileType:p,NewSubfileType:g}=y.fileDirectory;(m===0||p===2||g&1)&&f.push(y)}f.sort((m,y)=>m.getWidth()-y.getWidth());for(let m=0;m<f.length;++m){const y=f[m],p=(u[2]-u[0])/y.getWidth(),g=(u[3]-u[1])/y.getHeight();if(l=y,r&&r>p||a&&a>g)break}}let d=e;if(o){const[f,m]=h.getOrigin(),[y,p]=l.getResolution(h);d=[Math.round((o[0]-f)/y),Math.round((o[1]-m)/p),Math.round((o[2]-f)/y),Math.round((o[3]-m)/p)],d=[Math.min(d[0],d[2]),Math.min(d[1],d[3]),Math.max(d[0],d[2]),Math.max(d[1],d[3])]}return l.readRasters({...t,window:d})}}class js extends Sh{constructor(t,e,s,i,r={}){super(),this.source=t,this.littleEndian=e,this.bigTiff=s,this.firstIFDOffset=i,this.cache=r.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(t,e){const s=this.bigTiff?4048:1024;return new Jo((await this.source.fetch([{offset:t,length:typeof e<"u"?e:s}]))[0],t,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(t){const e=this.bigTiff?20:12,s=this.bigTiff?8:2;let i=await this.getSlice(t);const r=this.bigTiff?i.readUint64(t):i.readUint16(t),a=r*e+(this.bigTiff?16:6);i.covers(t,a)||(i=await this.getSlice(t,a));const o={};let h=t+(this.bigTiff?8:2);for(let u=0;u<r;h+=e,++u){const d=i.readUint16(h),f=i.readUint16(h+2),m=this.bigTiff?i.readUint64(h+4):i.readUint32(h+4);let y,p;const g=Is(f),x=h+(this.bigTiff?12:8);if(g*m<=(this.bigTiff?8:4))y=Ot(i,f,m,x);else{const w=i.readOffset(x),S=Is(f)*m;if(i.covers(w,S))y=Ot(i,f,m,w);else{const _=await this.getSlice(w,S);y=Ot(_,f,m,w)}}m===1&&Co.indexOf(d)===-1&&!(f===z.RATIONAL||f===z.SRATIONAL)?p=y[0]:p=y,o[te[d]]=p}const l=wh(o),c=i.readOffset(t+s+e*r);return new bh(o,l,c)}async requestIFD(t){if(this.ifdRequests[t])return this.ifdRequests[t];if(t===0)return this.ifdRequests[t]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[t];if(!this.ifdRequests[t-1])try{this.ifdRequests[t-1]=this.requestIFD(t-1)}catch(e){throw e instanceof Oe?new Oe(t):e}return this.ifdRequests[t]=(async()=>{const e=await this.ifdRequests[t-1];if(e.nextIFDByteOffset===0)throw new Oe(t);return this.parseFileDirectoryAt(e.nextIFDByteOffset)})(),this.ifdRequests[t]}async getImage(t=0){const e=await this.requestIFD(t);return new Wo(e.fileDirectory,e.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let t=0,e=!0;for(;e;)try{await this.requestIFD(t),++t}catch(s){if(s instanceof Oe)e=!1;else throw s}return t}async getGhostValues(){const t=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const e="GDAL_STRUCTURAL_METADATA_SIZE=",s=e.length+100;let i=await this.getSlice(t,s);if(e===Ot(i,z.ASCII,e.length,t)){const a=Ot(i,z.ASCII,s,t).split(`
`)[0],o=Number(a.split("=")[1].split(" ")[0])+a.length;o>s&&(i=await this.getSlice(t,o));const h=Ot(i,z.ASCII,o,t);this.ghostValues={},h.split(`
`).filter(l=>l.length>0).map(l=>l.split("=")).forEach(([l,c])=>{this.ghostValues[l]=c})}return this.ghostValues}static async fromSource(t,e,s){const i=(await t.fetch([{offset:0,length:1024}],s))[0],r=new Qo(i),a=r.getUint16(0,0);let o;if(a===18761)o=!0;else if(a===19789)o=!1;else throw new TypeError("Invalid byte order value.");const h=r.getUint16(2,o);let l;if(h===42)l=!1;else if(h===43){if(l=!0,r.getUint16(4,o)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const c=l?r.getUint64(8,o):r.getUint32(4,o);return new js(t,o,l,c,e)}close(){return typeof this.source.close=="function"?this.source.close():!1}}async function Ah(n,t={},e){return js.fromSource(_h(n,t),e)}function Mh(n){const t=/[\u0000]$/g;return n.trim().replace(t,"").trim()}function zh(n){const t=new DOMParser;try{return t.parseFromString(n,"text/xml").getElementsByTagName("OME")[0]}catch(e){throw new N("Could not find OME metadata in TIFF file",{type:O.INVALID_METADATA,cause:e})}}class Eh{constructor(){this.sizex=0,this.sizey=0,this.sizez=1,this.sizec=1,this.sizet=1,this.unit="",this.pixeltype="",this.dimensionorder="",this.pixelsizex=1,this.pixelsizey=1,this.pixelsizez=1,this.channelnames=[]}}function Yi(n){const e={uint8:"uint8",uint16:"uint16",uint32:"uint32",int8:"int8",int16:"int16",int32:"int32",float:"float32"}[n];return e===void 0?(console.warn(`Unsupported OME pixel type ${n}; defaulting to uint8`),"uint8"):e}function $i(n,t){const e=n.getAttribute(t);if(e===null)throw new N(`Missing attribute ${t} in OME-TIFF metadata`,{type:O.INVALID_METADATA});return e}function Ih(n){const t=new Eh,e=n.getElementsByTagName("Pixels")[0];t.sizex=Number($i(e,"SizeX")),t.sizey=Number($i(e,"SizeY")),t.sizez=Number(e.getAttribute("SizeZ")),t.sizec=Number(e.getAttribute("SizeC")),t.sizet=Number(e.getAttribute("SizeT")),t.unit=e.getAttribute("PhysicalSizeXUnit")||"",t.pixeltype=e.getAttribute("Type")||"",t.dimensionorder=e.getAttribute("DimensionOrder")||"XYZCT",t.pixelsizex=Number(e.getAttribute("PhysicalSizeX")),t.pixelsizey=Number(e.getAttribute("PhysicalSizeY")),t.pixelsizez=Number(e.getAttribute("PhysicalSizeZ"));const s=e.getElementsByTagName("Channel");for(let i=0;i<s.length;++i){const r=s[i].getAttribute("Name"),a=s[i].getAttribute("ID");t.channelnames.push(r||a||"Channel"+i)}return t}const Th=n=>n==="uint8"?1:n==="uint16"?2:4;class Ch extends je{constructor(t){super(),this.url=t}async loadOmeDims(){if(!this.dims){const e=await(await Ah(this.url,{allowFullFile:!0}).catch(Ut(`Could not open TIFF file at ${this.url}`,O.NOT_FOUND))).getImage().catch(Ut("Failed to open TIFF image",O.NOT_FOUND)),s=Mh(e.getFileDirectory().ImageDescription),r=zh(s).getElementsByTagName("Image")[0];this.dims=Ih(r)}return this.dims}async loadDims(t){const e=await this.loadOmeDims(),s=se(e.sizez,e.sizex,e.sizey),i=ee,r=Math.floor(i/s.x),a=Math.floor(i/s.y);return[{shape:[e.sizet,e.sizec,e.sizez,a,r],spacing:[1,1,e.pixelsizez,e.pixelsizey*e.sizey/a,e.pixelsizex*e.sizex/r],spaceUnit:e.unit?e.unit:"micron",dataType:Yi(e.pixeltype),timeUnit:"s"}]}async createImageInfo(t){const e=await this.loadOmeDims(),s=se(e.sizez,e.sizex,e.sizey),i=ee,r=Math.floor(i/s.x),a=Math.floor(i/s.y);return{imageInfo:{name:"TEST",atlasTileDims:[s.x,s.y],subregionSize:[r,a,e.sizez],subregionOffset:[0,0,0],combinedNumChannels:e.sizec,channelNames:e.channelnames,multiscaleLevel:0,multiscaleLevelDims:[{shape:[e.sizet,e.sizec,e.sizez,a,r],spacing:[1,1,e.pixelsizez,e.pixelsizey*e.sizey/a,e.pixelsizex*e.sizex/r],spaceUnit:e.unit||"",timeUnit:"",dataType:Yi(e.pixeltype)}],transform:{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}},loadSpec:new _n}}async loadRawChannelData(t,e,s,i){const r=await this.loadOmeDims(),o=new Ze(t).volumeSize,h=[];for(let l=0;l<t.combinedNumChannels;++l){const c=new Promise((u,d)=>{const f={channel:l,tilesizex:o.x,tilesizey:o.y,sizec:t.combinedNumChannels,sizez:o.z,dimensionOrder:r.dimensionorder,bytesPerSample:Th(r.pixeltype),url:this.url},m=new Worker(new URL("/assets/FetchTiffWorker-B3Idp76k.js",import.meta.url),{type:"module"});m.onmessage=y=>{if(y.data.isError){d(sr(y.data.error));return}const{data:p,dtype:g,channel:x,range:w}=y.data;i([x],[g],[p],[w]),m.terminate(),u()},m.postMessage(f)});h.push(c)}await Promise.all(h)}}var Gn=(n=>(n.ZARR="zarr",n.JSON="json",n.TIFF="tiff",n.DATA="data",n))(Gn||{});function Yn(n){return n.endsWith(".json")?"json":n.endsWith(".tif")||n.endsWith(".tiff")?"tiff":"zarr"}async function Dh(n,t){const e=Array.isArray(n)?n[0]:n;switch((t==null?void 0:t.fileType)||Yn(e)){case"zarr":return await Us.createLoader(n,t==null?void 0:t.scene,t==null?void 0:t.cache,t==null?void 0:t.queue,t==null?void 0:t.fetchOptions);case"json":return new Fs(n,t==null?void 0:t.cache);case"tiff":return new Ch(e);case"data":if(!(t!=null&&t.rawArrayOptions))throw new Error("Must provide RawArrayOptions for RawArrayLoader");return new ja(t==null?void 0:t.rawArrayOptions.data,t==null?void 0:t.rawArrayOptions.metadata)}}var J=(n=>(n[n.INIT=0]="INIT",n[n.CREATE_LOADER=1]="CREATE_LOADER",n[n.CLOSE_LOADER=2]="CLOSE_LOADER",n[n.CREATE_VOLUME=3]="CREATE_VOLUME",n[n.LOAD_DIMS=4]="LOAD_DIMS",n[n.LOAD_VOLUME_DATA=5]="LOAD_VOLUME_DATA",n[n.SET_PREFETCH_PRIORITY_DIRECTIONS=6]="SET_PREFETCH_PRIORITY_DIRECTIONS",n[n.SYNCHRONIZE_MULTICHANNEL_LOADING=7]="SYNCHRONIZE_MULTICHANNEL_LOADING",n[n.UPDATE_FETCH_OPTIONS=8]="UPDATE_FETCH_OPTIONS",n))(J||{}),ne=(n=>(n[n.SUCCESS=0]="SUCCESS",n[n.ERROR=1]="ERROR",n[n.EVENT=2]="EVENT",n))(ne||{}),Ts=(n=>(n[n.METADATA_UPDATE=0]="METADATA_UPDATE",n[n.CHANNEL_LOAD=1]="CHANNEL_LOAD",n))(Ts||{});function ps(n){return{...n,subregion:new et(new b().copy(n.subregion.min),new b().copy(n.subregion.max))}}let Xi,Hi,Zi,ji=0;const Cs=new Map,kt=n=>{const t=Cs.get(n);if(t===void 0)throw new N(`Loader with ID ${n} does not exist`);return t};let Ki=!1;const Rh={[J.INIT]:({maxCacheSize:n,maxActiveRequests:t,maxLowPriorityRequests:e})=>(Ki||(Xi=new rr(n),Hi=new mn(t,e),Zi=new yn(Hi),Ki=!0),Promise.resolve()),[J.CREATE_LOADER]:async({path:n,options:t})=>{const e=await Dh(n,{...t,cache:Xi,queue:Zi});if(e===void 0)return;const s=Array.isArray(n)?n[0]:n,r=((t==null?void 0:t.fileType)||Yn(s))===Gn.JSON,a=ji;return ji+=1,Cs.set(a,{loader:e,copyOnLoad:r}),a},[J.CLOSE_LOADER]:(n,t)=>(Cs.delete(t),Promise.resolve()),[J.CREATE_VOLUME]:async(n,t)=>{const{loader:e}=kt(t);return await e.createImageInfo(ps(n))},[J.LOAD_DIMS]:async(n,t)=>{const{loader:e}=kt(t);return await e.loadDims(ps(n))},[J.LOAD_VOLUME_DATA]:({imageInfo:n,loadSpec:t,loadId:e},s)=>{const{loader:i,copyOnLoad:r}=kt(s);return i.loadRawChannelData(n,ps(t),(a,o)=>{const h={responseResult:ne.EVENT,eventType:Ts.METADATA_UPDATE,loaderId:s,loadId:e,imageInfo:a,loadSpec:o};self.postMessage(h)},(a,o,h,l,c)=>{const u={responseResult:ne.EVENT,eventType:Ts.CHANNEL_LOAD,loaderId:s,loadId:e,channelIndex:a,dtype:o,data:h,ranges:l,atlasDims:c};self.postMessage(u,r?[]:h.map(d=>d.buffer))})},[J.SET_PREFETCH_PRIORITY_DIRECTIONS]:(n,t)=>{const{loader:e}=kt(t);return e==null||e.setPrefetchPriority(n),Promise.resolve()},[J.SYNCHRONIZE_MULTICHANNEL_LOADING]:(n,t)=>{const{loader:e}=kt(t);return e==null||e.syncMultichannelLoading(n),Promise.resolve()},[J.UPDATE_FETCH_OPTIONS]:(n,t)=>{const{loader:e}=kt(t);return e==null||e.updateFetchOptions(n),Promise.resolve()}};self.onmessage=async({data:n})=>{let t;try{const e=await Rh[n.type](n.payload,n.loaderId);t={...n,responseResult:ne.SUCCESS,payload:e}}catch(e){t={...n,responseResult:ne.ERROR,payload:er(e)}}self.postMessage(t)};export{kh as L,Ph as a,Fn as g};
